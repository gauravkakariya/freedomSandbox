/*
  Revision History:
  
  
    Version     Version Author     Date           Comments
    1.0         Prajakta Sanap     27/09/2012     New Action Plan Creation : ActionPlanServices is class to prepare the data as per the business logic. 
                           This is acting as service class for the ActionPlanController
 
    1.0         Aditi Satpute     08/10/2012      Created fetchGoalDetails function & RemoveRecordSIPFunds for New Action Plan
    2.0      Prajakta Sanap    01/04/2013      Added Gold Growth Rate for the new record type Gold in Investment Asset  
*/


public class ActionPlanServices
{
    DatabaseSOQL dbSOQLObj {get; set;}
    DatabaseDML dbDMLObj {get; set;}
    String currentLump = Label.CurrentLumpSumRecordType;
    String currentSIP = Label.CurrentSIPRecordType;
    String suggestedLump = Label.SuggestedLumpSumRecordType;
    String suggestedSIP = Label.SuggestedSIPRecordType;
    public double SIPtotal{get;set;}
    public double Lumpsumtotal{get;set;}
    public double SIPSummaryTotal{get;set;} 
    public Boolean isNewSIP{get;set;}
    public String entityName{get;set;}
    
    
    private void setInfoMessage(String str) 
    {
        ApexPages.addMessage(new ApexPages.Message(ApexPages.severity.INFO,str));                                                                                                                               
    }
    
    Public ActionPlanServices()
    {	
        dbSOQLObj = new DatabaseSOQL();
        dbDMLObj = new DatabaseDML();
        isNewSIP = false;
    }
    
    //private Map<Id,Investment_Asset__c> mapIdToInvestmentAssetGold = new Map<Id,Investment_Asset__c>();
    //private Map<Id,Investment_Asset__c> mapIdToInvestmentAsset = new Map<Id,Investment_Asset__c>();
    //private Map<Id,Insurance__c> MapIdToLifeInsurance = new Map<Id,Insurance__c>();
    //private Map<Id,Remarks__c> entityRemarkMap{get;set;}
    //private  Account objAccount {get;set;}
    private Integer newCount = 0; 
    private Integer newInsuranceCount = 0; 
    
    
    public List<ApprovedPlanBean.GeneralInsurance> getGICombinedListforPDF(List<ApprovedPlanBean.GeneralInsurance> lstGeneralInsuranceCombinedInnerclass) 
    {
    	Map<String,Map<String,List<ApprovedPlanBean.GeneralInsurance>>> mapInsuredToMapTypeWithGIRecords = new Map<String,Map<String,List<ApprovedPlanBean.GeneralInsurance>>>();
        for(ApprovedPlanBean.GeneralInsurance objCombinedGI : lstGeneralInsuranceCombinedInnerclass)
    	{ 
     	 	Map <String,List<ApprovedPlanBean.GeneralInsurance>> MapTypeTolstGI = new Map <String,List<ApprovedPlanBean.GeneralInsurance>>();
     	 	List<ApprovedPlanBean.GeneralInsurance> lstGIalreadyExists = new List<ApprovedPlanBean.GeneralInsurance>();
	   		if(mapInsuredToMapTypeWithGIRecords.containsKey(objCombinedGI.insured))
	   		{
	   			MapTypeTolstGI = mapInsuredToMapTypeWithGIRecords.get(objCombinedGI.insured);
	   			if(MapTypeTolstGI.containskey(objCombinedGI.PolicyType))
	   			{
	   				lstGIalreadyExists = MapTypeTolstGI.get(objCombinedGI.PolicyType);
	   				lstGIalreadyExists.add(objCombinedGI);
		   			MapTypeTolstGI.put(objCombinedGI.policyType,lstGIalreadyExists);
	   			}
	   			else
	   			{
	   				lstGIalreadyExists.add(objCombinedGI);
	   				MapTypeTolstGI.put(objCombinedGI.policyType,lstGIalreadyExists);
	   			}
	   		}
	   		else
	   		{
	   			lstGIalreadyExists = new List<ApprovedPlanBean.GeneralInsurance>();
	   			lstGIalreadyExists.add(objCombinedGI);
	   			MapTypeTolstGI.put(objCombinedGI.policyType,lstGIalreadyExists);
	   		}
	   		mapInsuredToMapTypeWithGIRecords.put(objCombinedGI.insured,MapTypeTolstGI);
    	}
    	
    	/*for(ApprovedPlanBean.GeneralInsurance objCombinedGI : beanObj.lstGeneralInsuranceCombinedInnerclass)
    	{ 
    		
     	 	List<ApprovedPlanBean.GeneralInsurance> lstGIalreadyExists = new List<ApprovedPlanBean.GeneralInsurance>();
	   		if(mapInsuredToGIRecords.containsKey(objCombinedGI.policyType))
	   		{
	   			lstGIalreadyExists = mapInsuredToGIRecords.get(objCombinedGI.policyType);
	   			lstGIalreadyExists.add(objCombinedGI);
	   		}
	   		else
	   			lstGIalreadyExists.add(objCombinedGI);
	   		mapInsuredToGIRecords.put(objCombinedGI.policyType,lstGIalreadyExists);
    	}*/
    	
    	lstGeneralInsuranceCombinedInnerclass = new List<ApprovedPlanBean.GeneralInsurance>();
    	for(String strInsured : mapInsuredToMapTypeWithGIRecords.keySet())
    	{
    		if(mapInsuredToMapTypeWithGIRecords.containsKey(strInsured))
    		{
    			Map <String,List<ApprovedPlanBean.GeneralInsurance>> MapTypeTolstGIRecs = mapInsuredToMapTypeWithGIRecords.get(strInsured);
    			for(String strPolicyType : MapTypeTolstGIRecs.keySet())
    			{
    				if(MapTypeTolstGIRecs.containsKey(strPolicyType))
    				{
	    				List<ApprovedPlanBean.GeneralInsurance> lstGI = MapTypeTolstGIRecs.get(strPolicyType);
	    				for(ApprovedPlanBean.GeneralInsurance objCombinedGI : lstGI)
	    				{
	    					lstGeneralInsuranceCombinedInnerclass.add(objCombinedGI);
	    				}
    				}
    			}
    		}
    	}
    	return lstGeneralInsuranceCombinedInnerclass;
    }
    
    
    public List<ApprovedPlanBean.LifeInsurance> getLICombinedListforPDF(List<ApprovedPlanBean.LifeInsurance> lstLifeInsuranceCombinedInnerclass) 
    {
    	Map<String,Map<String,List<ApprovedPlanBean.LifeInsurance>>> mapInsuredToMapTypeWithLIRecords = new Map<String,Map<String,List<ApprovedPlanBean.LifeInsurance>>>();
        for(ApprovedPlanBean.LifeInsurance objCombinedLI : lstLifeInsuranceCombinedInnerclass)
    	{ 
     	 	Map <String,List<ApprovedPlanBean.LifeInsurance>> MapTypeTolstLI = new Map <String,List<ApprovedPlanBean.LifeInsurance>>();
     	 	List<ApprovedPlanBean.LifeInsurance> lstLIalreadyExists = new List<ApprovedPlanBean.LifeInsurance>();
	   		if(mapInsuredToMapTypeWithLIRecords.containsKey(objCombinedLI.insured))
	   		{
	   			MapTypeTolstLI = mapInsuredToMapTypeWithLIRecords.get(objCombinedLI.insured);
	   			if(MapTypeTolstLI.containskey(objCombinedLI.PolicyType))
	   			{
	   				lstLIalreadyExists = MapTypeTolstLI.get(objCombinedLI.PolicyType);
	   				lstLIalreadyExists.add(objCombinedLI);
		   			MapTypeTolstLI.put(objCombinedLI.policyType,lstLIalreadyExists);
	   			}
	   			else
	   			{
	   				lstLIalreadyExists.add(objCombinedLI);
	   				MapTypeTolstLI.put(objCombinedLI.policyType,lstLIalreadyExists);
	   			}
	   		}
	   		else
	   		{
	   			lstLIalreadyExists = new List<ApprovedPlanBean.LifeInsurance>();
	   			lstLIalreadyExists.add(objCombinedLI);
	   			MapTypeTolstLI.put(objCombinedLI.policyType,lstLIalreadyExists);
	   		}
	   		mapInsuredToMapTypeWithLIRecords.put(objCombinedLI.insured,MapTypeTolstLI);
    	}
    	
    	lstLifeInsuranceCombinedInnerclass = new List<ApprovedPlanBean.LifeInsurance>();
    	for(String strInsured : mapInsuredToMapTypeWithLIRecords.keySet())
    	{
    		if(mapInsuredToMapTypeWithLIRecords.containsKey(strInsured))
    		{
    			Map <String,List<ApprovedPlanBean.LifeInsurance>> MapTypeTolstLIRecs = mapInsuredToMapTypeWithLIRecords.get(strInsured);
    			for(String strPolicyType : MapTypeTolstLIRecs.keySet())
    			{
    				if(MapTypeTolstLIRecs.containsKey(strPolicyType))
    				{
	    				List<ApprovedPlanBean.LifeInsurance> lstLI = MapTypeTolstLIRecs.get(strPolicyType);
	    				for(ApprovedPlanBean.LifeInsurance objCombinedLI : lstLI)
	    				{
	    					lstLifeInsuranceCombinedInnerclass.add(objCombinedLI);
	    				}
    				}
    			}
    		}
    	}
    	return lstLifeInsuranceCombinedInnerclass;
    }
    //Created By : Aditi for new Action Plan
    public ApprovedPlanBean fetchGoalDetails(ApprovedPlanBean approvedPlanBean, 
    										map<String, set<String>> mapMutualFundTosetProducts, 
    										map<String, set<String>> mapLifeInsTosetProducts,Account objAccount) 
   	{   
	    List<Goal__c> goalList = dbSOQLObj.getAllGoals(approvedPlanBean.entityId);
	    //Added on 24/12/2012 : for Retrieving Family member
	    Set<Id> familyIdSet = new Set<Id>(); 
	    List<Account> lstAcc = dbSOQLObj.getFamilyMembers(approvedPlanBean.entityId);
    	Map<Id,List<Execution_Tracker__c>> mapIdTolstExecutionTracker = new Map<Id,List<Execution_Tracker__c>>();
    	Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan = new Map<String,List<Approve_Action_Plan__c>>();
    	
	    for(Account objAcc : lstAcc)
	    {
	      familyIdSet.add(objAcc.Id);
	    }
	    
	    List<Execution_Tracker__c> lstExecutionTracker = [select Id,isAssignedToOps__c,Suggested_Amount__c ,AssignToOps__c,Approve_Action_Plan__c,Type__c, Application_Status__c,isFormProvidedToMET__c,
															Agreed_Amount_Base_Amount__c ,Balance_Remaining__c ,Total_Remaining_Balance__c,Agreed_Amount__c,Executed_Amount__c   
															from Execution_Tracker__c where Entity_Name__c IN: familyIdSet order by CreatedDate];
		 
		for(Execution_Tracker__c objET : lstExecutionTracker)
		{
			if(!mapIdTolstExecutionTracker.containsKey(objET.Approve_Action_Plan__c))
			{
				List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>();
        		lstET.add(objET);
				mapIdTolstExecutionTracker.put(objET.Approve_Action_Plan__c,lstET);
			}
			else
			{
				mapIdTolstExecutionTracker.get(objET.Approve_Action_Plan__c).add(objET);
			}
		}
		
		List<Approve_Action_Plan__c> lstApproveActionPlan = [Select  Transaction_Type__c, Action_Amount__c, Insurance__c, Remarks__c, Scheme_Name__c, Goal__c , Asset_Class__c, 
	                                     isInsuranceExecutionTracker__c,Amount__c, Investment_Asset__c, isSIPexecutionTracker__c, isETcreated__c,Policy_Name__c ,
	                                     Fund__c, Lumpsum_Action__c,Amount_Per_Installment__c, SIP_Action__c, Product_Name__c, 
	                                   	 Account__c, Option__c,  isExecutionTracker__c ,Installments__c,  Account__r.FirstName, CreatedDate,Suggested_Cover__c, 
	                                   	 Account__r.LastName,Category__c,Insured__c, Policy_Type__c,Sum_Assured_Rs__c,Premium_Amount_Rs__c,Item_Type__c ,
	                                   	 Tenure_of_Insurance__c,InsuranceRemark__c,isNewLI__c,isAddOnExecutionTracker__c,Loan_Type__c,Company_Name__c,Company_Name__r.Name,
	                                   	 Goal_Type__c,Period_in_Months__c,Bond_Type__c,Investment_Asset__r.RecordType.Name,isNewGoldSilver__c, isGSsip_ExecutionTracker__c, isGSsipETCreated__c, 
										 isGS_ExecutionTracker__c, isGSETcreated__c, Id,GS_SIPRemark__c, Multiple_Products__c ,Goal__r.Goal_Type__c,
								       	 GS_LumpsumRemark__c, Asset_Type__c, Asset_Name__c,SIP_Action_Amount__c,Goal__r.Description__c,isLumpsumExecTracker__c ,
								       	 isMFsipETCreated__c,MF_SIPRemark__c,MF_LumpsumRemark__c,isNewMutualFund__c,Lumpsum_Equity__c ,Lumpsum_Debt__c,Lumpsum_Gold__c         
	                                   From Approve_Action_Plan__c
	                                   where  Account__c IN: familyIdSet and  (Item_Type__c = : 'General Insurance' 
	                                   or Item_Type__c = 'Life Insurance' or Item_Type__c = : Label.Surrender_Insurance or Item_Type__c =: 'Loan'
	                                   or Item_Type__c =:'Fixed Deposit' or Item_Type__c =:'Bond' or Item_Type__c =:'SIP' or Item_Type__c =:'Lumpsum' 
	                                   or Investment_Asset__c != null) 
	                                   and AP_Status__c = 'Opened' order by CreatedDate];
	                                   
		for(Approve_Action_Plan__c objAP : lstApproveActionPlan)
		{
			if(objAP.Investment_Asset__c == null)
			{
				if(!mapIdTolstActionPlan.containsKey(objAP.Item_Type__c))
				{
					List<Approve_Action_Plan__c> lstAP = new List<Approve_Action_Plan__c>();
	        		lstAP.add(objAP);
					mapIdTolstActionPlan.put(objAP.Item_Type__c,lstAP);
				}
				else
				{
					mapIdTolstActionPlan.get(objAP.Item_Type__c).add(objAP);
				}
			}
			else
			{
				if(objAP.Investment_Asset__r.RecordType.Name == 'Gold and Silver')
				{
					if(!mapIdTolstActionPlan.containsKey('Gold and Silver'))
					{
						List<Approve_Action_Plan__c> lstAP = new List<Approve_Action_Plan__c>();
		        		lstAP.add(objAP);
						mapIdTolstActionPlan.put('Gold and Silver',lstAP);
					}
					else
					{
						mapIdTolstActionPlan.get('Gold and Silver').add(objAP);
					}
				}
				else if (objAP.Investment_Asset__r.RecordType.Name == 'Mutual Fund')
				{
					if(!mapIdTolstActionPlan.containsKey('Mutual Fund'))
					{
						List<Approve_Action_Plan__c> lstAP = new List<Approve_Action_Plan__c>();
		        		lstAP.add(objAP);
						mapIdTolstActionPlan.put('Mutual Fund',lstAP);
					}
					else
					{
						mapIdTolstActionPlan.get('Mutual Fund').add(objAP);
					}
				}
			}
		}
		
		/*List<String> lifeInsuranceList = new List<String>();
		List<String> generalInsuranceList = new List<String>();
		
		if(mapLifeInsTolstProducts.containsKey('Life Insurance'))
		{
			lifeInsuranceList = mapLifeInsTolstProducts.get('Life Insurance');
		}
		if(mapLifeInsTolstProducts.containsKey('General Insurance'))
		{
			generalInsuranceList = mapLifeInsTolstProducts.get('General Insurance');
		}
		//error.debugLog('---------lifeInsuranceList-------------'+lifeInsuranceList);
		//error.debugLog('---------generalInsuranceList-------------'+generalInsuranceList);*/
		
	    getCurrentGoldSilver(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);
        getCurrentMutualFunds(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);
        
        //Access goal values;
        getGoalAssetAllocation(approvedPlanBean, goalList,familyIdSet,mapIdTolstExecutionTracker,mapMutualFundTosetProducts,mapIdTolstActionPlan,objAccount);
        getLifeInsurances(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);//,lifeInsuranceList);
        getGeneralInsurances(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);//, generalInsuranceList);
        getRecommendedInsurances(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);
        getLoanDetails(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);
        getFixedDepositDetails(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);
        getBondDetails(approvedPlanBean,familyIdSet,mapIdTolstExecutionTracker,mapIdTolstActionPlan);
        return approvedPlanBean;       
    }
     /**
    * @Description: Retrieve Loan Details of New Action Plan
    * param: ApprovedPlanBean,Family Members,ExecutionTracker Records 
    * return type: None 
    */ 
    public void getLoanDetails(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    									Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    {
    	ApprovedPlanBean.Loan objLoan = new ApprovedPlanBean.Loan();
    	List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();
    	List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>();
    	
    	String ETStatus = Label.ET_NotCreated;
    	String applicant = '';
    	String vendorName = '';
    	Long loanAmount = 0;
    	String loanAPid = '';
    	String loanType = '';
    	String AddOnExecutionTracker = '';
    	Boolean isAddOnExecTracker = false;
    	Integer index = 0;
    	if(mapIdTolstActionPlan.containsKey('Loan'))
	    {
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('Loan');
	    }     
    	lstApproveActionPlan.sort();
    	for(Approve_Action_Plan__c objApproveActionPlan : lstApproveActionPlan )
     	{
     		ETStatus = Label.ET_NotCreated;
     		applicant = objApproveActionPlan.Insured__c; 
	        isAddOnExecTracker = objApproveActionPlan.isAddOnExecutionTracker__c;
	        vendorName = objApproveActionPlan.Product_Name__c;
	        AddOnExecutionTracker = isAddOnExecTracker ? 'Yes' : 'No';
           	loanType = objApproveActionPlan.Loan_Type__c;
           	if(objApproveActionPlan.Amount__c != null) 
       			loanAmount = objApproveActionPlan.Amount__c.round();
       		loanAPid = objApproveActionPlan.Id;
       		if(mapIdToExecutionTracker.containsKey(objApproveActionPlan.Id))
		  	{
				lstET = mapIdToExecutionTracker.get(objApproveActionPlan.Id);
				for(Execution_Tracker__c objET : lstET)
				{
					if((objET.Executed_Amount__c == null || objET.Executed_Amount__c == 0 || objET.Executed_Amount__c > 0) && objET.Application_Status__c != 'Closed')
						ETStatus = Label.ET_NotExecuted;
					else if(objET.Executed_Amount__c != null && objET.Executed_Amount__c > 0 && objET.Application_Status__c == 'Closed')
						ETStatus = Label.ET_FullyExecuted;
					/*if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
						ETStatus = Label.ET_NotExecuted; 
				 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
				  	 	ETStatus = Label.ET_PartiallyExecuted;
			  		else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
				  	 	ETStatus = Label.ET_FullyExecuted;*/			
				}
		  	}	
       		objLoan = approvedPlanBean.populateLoan(applicant,loanType,vendorName,loanAmount,isAddOnExecTracker,AddOnExecutionTracker,loanAPid,ETStatus,index++);
     	}
    }
    
    /**
    * Added on : 11/12/13
    * @Description: Retrieve Fixed Deposit Details of New Action Plan
    * param: ApprovedPlanBean,Family Members,ExecutionTracker Records 
    * return type: None 
    */ 
    public void getFixedDepositDetails(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    									Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    {
    	ApprovedPlanBean.FixedDeposit objFixedDeposit = new ApprovedPlanBean.FixedDeposit();
    	List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();
    	List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>();
    	
    	String ETStatus = Label.ET_NotCreated;
    	Approve_Action_Plan__c actionPlanFDobj = new Approve_Action_Plan__c();
    	String AddOnExecutionTracker = '';
    	Integer index = 0;
    	String companyName = '';
    	
    	if(mapIdTolstActionPlan.containsKey('Fixed Deposit'))
	    {
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('Fixed Deposit');
	    }     
    	lstApproveActionPlan.sort();
    	for(Approve_Action_Plan__c objApproveActionPlan : lstApproveActionPlan )
     	{
     		actionPlanFDobj = new Approve_Action_Plan__c();
     		ETStatus = Label.ET_NotCreated;
     		actionPlanFDobj= objApproveActionPlan;
     		actionPlanFDobj.Insured__c =  objApproveActionPlan.Insured__c; 
     		actionPlanFDobj.isAddOnExecutionTracker__c = objApproveActionPlan.isAddOnExecutionTracker__c;
     		actionPlanFDobj.Product_Name__c = objApproveActionPlan.Product_Name__c;
     		actionPlanFDobj.Company_Name__c = objApproveActionPlan.Company_Name__c;
     		companyName = objApproveActionPlan.Company_Name__r.Name;
     		actionPlanFDobj.Goal_Type__c = objApproveActionPlan.Goal_Type__c;
     		AddOnExecutionTracker = actionPlanFDobj.isAddOnExecutionTracker__c ? 'Yes' : 'No';
           	if(objApproveActionPlan.Amount__c != null) 
       			actionPlanFDobj.Amount__c = objApproveActionPlan.Amount__c.round();
       		actionPlanFDobj.Period_in_Months__c = objApproveActionPlan.Period_in_Months__c;
       		
     		/*applicant = objApproveActionPlan.Insured__c; 
	        isAddOnExecTracker = objApproveActionPlan.isAddOnExecutionTracker__c;
	        schemeName = objApproveActionPlan.Product_Name__c;
	        companyName.Name = objApproveActionPlan.Company_Name__r.Name;
	        goalType = objApproveActionPlan.Goal_Type__c;
	        AddOnExecutionTracker = isAddOnExecTracker ? 'Yes' : 'No';
           	if(objApproveActionPlan.Amount__c != null) 
       			investmentAmount = objApproveActionPlan.Amount__c.round();
       		loanFDid = objApproveActionPlan.Id;
       		periodInMonths = objApproveActionPlan.Period_in_Months__c;*/
       		if(mapIdToExecutionTracker.containsKey(objApproveActionPlan.Id))
		  	{
				lstET = mapIdToExecutionTracker.get(objApproveActionPlan.Id);
				for(Execution_Tracker__c objET : lstET)
				{
					if((objET.Executed_Amount__c == null || objET.Executed_Amount__c == 0 || objET.Executed_Amount__c > 0) && objET.Application_Status__c != 'Closed')
						ETStatus = Label.ET_NotExecuted;
					else if(objET.Executed_Amount__c != null && objET.Executed_Amount__c > 0 && objET.Application_Status__c == 'Closed')
						ETStatus = Label.ET_FullyExecuted;
					/*if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
						ETStatus = Label.ET_NotExecuted; 
				 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
				  	 	ETStatus = Label.ET_PartiallyExecuted;
			  		else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
				  	 	ETStatus = Label.ET_FullyExecuted;*/			
				} 
		  	}	
       		objFixedDeposit = approvedPlanBean.populateFixedDeposit(actionPlanFDobj,companyName,AddOnExecutionTracker,ETStatus, index++);
     	}
    }
    /**
    * Added on : 16/12/13
    * @Description: Retrieve Fixed Deposit Details of New Action Plan
    * param: ApprovedPlanBean,Family Members,ExecutionTracker Records 
    * return type: None 
    */ 
    public void getBondDetails(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    									Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    {
    	ApprovedPlanBean.Bond objBond = new ApprovedPlanBean.Bond();
    	List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();
    	List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>();
    	
    	String ETStatus = Label.ET_NotCreated;
    	Approve_Action_Plan__c actionPlanBondObj = new Approve_Action_Plan__c();
    	String AddOnExecutionTracker = '';
    	Integer index = 0;
    	String companyName = '';
    	
    	if(mapIdTolstActionPlan.containsKey('Bond'))
	    {
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('Bond');
	    }     
    	lstApproveActionPlan.sort();
    	for(Approve_Action_Plan__c objApproveActionPlan : lstApproveActionPlan )
     	{
     		actionPlanBondObj = new Approve_Action_Plan__c();
     		ETStatus = Label.ET_NotCreated;
     		actionPlanBondObj= objApproveActionPlan;
     		actionPlanBondObj.Insured__c =  objApproveActionPlan.Insured__c; 
     		actionPlanBondObj.isAddOnExecutionTracker__c = objApproveActionPlan.isAddOnExecutionTracker__c;
     		actionPlanBondObj.Product_Name__c = objApproveActionPlan.Product_Name__c;
     		actionPlanBondObj.Company_Name__c = objApproveActionPlan.Company_Name__c;
     		companyName = objApproveActionPlan.Company_Name__r.Name;
     		actionPlanBondObj.Goal_Type__c = objApproveActionPlan.Goal_Type__c;
     		AddOnExecutionTracker = actionPlanBondObj.isAddOnExecutionTracker__c ? 'Yes' : 'No';
           	if(objApproveActionPlan.Amount__c != null) 
       			actionPlanBondObj.Amount__c = objApproveActionPlan.Amount__c.round();
       		actionPlanBondObj.Bond_Type__c = objApproveActionPlan.Bond_Type__c;
       		
     		/*applicant = objApproveActionPlan.Insured__c; 
	        isAddOnExecTracker = objApproveActionPlan.isAddOnExecutionTracker__c;
	        schemeName = objApproveActionPlan.Product_Name__c;
	        companyName.Name = objApproveActionPlan.Company_Name__r.Name;
	        goalType = objApproveActionPlan.Goal_Type__c;
	        AddOnExecutionTracker = isAddOnExecTracker ? 'Yes' : 'No';
           	if(objApproveActionPlan.Amount__c != null) 
       			investmentAmount = objApproveActionPlan.Amount__c.round();
       		loanFDid = objApproveActionPlan.Id;
       		periodInMonths = objApproveActionPlan.Period_in_Months__c;*/
       		if(mapIdToExecutionTracker.containsKey(objApproveActionPlan.Id))
		  	{
				lstET = mapIdToExecutionTracker.get(objApproveActionPlan.Id);
				for(Execution_Tracker__c objET : lstET)
				{
					if((objET.Executed_Amount__c == null || objET.Executed_Amount__c == 0 || objET.Executed_Amount__c > 0) && objET.Application_Status__c != 'Closed')
						ETStatus = Label.ET_NotExecuted;
					else if(objET.Executed_Amount__c != null && objET.Executed_Amount__c > 0 && objET.Application_Status__c == 'Closed')
						ETStatus = Label.ET_FullyExecuted;
					/*if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
						ETStatus = Label.ET_NotExecuted; 
				 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
				  	 	ETStatus = Label.ET_PartiallyExecuted;
			  		else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
				  	 	ETStatus = Label.ET_FullyExecuted;*/			
				} 
		  	}	
       		objBond = approvedPlanBean.populateBond(actionPlanBondObj,companyName,AddOnExecutionTracker,ETStatus, index++);
     	}
    }
    //getWillExecTrackerDetails
      /**
    * @Description: Retrieve Execution Tracker Details of New Action Plan
    * param: ApprovedPlanBean 
    * return type: None 
    */ 
    public void getWillExecTrackerDetails(ApprovedPlanBean approvedPlanBean)
    {
       	List<Approve_Action_Plan__c> lstApproveActionPlan = [Select Account__c, isWillExecTracker__c From Approve_Action_Plan__c 
                                where  Account__c =: approvedPlanBean.entityId and  isWill__c = : true and AP_Status__c = 'Opened'];
     	if(!lstApproveActionPlan.isEmpty())
       	for(Approve_Action_Plan__c objActionPlan : lstApproveActionPlan)
       	{
         	approvedPlanBean.isWillExecutionTracker = objActionPlan.isWillExecTracker__c ? 'Yes' : 'No';
       	}
    }
    
     /**
    * @Description: Retrieve General Insurance Details of New Action Plan
    * param: ApprovedPlanBean 
    * return type: None 
    */ 
    public void getGeneralInsurances(ApprovedPlanBean approvedPlanBean, Set<Id> familyIdSet,
    								Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    								Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    								//,List<String> generalInsuranceList)
    {
      
	  	ApprovedPlanBean.GeneralInsurance objGeneralInsurance = new ApprovedPlanBean.GeneralInsurance();
	  	ApprovedPlanBean.GeneralInsurance objNewGeneralInsurance = new ApprovedPlanBean.GeneralInsurance();
	  
	  	List<Insurance__c> lstGeneralInsurance = dbSOQLObj.getAnalysisInsurances(InsuranceRecTypes__c.getInstance('General Insurance').RecordTypeId__c, approvedPlanBean.accList);
	  	Map<Id,Insurance__c> MapIdToInsurance = new Map<Id,Insurance__c>();
	  	Map<Id,Approve_Action_Plan__c> mapIdToApprovePlan = new Map<Id,Approve_Action_Plan__c>();
	    Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
	    List<Execution_Tracker__c> lstET = new  List<Execution_Tracker__c>();
	    //List<String> lstGIproducts = new List<String>();
	    
	    String insured = '';
	    String insuredName = '';
	    String policyName = '';
	    String productName = '';
	    Long premiumAmount = 0;
	    String policyType = '';
	    Long sumAssured = 0;
	    boolean execTracker = false;
	    String executionTracker = '';
	    Id insuranceId;			
	    Boolean isETCreated = false;
	    Integer index = 0;
	    String actionPlanGeneralInsuranceID = '';
	    String GeneralInsuranceActionPlanId = '';
	    String ETStatus = Label.ET_NotCreated;
	    Boolean displayGIbutton = false;
	    
      	for(Insurance__c objInsurance : lstGeneralInsurance)
      	{
        	if(!MapIdToInsurance.containsKey(objInsurance.Id))
        	{
          		MapIdToInsurance.put(objInsurance.Id,objInsurance);
        	}
      	}
        List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();
      /*	List<Approve_Action_Plan__c> lstApproveActionPlan = [Select  Transaction_Type__c, Action_Amount__c, Insurance__c, Remarks__c, Scheme_Name__c, Goal__c , Asset_Class__c, 
	                                     isInsuranceExecutionTracker__c,Amount__c, Investment_Asset__c, isSIPexecutionTracker__c, isETcreated__c,
	                                     Fund__c, Lumpsum_Action__c,SIP_Action_Amount__c,Amount_Per_Installment__c, SIP_Action__c, Product_Name__c, 
	                                   Account__c, Option__c,  isExecutionTracker__c ,Installments__c,  Account__r.FirstName, CreatedDate, 
	                                   Account__r.LastName,Category__c,Insured__c, Policy_Type__c,Sum_Assured_Rs__c,Premium_Amount_Rs__c
	                                   From Approve_Action_Plan__c
	                                   where  Account__c IN: familyIdSet and  Item_Type__c = : 'General Insurance'
	                                   and AP_Status__c = 'Opened'];*/
	    if(mapIdTolstActionPlan.containsKey('General Insurance'))
	    {
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('General Insurance');
	    }                               

     	for(Approve_Action_Plan__c objApproveActionPlan : lstApproveActionPlan )
     	{
     		ETStatus = Label.ET_NotCreated;
     		//
        	if(objApproveActionPlan.Insurance__c == null)
        	{
		        execTracker = objApproveActionPlan.isInsuranceExecutionTracker__c;
		        productName = objApproveActionPlan.Product_Name__c;
		        system.debug('*****productName*********'+productName);
		        executionTracker = execTracker ? 'Yes' : 'No';
	            insured = objApproveActionPlan.Insured__c; 
	            system.debug('*****insured*********'+insured);
	          	//policyName = '';
	           	insuredName = objApproveActionPlan.Insured__c;
	           	policyType = objApproveActionPlan.Policy_Type__c; 
	           	if(objApproveActionPlan.Sum_Assured_Rs__c != null)
	           		sumAssured = objApproveActionPlan.Sum_Assured_Rs__c.round();
	           	if(objApproveActionPlan.Premium_Amount_Rs__c != null)
           			premiumAmount = objApproveActionPlan.Premium_Amount_Rs__c.round();
           		
           		/*Prajakta - 10-12-2013
            	if(objApproveActionPlan.Multiple_Products__c != Null)
            	{
            		String strGIproducts = objApproveActionPlan.Multiple_Products__c;
	    			lstGIproducts = strGIproducts.split(',');
            	}
            	else
            	{
            		lstGIproducts = generalInsuranceList;
            	}*/	
           		if(mapIdToExecutionTracker.containsKey(objApproveActionPlan.Id))
			  	{
					lstET = mapIdToExecutionTracker.get(objApproveActionPlan.Id);
					for(Execution_Tracker__c objET : lstET)
					{
						if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
							ETStatus = Label.ET_NotExecuted; 
					 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
					  	 	ETStatus = Label.ET_PartiallyExecuted;
				  		else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
					  	 	ETStatus = Label.ET_FullyExecuted;					}
			  	}	
           		actionPlanGeneralInsuranceID = objApproveActionPlan.Id;
           		isETCreated = objApproveActionPlan.isETcreated__c; 
           		objNewGeneralInsurance = approvedPlanBean.populateNewGeneralInsurance( insured,  premiumAmount,  policyType,  sumAssured
                                           ,  execTracker,  executionTracker , productName, actionPlanGeneralInsuranceID
                                           , isETCreated,insuredName,ETStatus,index++);//,lstGIproducts, true);
           		system.debug('*****objNewGeneralInsurance*********'+objNewGeneralInsurance);
           		//INDEX++
         	}
         
        	if(!mapIdToApprovePlan.containsKey(objApproveActionPlan.Insurance__c))
        	{
          		mapIdToApprovePlan.put(objApproveActionPlan.Insurance__c,objApproveActionPlan);
        	}
     	}
     	//lstGIproducts = new List<String>();
     	Insurance__c objInsurance = new Insurance__c();
     	for(Id idInsurance : MapIdToInsurance.keySet())
   		{
   			ETStatus = Label.ET_NotCreated;
           objInsurance = MapIdToInsurance.get(idInsurance);
           if(objInsurance.Entity__r.LastName == null)
           {
              insured = objInsurance.Entity__r.FirstName;
           }
           else if(objInsurance.Entity__r.FirstName == null )
           {
            	insured = objInsurance.Entity__r.LastName;
           }
           else if(objInsurance.Entity__r.LastName != null && objInsurance.Entity__r.FirstName != null)
           {
             insured = objInsurance.Entity__r.FirstName +' '+ objInsurance.Entity__r.LastName;
           }
           else 
           {
             insured = '';
           }
	       policyName = objInsurance.Policy_Name__c;
           if(objInsurance.Premium_Amount_Rs__c != null)
          		premiumAmount = objInsurance.Premium_Amount_Rs__c.round();
           policyType = objInsurance.Policy_Type__c;
           if(objInsurance.Sum_Assured_Rs__c != null)
        	 sumAssured = objInsurance.Sum_Assured_Rs__c.round();
           insuranceId = objInsurance.Id;
           
           
           if(mapIdToApprovePlan.containsKey(idInsurance))
    	   {
    			objApprovePlan = mapIdToApprovePlan.get(idInsurance);
    			execTracker = objApprovePlan.isInsuranceExecutionTracker__c;
            	productName = objApprovePlan.Product_Name__c;
            	executionTracker = execTracker ? 'Yes' : 'No';
            	if(objApprovePlan.Premium_Amount_Rs__c != null)
           			premiumAmount = objApprovePlan.Premium_Amount_Rs__c.round();
            	isETCreated = objApprovePlan.isETcreated__c;
            	
            	/*Prajakta - 10-12-2013
            	if(objApprovePlan.Multiple_Products__c != Null)
            	{
            		String strGIproducts = objApprovePlan.Multiple_Products__c;
	    			generalInsuranceList = strGIproducts.split(',');
            	}
            	*/
            	GeneralInsuranceActionPlanId = objApprovePlan.Id;
    			if(mapIdToExecutionTracker.containsKey(objApprovePlan.Id))
			  	{
					lstET = mapIdToExecutionTracker.get(objApprovePlan.Id);
					for(Execution_Tracker__c objET : lstET)
					{
						if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c)
							ETStatus = Label.ET_NotExecuted; 
					 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
							ETStatus = Label.ET_PartiallyExecuted;
					  	else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
						  	ETStatus = Label.ET_FullyExecuted;		
					}
			  	}
			  	displayGIbutton = true;
    		}
           else
           { 
              	isETCreated = false;
           	  	execTracker = false;
            	executionTracker = 'No';
            	GeneralInsuranceActionPlanId = '';
            	productName = '';
            	displayGIbutton = false;
           }
           
           objGeneralInsurance = approvedPlanBean.populateGeneralInsurance( insured, policyName, premiumAmount, policyType, sumAssured, 
           																	execTracker, executionTracker, insuranceId, productName, isETCreated, 
                                              								GeneralInsuranceActionPlanId,ETStatus);//, generalInsuranceList, displayGIbutton); 
       }
    }
    
   /*public static String ToString(Double Value)
    {
      //string representation if a Double value 
       return Value.format();
    }*/
    
    /**
    * @Description: Retrieve Life Insurance Details of New Action Plan
    * param: ApprovedPlanBean 
    * return type: None 
    */ 
    public void getLifeInsurances(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet
    								,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    								Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    								//,List<String> lifeInsuranceList)
    {
	    ApprovedPlanBean.LifeInsurance objLifeInsurance = new ApprovedPlanBean.LifeInsurance();
	    List<Insurance__c> lstInsurance = dbSOQLObj.getAnalysisInsurances(InsuranceRecTypes__c.getInstance('Life Insurance').RecordTypeId__c, approvedPlanBean.accList);
	    Map<Id,List<Approve_Action_Plan__c>> mapIdToApprovePlan = new Map<Id,List<Approve_Action_Plan__c>>();
	    List<Approve_Action_Plan__c> lstApprovePlan = new  List<Approve_Action_Plan__c>();
	    List<Execution_Tracker__c> lstET = new  List<Execution_Tracker__c>();
	    Map<Id,Insurance__c> MapIdToLifeInsurance = new Map<Id,Insurance__c>();
	    //List<String> lstLIproducts = new List<String>();
	    
	    //Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
	    String insured = '';
	    Long suggestedCover = 0;
	    String strSuggestedCover = '';
	    String policyName = '';
	    Long premiumAmount = 0;
	    //Long premiumAmount = 0;
	    String policyType = '';
	    double tenureOfInsurance = 0;
	    boolean execTracker = false;
	    String executionTracker = '';
	    //Added on:22/02/2013 : Aditi Satpute : AP changes
	    String insuranceRemark = '';
	    //Added on:06/02/2013 : Aditi Satpute : AP changes
	    Long sumAssured = 0;
	    Id insuranceId;
	    String actionPlanLifeInsuranceID = '';
	    Boolean isNewLI = false;
	    Boolean isETCreated = false;
	    Integer index = 0;
        Map<Id,Remarks__c> entityRemarkMap = new Map<Id,Remarks__c>();
        String ETStatus = Label.ET_NotCreated;
        
        
      	for(Insurance__c objInsurance : lstInsurance)
      	{
       	  	if(!MapIdToLifeInsurance.containsKey(objInsurance.Id))
          	{
          		MapIdToLifeInsurance.put(objInsurance.Id,objInsurance);
          	}
        }
       //Added on:22/02/2013 : Aditi Satpute : AP changes : Life Insurance Remark
       for(Remarks__c objRemark : [select Entity__c,Remark__c from Remarks__c where entity__c 
                      IN : familyIdSet and recordtype.Name =: 'LifeInsurancePlanning'])
       {
     	 	if(entityRemarkMap.get(objRemark.entity__c) == null)
         		entityRemarkMap.put(objRemark.entity__c,objRemark);
       }
	   /*List<Approve_Action_Plan__c> lstApproveActionPlan = [Select  Transaction_Type__c, Action_Amount__c, Insurance__c,Remarks__c, Scheme_Name__c, Goal__c , InsuranceRemark__c,
                                     Asset_Class__c,  isInsuranceExecutionTracker__c,Amount__c, Investment_Asset__c, isSIPexecutionTracker__c,
                                   Fund__c, Lumpsum_Action__c,SIP_Action_Amount__c,Amount_Per_Installment__c, SIP_Action__c, Policy_Name__c,
                                   Product_Name__c,  Account__c, Option__c,  isExecutionTracker__c ,Installments__c,  Account__r.FirstName, 
                                   CreatedDate,  Account__r.LastName,Category__c, Sum_Assured_Rs__c,Premium_Amount_Rs__c, Tenure_of_Insurance__c,
                                   isNewLI__c,Suggested_Cover__c,isETCreated__c,Policy_Type__c,Insured__c From Approve_Action_Plan__c  
                                   where  Account__c =: familyIdSet and  Item_Type__c = : 'Life Insurance'
                                   and AP_Status__c = 'Opened' order by isNewLI__c];*/
       List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();             
       if(mapIdTolstActionPlan.containsKey('Life Insurance'))
	   {
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('Life Insurance');
	   } 
     /* for(Approve_Action_Plan__c objApproveActionPlan : lstApproveActionPlan )
       {
        if(!mapIdToApprovePlan.containsKey(objApproveActionPlan.Insurance__c))
        {
          mapIdToApprovePlan.put(objApproveActionPlan.Insurance__c,objApproveActionPlan);
        }
        
       }*/
       lstApproveActionPlan.sort();
       //Display newly Added Life Insurance Records
       for(Approve_Action_Plan__c objApproveActionPLan : lstApproveActionPlan )
       {
       		
       		ETStatus = Label.ET_NotCreated;
       		if(objApproveActionPlan.Insurance__c == null)
        	{
	        	lstET = new  List<Execution_Tracker__c>();
	           	insured = objApproveActionPlan.Insured__c;
	           	if(objApproveActionPlan.Suggested_Cover__c != null)
	           		suggestedCover = objApproveActionPlan.Suggested_Cover__c.round();
	          	policyType = objApproveActionPlan.Policy_Type__c;
	          	isETCreated = objApproveActionPlan.isETCreated__c;
	    		execTracker = objApproveActionPlan.isInsuranceExecutionTracker__c;
	            policyName = objApproveActionPlan.Policy_Name__c;
	            executionTracker = execTracker ? 'Yes' : 'No';
	            
	            /*Prajakta - 10-16-2013
            	if(objApproveActionPlan.Multiple_Products__c != Null)
            	{
            		String strLIproducts = objApproveActionPlan.Multiple_Products__c;
	    			lstLIproducts = strLIproducts.split(',');
            	}
            	else
            	{
            		lstLIproducts = lifeInsuranceList;
            	}*/
	            if(mapIdToExecutionTracker.containsKey(objApproveActionPlan.Id))
			  	{
					lstET = mapIdToExecutionTracker.get(objApproveActionPlan.Id);
					if(lstET.size() > 0)
					{
						for(Execution_Tracker__c objET : lstET)
						{
							//error.debugLog('**ETStatus**in Life*for*'+objET);
						 	if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
								ETStatus = Label.ET_NotExecuted; 
						 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
						  	 	ETStatus = Label.ET_PartiallyExecuted;
					  		else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
						  	 	ETStatus = Label.ET_FullyExecuted;
						/*	if(objET.Agreed_Amount_Base_Amount__c == objET.Balance_Remaining__c || (objET.Agreed_Amount__c == null || objET.Agreed_Amount__c == 0 ))
								ETStatus = Label.ET_NotExecuted; 
							else if((objET.Agreed_Amount__c != null && objET.Agreed_Amount__c != 0 ) && objET.Agreed_Amount__c > objET.Executed_Amount__c)
						  	 	ETStatus = Label.ET_PartiallyExecuted;
						  	else if(objET.Agreed_Amount__c == objET.Executed_Amount__c)
						  	 	ETStatus = Label.ET_FullyExecuted;*/
						} 
					}
					else
					{
						ETStatus = Label.ET_NotCreated; 
					}
			  	}
	            if(objApproveActionPlan.Sum_Assured_Rs__c != null)
	            	sumAssured = objApproveActionPlan.Sum_Assured_Rs__c.round();
	            if(objApproveActionPlan.Premium_Amount_Rs__c != null)
	            	premiumAmount = objApproveActionPlan.Premium_Amount_Rs__c.round();
	            tenureOfInsurance = objApproveActionPlan.Tenure_of_Insurance__c;
	            
	            objLifeInsurance = approvedPlanBean.populateNewLifeInsurance( insured,  suggestedCover, policyName,  premiumAmount,  policyType
	                              , tenureOfInsurance,  execTracker,  executionTracker,  insuranceId
	                              , sumAssured,isETCreated,objApproveActionPlan.Id,ETStatus,index++);//,lstLIproducts,true);
        	}
          	if(mapIdToApprovePlan.get(objApproveActionPLan.Insurance__c) == null)
          	{
            	lstApproveActionPlan = new List<Approve_Action_Plan__c>();
            	lstApproveActionPlan.add(objApproveActionPLan);
            	mapIdToApprovePlan.put(objApproveActionPLan.Insurance__c, lstApproveActionPlan);
          	}
          	else
          	{
            	mapIdToApprovePlan.get(objApproveActionPLan.Insurance__c).add(objApproveActionPLan);
          	}
       }
       Map<String,List<ApprovedPlanBean.LifeInsurance>> mapIdToInnerClass = new Map<String,List<ApprovedPlanBean.LifeInsurance>>();
       
       Map<String,List<ApprovedPlanBean.LifeInsurance>> mapIdToInnerClass_PDF_HTML = new Map<String,List<ApprovedPlanBean.LifeInsurance>>();
       
       
       //lstLIproducts = new List<String>();
       Insurance__c objInsurance = new Insurance__c();
       Remarks__c objRemarks = new Remarks__c();
         //Fetch Records from Life Insurance - object with Analysis Flag
       for(Id idInsurance : MapIdToLifeInsurance.keySet())
       {
       		ETStatus = Label.ET_NotCreated;
           	List<ApprovedPlanBean.LifeInsurance> lstLifeInsurance = new List<ApprovedPlanBean.LifeInsurance>();
           	List<ApprovedPlanBean.LifeInsurance> lstLifeInsurance_pdf_html = new List<ApprovedPlanBean.LifeInsurance>();
           	
            objInsurance = MapIdToLifeInsurance.get(idInsurance);
            if(mapIdToApprovePlan.containsKey(idInsurance))
          	{
	            lstApprovePlan = mapIdToApprovePlan.get(idInsurance);
	            system.debug('**lstApprovePlan*****'+lstApprovePlan);
	            system.debug('**lstApprovePlan.size()*****'+lstApprovePlan.size());
	            
	            for(Approve_Action_Plan__c  objApprovePlan : lstApprovePlan)
	            {
	            	ETStatus = Label.ET_NotCreated;
	            	lstET = new  List<Execution_Tracker__c>();
	                if(objInsurance.Entity__r.LastName == null)
                  	{
	                    insured = objInsurance.Entity__r.FirstName;
                  	}
                  	else if(objInsurance.Entity__r.FirstName == null )
                  	{
	                    insured = objInsurance.Entity__r.LastName;
                  	}
                  	else if(objInsurance.Entity__r.LastName != null && objInsurance.Entity__r.FirstName != null)
                  	{
	                    insured = objInsurance.Entity__r.FirstName +' '+ objInsurance.Entity__r.LastName;
                  	}
                  	else
                  	{
	                    insured = '';
                  	}
                   	system.debug('**objApprovePlan.Suggested_Cover__c*****'+objApprovePlan.Suggested_Cover__c);
                   	if(objApprovePlan.Suggested_Cover__c != null)
                   		suggestedCover = objApprovePlan.Suggested_Cover__c.round();
                   	if(objApprovePlan.Suggested_Cover__c != null && objApprovePlan.Suggested_Cover__c != 0)
                     	strSuggestedCover = suggestedCover.format();
              		//Commented on:18/02/2013 : Aditi Satpute : AP changes
	              	//premiumAmount = objInsurance.Premium_Amount_Rs__c;
	              	
	              	policyType = objApprovePlan.Policy_Type__c;
	              	
	              	isETCreated = objApprovePlan.isETCreated__c;
	              	//Commented on:18/02/2013 : Aditi Satpute : AP changes
	              	//tenureOfInsurance = objInsurance.Tenure_of_Insurance__c;
	              	insuranceId = objInsurance.Id;
        
              		//objApprovePlan = mapIdToApprovePlan.get(idInsurance);
            		execTracker = objApprovePlan.isInsuranceExecutionTracker__c;
		            policyName = objApprovePlan.Policy_Name__c;
		            executionTracker = execTracker ? 'Yes' : 'No';
		            
		            /*Prajakta - 10-16-2013
	            	if(objApprovePlan.Multiple_Products__c != Null)
	            	{
	            		String strLIproducts = objApprovePlan.Multiple_Products__c;
		    			lstLIproducts = strLIproducts.split(',');
		    			system.debug('**lstLIproducts*****'+lstLIproducts);
	            	}
	            	/*else
	            	{
	            		lstLIproducts = lifeInsuranceList;
	            	}
		            */
		            if(mapIdToExecutionTracker.containsKey(objApprovePlan.Id))
				  	{
						lstET = mapIdToExecutionTracker.get(objApprovePlan.Id);
						if(lstET.size() > 0)
						{
							for(Execution_Tracker__c objET : lstET)
							{
								//error.debugLog('**ETStatus**in Life*for*'+objET);
							 	if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
									ETStatus = Label.ET_NotExecuted; 
							 	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
							  	 	ETStatus = Label.ET_PartiallyExecuted;
						  		else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
							  	 	ETStatus = Label.ET_FullyExecuted;
							/*	if(objET.Agreed_Amount_Base_Amount__c == objET.Balance_Remaining__c || (objET.Agreed_Amount__c == null || objET.Agreed_Amount__c == 0 ))
									ETStatus = Label.ET_NotExecuted; 
								else if((objET.Agreed_Amount__c != null && objET.Agreed_Amount__c != 0 ) && objET.Agreed_Amount__c > objET.Executed_Amount__c)
							  	 	ETStatus = Label.ET_PartiallyExecuted;
							  	else if(objET.Agreed_Amount__c == objET.Executed_Amount__c)
							  	 	ETStatus = Label.ET_FullyExecuted;*/
							}
						}
						else
						{
							ETStatus = Label.ET_NotCreated; 
						}
				  	}
		            //error.debugLog('**ETStatus**in Life**'+ETStatus);
		            //Added on:06/02/2013 : Aditi Satpute : AP changes
		            if(objApprovePlan.Sum_Assured_Rs__c != null)
		            	sumAssured = objApprovePlan.Sum_Assured_Rs__c.round();
		            //Added on:18/02/2013 : Aditi Satpute : AP changes
		            if(objApprovePlan.Premium_Amount_Rs__c != null)
		            	//premiumAmount = Math.log(objApprovePlan.Premium_Amount_Rs__c);//.round();
		            	premiumAmount = objApprovePlan.Premium_Amount_Rs__c.round();
		            tenureOfInsurance = objApprovePlan.Tenure_of_Insurance__c;
		            insuranceRemark = objApprovePlan.InsuranceRemark__c;
		            isNewLI = objApprovePlan.isNewLI__c;
		            
		            objLifeInsurance = approvedPlanBean.populateLifeInsurance( insured,  suggestedCover, strSuggestedCover, policyName,  premiumAmount,  policyType
                                      , tenureOfInsurance,  execTracker,  executionTracker,  insuranceId
                                      , sumAssured, insuranceRemark,isNewLI, --newInsuranceCount,isETCreated,objApprovePlan.Id,ETStatus);//,lstLIproducts, true);
                	lstLifeInsurance.add(objLifeInsurance);
                	/*if(policyName != null && policyName != '')
                	{
                		lstLifeInsurance_pdf_html.add(objLifeInsurance);
                	}
                	*/
            	}
           		// actionPlanLifeInsuranceID = objApprovePlan.Id;
          	}
          	else
          	{
            	if(objInsurance.Entity__r.LastName == null)
                {
                  insured = objInsurance.Entity__r.FirstName;
                }
                else if(objInsurance.Entity__r.FirstName == null )
                {
                  insured = objInsurance.Entity__r.LastName;
                }
                else if(objInsurance.Entity__r.LastName != null && objInsurance.Entity__r.FirstName != null)
                {
                  insured = objInsurance.Entity__r.FirstName +' '+ objInsurance.Entity__r.LastName;
                }
                else
                {
                  insured = '';
                }
            	suggestedCover = objInsurance.Suggested_Cover_General_Insurance__c.round();
             	if(suggestedCover != null ||  suggestedCover != 0)
              		strSuggestedCover = suggestedCover.format();
            	//Commented on:18/02/2013 : Aditi Satpute : AP changes
            	//premiumAmount = objInsurance.Premium_Amount_Rs__c;
            	policyType = objInsurance.Policy_Type__c;
	            insuranceId = objInsurance.Id;
	            execTracker = false;
	            executionTracker = 'No';
	            policyName = '';
	            //Added on : 28/10/13 : Aditi Satpute - LI Capping related Changes : SumAssured should have default Suggested Cover
	            sumAssured = objInsurance.Suggested_Cover_General_Insurance__c.round();
	            //Added on:18/02/2013 : Aditi Satpute : AP changes
	            if(objInsurance.Premium_Amount_Rs__c != null)
	              	//premiumAmount = Math.log(objInsurance.Premium_Amount_Rs__c);//.round();
	              	premiumAmount = objInsurance.Premium_Amount_Rs__c.round();
	            //Added on:18/02/2013 : Aditi Satpute : AP changes
	            if(objInsurance.Tenure_of_Insurance__c != null)
	             	tenureOfInsurance = objInsurance.Tenure_of_Insurance__c;
	            if(entityRemarkMap.containsKey(objInsurance.Entity__c))
                {
                 	objRemarks = entityRemarkMap.get(objInsurance.Entity__c);
                  	insuranceRemark = objRemarks.Remark__c;
                  	system.debug('**********insuranceRemark***in if******'+insuranceRemark);
                }
          		
             	objLifeInsurance = approvedPlanBean.populateLifeInsurance( insured,  suggestedCover, strSuggestedCover, policyName,  premiumAmount,  policyType
                                    , tenureOfInsurance,  execTracker,  executionTracker,  insuranceId
                                    , sumAssured, insuranceRemark,false,0,false,'',ETStatus);//, lifeInsuranceList, false );
                                    
                lstLifeInsurance.add(objLifeInsurance);
          	}
           	if(!mapIdToInnerClass.containsKey(insuranceId))
          	{
            	mapIdToInnerClass.put(insuranceId,lstLifeInsurance);
          	}
          /*	if(!mapIdToInnerClass_PDF_HTML.containsKey(insuranceId))
          	{
          		if(lstLifeInsurance_pdf_html.size() > 0)
          		{
            		mapIdToInnerClass_PDF_HTML.put(insuranceId,lstLifeInsurance_pdf_html);
          		}
          	}
          	approvedPlanBean.mapIdToLifeInsuranceInnerClass_Html_Pdf = mapIdToInnerClass_PDF_HTML;*/
          	approvedPlanBean.mapIdToLifeInsuranceInnerClass = mapIdToInnerClass;
         }
    }
    
    /*/*--------------------------------------------------------------Prajakta - 16-7-2013-----------------------------------------------------
    * @Description: Retrieve the Current Mutual Funds of New Action Plan
    * param: ApprovedPlanBean 
    * return type: None 
    */ 
    public void getCurrentGoldSilver(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    									Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    { 
       	Map<Id,List<Approve_Action_Plan__c>> mapIdToApprovePlan = new Map<Id,List<Approve_Action_Plan__c>>();
      	Investment_Asset__c objInvestmentAsset = new Investment_Asset__c();
       	List<Approve_Action_Plan__c> lstApprovePlan = new  List<Approve_Action_Plan__c>();
       	List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>(); 
       	//List<Approve_Action_Plan__c> upsertListGS = new List<Approve_Action_Plan__c>();
       	ApprovedPlanBean.CurrentGoldSilver objCurrentGoldSilver = new ApprovedPlanBean.CurrentGoldSilver();
       	ApprovedPlanBean.CurrentGoldSilver objCurrentGoldSilverSIP = new ApprovedPlanBean.CurrentGoldSilver();
        
        //mapIdToInnerClass map returns the InvestmentID vs list of CurrentGoldSilver inner class to store splitting of individual records together with same ID 
        Map<Id,List<ApprovedPlanBean.CurrentGoldSilver>> mapIdToInnerClassGS = new Map<Id,List<ApprovedPlanBean.CurrentGoldSilver>>();
       	Map<Id,Investment_Asset__c> mapIdToInvestmentAssetGold = new Map<Id,Investment_Asset__c>();
       	
       
       	double actionAmount = 0;
     	double amount = 0;
     	String assetClass = '';
     	String lumpsumAction = '';
     	String account = '';
     	String owner = '';
     	String schemeName = '';
    	boolean execTracker = false;
     	boolean SIPexecTracker = false;
     	String executionTracker = '';
     	String SIPexecutionTracker = '';
     	double currentSIP = 0;
     	String SIPaction = '';
	    double SIPactionAmount;
	    Id investmentId ;
	    Boolean isNewGoldSilver = false;
	    Boolean isGSETcreated = false;
	    Boolean isGSsipETCreated = false;
	    String ETLumupsumStatus = Label.ET_NotCreated;
	  	String ETSipStatus = Label.ET_NotCreated;
	    
	    Double oldInvestmentAssetAmount = 0;
	    Double changedInvestmentAssetAmount = 0;
	    String changedAmountSchemeName = '';
	    Double actionAmountToBeChanged = 0;
	     
	    //Added on:18/02/2013 : Aditi Satpute : AP changes
	    //String mfLumpsumRemark = '';
	    //String mfSIPRemark = ''; 
     	//=================================================================
    
     	//mapIdToInvestmentAssetGold map returns all records from Investment Assets which are mutual fund 
       	mapIdToInvestmentAssetGold = new  Map<Id,Investment_Asset__c>
                                  ([Select Monthly_SIP_Amount__c, Entity__c, Asset_Type__c, 
											Entity__r.FirstName, Entity__r.LastName, Asset_Name__c, TotalAsset__c ,
											RecordType.Name, Allocated_Amount__c,  Action__c 
									From Investment_Asset__c  
									where  Entity__c =: familyIdSet
									and  RecordType.Name = 'Gold and Silver']);
                                      
       	//lstApproveActionPlan list returns all the records for current Gold and Silver
       /*	List<Approve_Action_Plan__c> lstApproveActionPlan = 
       								[Select isNewGoldSilver__c, isGSsip_ExecutionTracker__c, isGSsipETCreated__c, 
											isGS_ExecutionTracker__c, isGSETcreated__c, Id, Goal__c,GS_SIPRemark__c, Multiple_Products__c ,
									       	GS_LumpsumRemark__c, Amount__c, Asset_Type__c, Action_Amount__c, Asset_Name__c, 
									       	Account__c, AP_Status__c ,  Account__r.FirstName,  Account__r.LastName,
									       	SIP_Action_Amount__c,Investment_Asset__c,Lumpsum_Action__c, SIP_Action__c  
                                 	From Approve_Action_Plan__c 
                                    where  Account__c =: familyIdSet
                                    and  Investment_Asset__c != null and AP_Status__c = 'Opened' order by isNewGoldSilver__c]; */
                                    
       	List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();             
       	if(mapIdTolstActionPlan.containsKey('Gold and Silver'))
	   	{
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('Gold and Silver');
	   	} 
        lstApproveActionPlan.sort();
       	for(Approve_Action_Plan__c objApproveActionPLan : lstApproveActionPlan)
        {
          	if(mapIdToApprovePlan.get(objApproveActionPLan.Investment_Asset__c) == null)
          	{
            	lstApproveActionPlan = new List<Approve_Action_Plan__c>();
            	lstApproveActionPlan.add(objApproveActionPLan);
            	mapIdToApprovePlan.put(objApproveActionPLan.Investment_Asset__c, lstApproveActionPlan);
          	}
          	else
          	{
            	mapIdToApprovePlan.get(objApproveActionPLan.Investment_Asset__c).add(objApproveActionPLan);
          	}
        }
       
       	Boolean isAmountChanged = false;
       
       	for(Id idInvestment : mapIdToInvestmentAssetGold.keySet())
       	{
       		ETLumupsumStatus = Label.ET_NotCreated;
 		    ETSipStatus = Label.ET_NotCreated;
       	  	List<ApprovedPlanBean.CurrentGoldSilver> lstCurrentGoldSilver = new List<ApprovedPlanBean.CurrentGoldSilver>();
         	List<ApprovedPlanBean.CurrentGoldSilver> lstGSsip = new List<ApprovedPlanBean.CurrentGoldSilver>();
        	objInvestmentAsset = mapIdToInvestmentAssetGold.get(idInvestment);
        	System.debug('----------------------mapIdToApprovePlan.containsKey(idInvestment)--------------------'+mapIdToApprovePlan.containsKey(idInvestment));
        	if(mapIdToApprovePlan.containsKey(idInvestment))
        	{
          		lstApprovePlan = mapIdToApprovePlan.get(idInvestment);
          		for(Approve_Action_Plan__c objApprovePlan : lstApprovePlan)
          		{
          			lstET = new List<Execution_Tracker__c>();
          			ETLumupsumStatus = Label.ET_NotCreated;
 		    		ETSipStatus = Label.ET_NotCreated;
            		actionAmount = objApprovePlan.Action_Amount__c;
            		SIPactionAmount = objApprovePlan.SIP_Action_Amount__c;
           	 		lumpsumAction = objApprovePlan.Lumpsum_Action__c;
           	
            		if(objApprovePlan.isNewGoldSilver__c)
            		{
            			amount = objApprovePlan.Amount__c;
            		}
            		else
            		{
            			amount = objInvestmentAsset.TotalAsset__c;
            			if(!isAmountChanged)
            			{
            				if(objInvestmentAsset.TotalAsset__c != objApprovePlan.Amount__c)
            				{
            					isAmountChanged = true;
            					changedAmountSchemeName = objInvestmentAsset.Asset_Name__c;
		            			oldInvestmentAssetAmount = objApprovePlan.Amount__c;
		     					changedInvestmentAssetAmount = objInvestmentAsset.TotalAsset__c;
		     					actionAmountToBeChanged = objApprovePlan.Action_Amount__c;
            				}
            			}
           		 	}
		            assetClass = objInvestmentAsset.Asset_Type__c;
		            if(objApprovePlan.Account__r.LastName == null)
	                {
	                  owner = objApprovePlan.Account__r.FirstName;
	                }
	                else if(objApprovePlan.Account__r.FirstName == null )
	                {
	                  owner = objApprovePlan.Account__r.LastName;
	                }
	                else if(objApprovePlan.Account__r.LastName != null && objApprovePlan.Account__r.FirstName != null)
	                {
	                  owner = objApprovePlan.Account__r.FirstName +' '+ objApprovePlan.Account__r.LastName;
	                }
	                else
	                {
	                  owner = '';
	                }
		            account = objApprovePlan.Account__c;
		            schemeName = objInvestmentAsset.Asset_Name__c;
		            execTracker = objApprovePlan.isGS_ExecutionTracker__c;
		            SIPexecTracker = objApprovePlan.isGSsip_ExecutionTracker__c; 
		            currentSIP = objInvestmentAsset.Monthly_SIP_Amount__c;
		            SIPaction = objApprovePlan.SIP_Action__c;
		            isNewGoldSilver = objApprovePlan.isNewGoldSilver__c;
		            executionTracker = execTracker ? 'Yes' : 'No';
		            SIPexecutionTracker = SIPexecTracker ? 'Yes' : 'No';
		            investmentId = idInvestment;
		            
		            isGSETCreated = objApprovePlan.isGSETcreated__c;
		            isGSsipETCreated = objApprovePlan.isGSsipETCreated__c;
		            //Added on:18/02/2013 : Aditi Satpute : AP changes
		            //mfLumpsumRemark = objApprovePlan.MF_LumpsumRemark__c;
		            //mfSIPRemark = objApprovePlan.MF_SIPRemark__c;
		            
		            if(objApprovePlan.isGS_ExecutionTracker__c == true || (objApprovePlan.isGSsip_ExecutionTracker__c && objApprovePlan.Investment_Asset__c != null))
	    			{
	    				if(mapIdToExecutionTracker.containsKey(objApprovePlan.Id))
	    					lstET = mapIdToExecutionTracker.get(objApprovePlan.Id);
	    					system.debug('*********lstET*********'+lstET);
	    				if(lstET.size() > 0)
	    				{
		    				//Ta assign last records assignToOps Status
			    			for(Execution_Tracker__c obj : lstET)
			    			{
			    				if(obj.Type__c != null && obj.Type__c.equalsIgnoreCase('Lumpsum'))
				    			{
				    				 if(obj.Suggested_Amount__c == obj.Total_Remaining_Balance__c && obj.Application_Status__c != 'Closed')
										ETLumupsumStatus = Label.ET_NotExecuted; 
									 else if(obj.Suggested_Amount__c > obj.Total_Remaining_Balance__c  && obj.Application_Status__c != 'Closed')
								  	 	ETLumupsumStatus = Label.ET_PartiallyExecuted;
								  	 else if(obj.Total_Remaining_Balance__c == obj.Agreed_Amount__c && obj.Executed_Amount__c == obj.Agreed_Amount__c )
								  	 	ETLumupsumStatus = Label.ET_FullyExecuted;
				    			}
				    			else if(obj.Type__c != null && obj.Type__c.equalsIgnoreCase('SIP'))
				    			{
				    				 if(obj.Suggested_Amount__c == obj.Total_Remaining_Balance__c && obj.Application_Status__c != 'Closed')
										ETSipStatus = Label.ET_NotExecuted; 
									 else if(obj.Suggested_Amount__c > obj.Total_Remaining_Balance__c  && obj.Application_Status__c != 'Closed')
								  	 	ETSipStatus = Label.ET_PartiallyExecuted;
								  	 else if(obj.Total_Remaining_Balance__c == obj.Agreed_Amount__c && obj.Executed_Amount__c == obj.Agreed_Amount__c )
								  	 	ETSipStatus = Label.ET_FullyExecuted;
				    			}
			    			}
	    				}
	    				else
	    				{
	    					ETLumupsumStatus = Label.ET_NotCreated;
	    				}	
	    			}
		            
		            system.debug('******isGSETCreated********'+isGSETCreated);
		            system.debug('******amount********'+amount);
		            system.debug('*****objApprovePlan.Id******'+objApprovePlan.Id);
		            
		            objCurrentGoldSilver = approvedPlanBean.populateCurrentGoldSilver
		                                (schemeName, assetClass, amount,owner, account, 
		                                 lumpsumAction, actionAmount,execTracker,investmentId,
		                                 executionTracker,isNewGoldSilver, --newCount,
		                                 isGSETCreated,isGSsipETCreated,objApprovePlan.id,ETLumupsumStatus);
	               	system.debug('****objCurrentGoldSilver****'+objCurrentGoldSilver);                    
		            lstCurrentGoldSilver.add(objCurrentGoldSilver);
		            if(currentSIP != null && !isNewGoldSilver  && currentSIP > 0)
              		objCurrentGoldSilverSIP = approvedPlanBean.populateSIPCurrentGoldSilver
                                (schemeName, assetClass,
                                 amount,owner, account,
                                 lumpsumAction, actionAmount, SIPactionAmount,
                                 execTracker,SIPexecTracker,investmentId,
                                 executionTracker,SIPexecutionTracker,currentSIP,
                                 SIPaction, isNewGoldSilver,isGSETCreated,isGSsipETCreated,ETSipStatus);//, mfSIPRemark);
                                 
            		//lstGSsip.add(objCurrentGoldSilverSIP);
            		//lstCurrentGoldSilver.add(objCurrentGoldSilverSIP);
            		system.debug('--in if-----objCurrentGoldSilver-----------'+objCurrentGoldSilver);
		          system.debug('----in if---objCurrentGoldSilverSIP-----------'+objCurrentGoldSilverSIP);
          		}
        	}
       	 	else
        	{
		         actionAmount = 0;
		          //Commented on:18/02/2013 : Aditi Satpute : AP changes
		          //lumpsumAction = 'Hold - Change of broker';
		          //Added on:18/02/2013 : Aditi Satpute : AP changes
		          lumpsumAction = '';
		          amount = objInvestmentAsset.TotalAsset__c;
		          assetClass = objInvestmentAsset.Asset_Type__c;
		          account = objInvestmentAsset.Entity__c;
		          if(objInvestmentAsset.Entity__r.LastName == null)
	              {
	                	owner = objInvestmentAsset.Entity__r.FirstName;
	              }
	              else if(objInvestmentAsset.Entity__r.FirstName == null )
	              {
	                	owner = objInvestmentAsset.Entity__r.LastName;
	              }
	              else if(objInvestmentAsset.Entity__r.LastName != null && objInvestmentAsset.Entity__r.FirstName != null)
	              {
	                	owner = objInvestmentAsset.Entity__r.FirstName +' '+ objInvestmentAsset.Entity__r.LastName;
	              }
	              else
	              {
	                	owner = '';
	              }
		          schemeName = objInvestmentAsset.Asset_Name__c;
		          SIPactionAmount = 0;
		          currentSIP = objInvestmentAsset.Monthly_SIP_Amount__c;
		          SIPaction = 'Continue';
		          execTracker = false;
		          executionTracker = 'No';
		          SIPexecTracker = false;
		          SIPexecutionTracker = 'No';
		          investmentId = idInvestment;
		          objCurrentGoldSilver = approvedPlanBean.populateCurrentGoldSilver
		                              (schemeName, assetClass, 
		                               amount,owner, account, 
		                               lumpsumAction, actionAmount,
		                               execTracker,investmentId,
		                               executionTracker,false, 0,false,false,'',ETLumupsumStatus);
		          lstCurrentGoldSilver.add(objCurrentGoldSilver);                     
		          if(currentSIP != null  && !isNewGoldSilver  && currentSIP > 0)
		          {
		          		SIPexecTracker = false;
		          		SIPexecutionTracker = 'No';
		            	objCurrentGoldSilverSIP = approvedPlanBean.populateSIPCurrentGoldSilver
		                              (schemeName, assetClass,
		                               amount,owner, account,
		                               lumpsumAction, actionAmount, SIPactionAmount,
		                               execTracker,SIPexecTracker,investmentId,
		                               executionTracker,SIPexecutionTracker,currentSIP,
		                               SIPaction,false,false,false,ETSipStatus);
          
		          }
		          system.debug('----in else---objCurrentGoldSilver-----------'+objCurrentGoldSilver);
		          system.debug('---in else----objCurrentGoldSilverSIP-----------'+objCurrentGoldSilverSIP);
		          //lstGSsip.add(objCurrentGoldSilverSIP);
		          //lstCurrentGoldSilver.add(objCurrentGoldSilverSIP);
			}
	        system.debug('*****lstCurrentGoldSilver*******'+lstCurrentGoldSilver);
	        system.debug('*****lstGSsip.size()*******'+lstGSsip.size());
	        
	        if(!mapIdToInnerClassGS.containsKey(idInvestment))
	        {
	          mapIdToInnerClassGS.put(idInvestment,lstCurrentGoldSilver);
	        }
	        system.debug('******mapIdToInnerClassGS*******'+mapIdToInnerClassGS);
	        system.debug('******mapIdToInnerClassGS.size()*******'+mapIdToInnerClassGS.size());
	        approvedPlanBean.mapIdToCurrentGold = mapIdToInnerClassGS ;
        
       }
       if(isAmountChanged)
       {
       		if(actionAmountToBeChanged > 0 && actionAmountToBeChanged != null)
       		{
	        	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.Warning,'There is change in Amount of Investment Assets Mutual Fund record of "'
	        	+changedAmountSchemeName+ '" from "'+oldInvestmentAssetAmount+'" to "'+changedInvestmentAssetAmount
	        	+'" after saving Action Plan. Please reallocate the Action Amount'));
	        	return;
       		}
       		else
       		{
       			ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.INFO,'There is change in Amount of Investment Assets Mutual Fund record of "'
	        	+changedAmountSchemeName+ '" from "'+oldInvestmentAssetAmount+'" to "'+changedInvestmentAssetAmount
	        	+'" after saving Action Plan.'));
	        	return;
       		}
       }
    }
    
    /*--------------------------------------------------------End------Prajakta - 16-7-2013-----------------------------------------------------*/
    
    /**
    * @Description: Retrieve the Current Mutual Funds of New Action Plan
    * param: ApprovedPlanBean 
    * return type: None 
    */ 
    public void getCurrentMutualFunds(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    										Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    { 
       	Map<Id,List<Approve_Action_Plan__c>> mapIdToApprovePlan = new Map<Id,List<Approve_Action_Plan__c>>();
      	Investment_Asset__c objInvestmentAsset = new Investment_Asset__c();
       	List<Approve_Action_Plan__c> lstApprovePlan = new  List<Approve_Action_Plan__c>();
       	List<Approve_Action_Plan__c> upsertList = new List<Approve_Action_Plan__c>();
       	ApprovedPlanBean.CurrentMutualFunds objCurrentMutualFunds = new ApprovedPlanBean.CurrentMutualFunds();
       	ApprovedPlanBean.CurrentMutualFunds objCurrentMutualFundsSIP = new ApprovedPlanBean.CurrentMutualFunds();
        
        //mapIdToInnerClass map returns the InvestmentID vs list of CurrentMutualFunds inner class to store splitting of individual records together with same ID 
        Map<Id,List<ApprovedPlanBean.CurrentMutualFunds>> mapIdToInnerClass = new Map<Id,List<ApprovedPlanBean.CurrentMutualFunds>>();
       	// Map<String,List<ApprovedPlanBean.CurrentMutualFunds>> mapActionToGoldSilverLumpsum = new Map<String,List<ApprovedPlanBean.CurrentMutualFunds>>();
       	// Map<String,List<ApprovedPlanBean.CurrentMutualFunds>> mapActionToMutualFundSIP = new Map<String,List<ApprovedPlanBean.CurrentMutualFunds>>();
       	Map<Id,Investment_Asset__c> mapIdToInvestmentAsset = new  Map<Id,Investment_Asset__c>();
       	double actionAmount = 0;
     	double amount = 0;
     	String assetClass = '';
     	String lumpsumAction = '';
     	String account = '';
     	String owner = '';
     	String schemeName = '';
    	boolean execTracker = false;
     	boolean SIPexecTracker = false;
     	String executionTracker = '';
     	String SIPexecutionTracker = '';
     	double currentSIP = 0;
     	String SIPaction = '';
	    double SIPactionAmount;
	    Id investmentId ;
	    Boolean isNewMutualFund = false;
	    Boolean isETCreated = false;
	    Boolean isMFsipETCreated = false;
	    String ETLumupsumStatus = Label.ET_NotCreated;
	  	String ETSipStatus = Label.ET_NotCreated;
	    
	    Double oldInvestmentAssetAmount = 0;
	    Double changedInvestmentAssetAmount = 0;
	    String changedAmountSchemeName = '';
	    Double actionAmountToBeChanged = 0;
	    List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>(); 
	    //Added on:18/02/2013 : Aditi Satpute : AP changes
	    //String mfLumpsumRemark = '';
	    //String mfSIPRemark = ''; 
     	//=================================================================
    
    	//mapIdToInvestmentAsset map returns all records from Investment Assets which are mutual fund 
       	     	  
    
     	//mapIdToInvestmentAsset map returns all records from Investment Assets which are mutual fund 
       	mapIdToInvestmentAsset = new  Map<Id,Investment_Asset__c>
                                  ([Select  Entity__c, Entity__r.FirstName, Entity__r.LastName, Scheme_Name_Text__c , TotalAsset__c ,
                                      RecordType.Name,  Asset_Type__c,  Allocated_Amount__c,  Action__c , Monthly_SIP_Amount__c 
                                      From Investment_Asset__c  
                                      where  Entity__c =: familyIdSet //Added on 30/11/2012
                                      and  RecordType.Name = 'Mutual Fund' 
                                      //AND 
                                      //isIncludeActionPlan__c = true
                                      ]);
                                      
       	//lstApproveActionPlan list returns all the records for current mutual funds  
       	/*List<Approve_Action_Plan__c> lstApproveActionPlan = [Select Transaction_Type__c,Action_Amount__c,Remarks__c,Scheme_Name__c, Goal__c , Asset_Class__c,
                                Amount__c, Investment_Asset__c, isSIPexecutionTracker__c,Fund__c, Lumpsum_Action__c,SIP_Action_Amount__c, Multiple_Products__c ,
                                Amount_Per_Installment__c, SIP_Action__c, Product_Name__c,  Account__c, Option__c,  isExecutionTracker__c, 
                                isNewMutualFund__c,Installments__c,  Account__r.FirstName,CreatedDate,  Account__r.LastName,Category__c,
                                 isETCreated__c,isMFsipETCreated__c From Approve_Action_Plan__c 
                                //MF_LumpsumRemark__c, MF_SIPRemark__c 
                            //    where  Account__c =: approvedPlanBean.entityId and  Investment_Asset__c != null];
                                   where  Account__c =: familyIdSet //Added on 30/11/2012 
                                   and  Investment_Asset__c != null and AP_Status__c = 'Opened' order by isNewMutualFund__c];*/
                                   
       	List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();             
       	if(mapIdTolstActionPlan.containsKey('Mutual Fund'))
	   	{
	    	lstApproveActionPlan = mapIdTolstActionPlan.get('Mutual Fund');
	   	} 
        lstApproveActionPlan.sort();                           
       	for(Approve_Action_Plan__c objApproveActionPLan : lstApproveActionPlan )
        {
          	if(mapIdToApprovePlan.get(objApproveActionPLan.Investment_Asset__c) == null)
          	{
            	lstApproveActionPlan = new List<Approve_Action_Plan__c>();
            	lstApproveActionPlan.add(objApproveActionPLan);
            	mapIdToApprovePlan.put(objApproveActionPLan.Investment_Asset__c, lstApproveActionPlan);
          	}
          	else
          	{
            	mapIdToApprovePlan.get(objApproveActionPLan.Investment_Asset__c).add(objApproveActionPLan);
          	}
        }
       
       	Boolean isAmountChanged = false;
       
       	for(Id idInvestment : mapIdToInvestmentAsset.keySet())
       	{
       		ETLumupsumStatus = Label.ET_NotCreated;
 		    ETSipStatus = Label.ET_NotCreated;
       	  	List<ApprovedPlanBean.CurrentMutualFunds> lstCurrentMutualFunds = new List<ApprovedPlanBean.CurrentMutualFunds>();
         	List<ApprovedPlanBean.CurrentMutualFunds> lstMFsip = new List<ApprovedPlanBean.CurrentMutualFunds>();
        	objInvestmentAsset = mapIdToInvestmentAsset.get(idInvestment);
        	System.debug('----------------------mapIdToApprovePlan.containsKey(idInvestment)--------------------'+mapIdToApprovePlan.containsKey(idInvestment));
        	if(mapIdToApprovePlan.containsKey(idInvestment))
        	{
          		lstApprovePlan = mapIdToApprovePlan.get(idInvestment);
          		for(Approve_Action_Plan__c objApprovePlan : lstApprovePlan)
          		{
          			lstET = new List<Execution_Tracker__c>();
          			ETLumupsumStatus = Label.ET_NotCreated;
 		    		ETSipStatus = Label.ET_NotCreated;
            		actionAmount = objApprovePlan.Action_Amount__c;
            		SIPactionAmount = objApprovePlan.SIP_Action_Amount__c;
           	 		lumpsumAction = objApprovePlan.Lumpsum_Action__c;
           	
            		if(objApprovePlan.isNewMutualFund__c)
            		{
            			amount = objApprovePlan.Amount__c;
            		}
            		else
            		{
            			amount = objInvestmentAsset.TotalAsset__c;
            			if(!isAmountChanged)
            			{
            				if(objInvestmentAsset.TotalAsset__c != objApprovePlan.Amount__c)
            				{
            					isAmountChanged = true;
            					changedAmountSchemeName = objInvestmentAsset.Scheme_Name_Text__c;
		            			oldInvestmentAssetAmount = objApprovePlan.Amount__c;
		     					changedInvestmentAssetAmount = objInvestmentAsset.TotalAsset__c;
		     					actionAmountToBeChanged = objApprovePlan.Action_Amount__c;
            				}
            			}
           		 	}
		            assetClass = objInvestmentAsset.Asset_Type__c;
		            if(objApprovePlan.Account__r.LastName == null)
	                {
	                  owner = objApprovePlan.Account__r.FirstName;
	                }
	                else if(objApprovePlan.Account__r.FirstName == null )
	                {
	                  owner = objApprovePlan.Account__r.LastName;
	                }
	                else if(objApprovePlan.Account__r.LastName != null && objApprovePlan.Account__r.FirstName != null)
	                {
	                  owner = objApprovePlan.Account__r.FirstName +' '+ objApprovePlan.Account__r.LastName;
	                }
	                else
	                {
	                  owner = '';
	                }
		            account = objApprovePlan.Account__c;
		            schemeName = objInvestmentAsset.Scheme_Name_Text__c;
		            execTracker = objApprovePlan.isExecutionTracker__c;
		            SIPexecTracker = objApprovePlan.isSIPexecutionTracker__c; 
		            currentSIP = objInvestmentAsset.Monthly_SIP_Amount__c;
		            SIPaction = objApprovePlan.SIP_Action__c;
		            isNewMutualFund = objApprovePlan.isNewMutualFund__c;
		            executionTracker = execTracker ? 'Yes' : 'No';
		            SIPexecutionTracker = SIPexecTracker ? 'Yes' : 'No';
		            investmentId = idInvestment;
		            
		            isETCreated = objApprovePlan.isETCreated__c;
		            isMFsipETCreated = objApprovePlan.isMFsipETCreated__c;
		            //Added on:18/02/2013 : Aditi Satpute : AP changes
		            //mfLumpsumRemark = objApprovePlan.MF_LumpsumRemark__c;
		            //mfSIPRemark = objApprovePlan.MF_SIPRemark__c;
		            system.debug('******isETCreated********'+isETCreated);
		            system.debug('******amount********'+amount);
		            system.debug('*****objApprovePlan.Id******'+objApprovePlan.Id);
		            
		            if(objApprovePlan.isExecutionTracker__c == true || (objApprovePlan.isSIPexecutionTracker__c && objApprovePlan.Investment_Asset__c != null))
	    			{
	    				if(mapIdToExecutionTracker.containsKey(objApprovePlan.Id))
	    					lstET = mapIdToExecutionTracker.get(objApprovePlan.Id);
	    					system.debug('*********lstET*********'+lstET);
	    				//Ta assign last records assignToOps Status
	    				if(lstET.size() > 0)
	    				{
		    				for(Execution_Tracker__c obj : lstET)
		    				{
			    				//error.debugLog('-----obj------'+obj);
			    				system.debug('********in for loop*********'+lstET);
			    				if(obj.Type__c != null && obj.Type__c.equalsIgnoreCase('Lumpsum'))
				    			{
				    				 if(obj.Suggested_Amount__c == obj.Total_Remaining_Balance__c && obj.Application_Status__c != 'Closed')
										ETLumupsumStatus = Label.ET_NotExecuted; 
									 else if(obj.Suggested_Amount__c > obj.Total_Remaining_Balance__c  && obj.Application_Status__c != 'Closed')
								  	 	ETLumupsumStatus = Label.ET_PartiallyExecuted;
								  	 else if(obj.Total_Remaining_Balance__c == obj.Agreed_Amount__c && obj.Executed_Amount__c == obj.Agreed_Amount__c )
								  	 	ETLumupsumStatus = Label.ET_FullyExecuted;
				    			}
				    			else if(obj.Type__c != null && obj.Type__c.equalsIgnoreCase('SIP'))
				    			{
				    				 if(obj.Suggested_Amount__c == obj.Total_Remaining_Balance__c  && obj.Application_Status__c != 'Closed')
										ETSipStatus = Label.ET_NotExecuted; 
									 else if(obj.Suggested_Amount__c > obj.Total_Remaining_Balance__c  && obj.Application_Status__c != 'Closed')
								  	 	ETSipStatus = Label.ET_PartiallyExecuted;
								  	 else if(obj.Total_Remaining_Balance__c == obj.Agreed_Amount__c && obj.Executed_Amount__c == obj.Agreed_Amount__c )
								  	 	ETSipStatus = Label.ET_FullyExecuted;
				    			}
			    			}
			    			//error.debugLog('******ETLumupsumStatus***in Mutual Fund**if*'+ETLumupsumStatus);
	    				}
	    				else
	    				{
	    					ETLumupsumStatus = Label.ET_NotCreated;
	    					//error.debugLog('******ETLumupsumStatus***in Mutual Fund**else*'+ETLumupsumStatus);
	    				}	
		    			
	    			}
		            //error.debugLog('****ETLumupsumStatus****'+ETLumupsumStatus); 
		            objCurrentMutualFunds = approvedPlanBean.populateCurrentMutualFunds
		                                (schemeName, assetClass, amount,owner, account, 
		                                 lumpsumAction, actionAmount,execTracker,investmentId,
		                                 executionTracker,isNewMutualFund, 
		                                 --newCount,isETCreated,isMFsipETCreated,
		                                 objApprovePlan.id,ETLumupsumStatus);
	               	system.debug('****objCurrentMutualFunds****'+objCurrentMutualFunds);                    
		            lstCurrentMutualFunds.add(objCurrentMutualFunds);
            		system.debug('****ETSipStatus****'+ETSipStatus); 
		            if(currentSIP != null && !isNewMutualFund  && currentSIP > 0)
		            {
	              		objCurrentMutualFunds = approvedPlanBean.populateSIPCurrentMutualFunds
	                                (schemeName, assetClass,amount,owner, account,
	                                 lumpsumAction, actionAmount, SIPactionAmount,
	                                 execTracker,SIPexecTracker,investmentId,
	                                 executionTracker,SIPexecutionTracker,currentSIP,
	                                 SIPaction, isNewMutualFund,isETCreated,isMFsipETCreated,ETSipStatus);
		            }            
          		}
        	}
       	 	else
        	{
		         actionAmount = 0;
		          //Commented on:18/02/2013 : Aditi Satpute : AP changes
		          //lumpsumAction = 'Hold - Change of broker';
		          //Added on:18/02/2013 : Aditi Satpute : AP changes
		          lumpsumAction = '';
		          amount = objInvestmentAsset.TotalAsset__c;
		          assetClass = objInvestmentAsset.Asset_Type__c;
		          account = objInvestmentAsset.Entity__c;
		          if(objInvestmentAsset.Entity__r.LastName == null)
	              {
	                	owner = objInvestmentAsset.Entity__r.FirstName;
	              }
	              else if(objInvestmentAsset.Entity__r.FirstName == null )
	              {
	                	owner = objInvestmentAsset.Entity__r.LastName;
	              }
	              else if(objInvestmentAsset.Entity__r.LastName != null && objInvestmentAsset.Entity__r.FirstName != null)
	              {
	                	owner = objInvestmentAsset.Entity__r.FirstName +' '+ objInvestmentAsset.Entity__r.LastName;
	              }
	              else
	              {
	                	owner = '';
	              }
		          schemeName = objInvestmentAsset.Scheme_Name_Text__c;
		          SIPactionAmount = 0;
		          currentSIP = objInvestmentAsset.Monthly_SIP_Amount__c;
		          SIPaction = 'Continue';
		          execTracker = false;
		          executionTracker = 'No';
		          SIPexecTracker = false;
		          SIPexecutionTracker = 'No';
		          investmentId = idInvestment;
		          objCurrentMutualFunds = approvedPlanBean.populateCurrentMutualFunds
		                              (schemeName, assetClass, 
		                               amount,owner, account, 
		                               lumpsumAction, actionAmount,
		                               execTracker,investmentId,
		                               executionTracker,false, 0,false,false,'',ETLumupsumStatus);
		          lstCurrentMutualFunds.add(objCurrentMutualFunds);        
		                       
		          if(currentSIP != null  && !isNewMutualFund  && currentSIP > 0)
		          {
		          		SIPexecTracker = false;
		          		SIPexecutionTracker = 'No';
		            	objCurrentMutualFunds = approvedPlanBean.populateSIPCurrentMutualFunds
		                              (schemeName, assetClass,
		                               amount,owner, account,
		                               lumpsumAction, actionAmount, SIPactionAmount,
		                               execTracker,SIPexecTracker,investmentId,
		                               executionTracker,SIPexecutionTracker,currentSIP,
		                               SIPaction,false,false,false,ETSipStatus);
          
		          }
		          //lstMFsip.add(objCurrentMutualFundsSIP);
		          //lstCurrentMutualFunds.add(objCurrentMutualFundsSIP);
			}
	        system.debug('*****lstCurrentMutualFunds*******'+lstCurrentMutualFunds);
	        system.debug('*****lstMFsip.size()*******'+lstMFsip.size());
	        
	        if(!mapIdToInnerClass.containsKey(idInvestment))
	        {
	          mapIdToInnerClass.put(idInvestment,lstCurrentMutualFunds);
	        }
	        system.debug('******mapIdToInnerClass*******'+mapIdToInnerClass);
	        system.debug('******mapIdToInnerClass.size()*******'+mapIdToInnerClass.size());
	        approvedPlanBean.mapIdToCurrentFunds = mapIdToInnerClass ;
        
       }
       if(isAmountChanged)
       {
       		if(actionAmountToBeChanged > 0 && actionAmountToBeChanged != null)
       		{
	        	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.Warning,'There is change in Amount of Investment Assets Mutual Fund record of "'
	        	+changedAmountSchemeName+ '" from "'+oldInvestmentAssetAmount+'" to "'+changedInvestmentAssetAmount
	        	+'" after saving Action Plan. Please reallocate the Action Amount'));
	        	return;
       		}
       		else
       		{
       			ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.INFO,'There is change in Amount of Investment Assets Mutual Fund record of "'
	        	+changedAmountSchemeName+ '" from "'+oldInvestmentAssetAmount+'" to "'+changedInvestmentAssetAmount
	        	+'" after saving Action Plan.'));
	        	return;
       		}
       }
    }
    
    
    /**
    * @Description: Retrieve the Recommended Insurances of New Action Plan
    * param: ApprovedPlanBean 
    * return type: None 
    */ 
    public void getRecommendedInsurances(ApprovedPlanBean approvedPlanBean,Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    											Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan)
    {
        List<Insurance__c> insuranceList = dbSOQLObj.getInsuranceListByRecordTypeForIncludeActionPlan(approvedPlanBean.entityId);
        ApprovedPlanBean.RecommendedInsurance objRecommendedInsurance = new ApprovedPlanBean.RecommendedInsurance();
        Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
        Map<Id,Approve_Action_Plan__c> mapIdToApprovePlan = new Map<Id,Approve_Action_Plan__c>();
        Account objAcc = new Account();
        List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>();
        
        Map<Id,Account> mapIdToAccount = new Map<Id,Account>([select Id,Name,LastName,FirstName from Account]);
        //Added on : 02/04/13 : Aditi Satpute : Purpose - need to save execution tracker details for this section : ET Screen Changes
        /*List<Approve_Action_Plan__c> lstApproveActionPlan = [Select  Transaction_Type__c, Action_Amount__c, Insurance__c, Remarks__c, Scheme_Name__c, Goal__c , Asset_Class__c, 
                                     isInsuranceExecutionTracker__c,Amount__c, Investment_Asset__c, isSIPexecutionTracker__c, isETcreated__c,
                                     Fund__c, Lumpsum_Action__c,SIP_Action_Amount__c,Amount_Per_Installment__c, SIP_Action__c, Product_Name__c, 
                                      Account__c, Option__c,  isExecutionTracker__c ,Installments__c,  Account__r.FirstName, CreatedDate, 
                                     Account__r.LastName,Category__c,Insured__c, Policy_Type__c,Sum_Assured_Rs__c,Premium_Amount_Rs__c
                                   From Approve_Action_Plan__c
                                   where  Account__c IN: familyIdSet and  Item_Type__c = : Label.Surrender_Insurance 
                                   and AP_Status__c = 'Opened'];*/
        
         List<Approve_Action_Plan__c> lstApproveActionPlan = new List<Approve_Action_Plan__c>();
         if(mapIdTolstActionPlan.containsKey(Label.Surrender_Insurance))
	   	 {
		      lstApproveActionPlan = mapIdTolstActionPlan.get(Label.Surrender_Insurance);
   		 } 
         
         for(Approve_Action_Plan__c objApproveActionPlan : lstApproveActionPlan )
         {
            if(!mapIdToApprovePlan.containsKey(objApproveActionPlan.Insurance__c))
            {
              	mapIdToApprovePlan.put(objApproveActionPlan.Insurance__c,objApproveActionPlan);
          	}
         }
        
        
        for(Insurance__c objInsurance : insuranceList)
        {
            String insured = '';
            String nominee = '';
            String insuranceCompany = '';
            String policyType = '';
            String policyName = '';
            String policyNumber = ''; 
            Date commencementDate;
            Date nextPremiumDueDate; 
            double deathBenefitRs = 0;
            double premiumAmountRs = 0;
            String premiumPaymentFrequency = '';
            double tenureofInsurance = 0;
            double premiumPayingTerm = 0;
            double surrenderCashValue = 0;
            double currentAmount = 0;
            double maturityAmount = 0;
            String action = '';
            Boolean execTracker = false;
            String executionTracker = '';
            String insuranceId = '';
            Boolean isETCreated = false;
            String recommendedInsuranceActionPlanId = '';
            String ETStatus = Label.ET_NotCreated;
            
           if(mapIdToAccount.containsKey(objInsurance.Nominee__c))
           {
               objAcc = mapIdToAccount.get(objInsurance.Nominee__c);
               nominee = objAcc.Name;
           }
          
           insured = objInsurance.Entity__r.Name;
           insuranceCompany = objInsurance.Insurance_Company__c;
           policyType = objInsurance.Policy_Type__c;
           policyName = objInsurance.Policy_Name__c;
           policyNumber = objInsurance.Policy_Number__c;
           commencementDate = objInsurance.Commencement_Date__c;
           nextPremiumDueDate = objInsurance.Next_Premium_Due_Date__c;
           deathBenefitRs = objInsurance.Death_Benefit_Rs__c;
           premiumAmountRs = objInsurance.Premium_Amount_Rs__c;
           premiumPaymentFrequency = objInsurance.Premium_Frequency__c;
           tenureofInsurance = objInsurance.Tenure_of_Insurance__c;
           premiumPayingTerm = objInsurance.Premium_Paying_Term__c;
           surrenderCashValue = objInsurance.Surrender_Cash_Value__c;
           currentAmount = objInsurance.Current_Amount__c;
           maturityAmount = objInsurance.Maturity_Amount__c;
           /* Prajakta - FP changes - 13-03-2013 */ 
           if(objInsurance.Maturity_Amount__c != null && objInsurance.Revised_Maturity_Amount__c == 0)
               maturityAmount = objInsurance.Maturity_Amount__c;
           else
               maturityAmount = objInsurance.Revised_Maturity_Amount__c;
           action = objInsurance.Action__c;
           //Added on : 02/04/13 : Aditi Satpute : Purpose - need to save execution tracker details for this section : ET Screen Changes
           if(mapIdToApprovePlan.containsKey(objInsurance.Id))
           {
               	objApprovePlan = mapIdToApprovePlan.get(objInsurance.Id);
               	if(mapIdToExecutionTracker.containsKey(objApprovePlan.Id))
		  	   	{
				   	lstET = mapIdToExecutionTracker.get(objApprovePlan.Id);
				   	for(Execution_Tracker__c objET : lstET)
				   	{
				   		if(objET.Type__c.equalsIgnoreCase(Label.Surrender_Insurance) && objET.Type__c != null)
				   		{
				   			if(objET.Application_Status__c != 'Closed')
							  	ETStatus = Label.ET_NotExecuted; 
					 	  	else 
						  	  	ETStatus = Label.ET_FullyExecuted;
				   		}
				   		else
				   		{
					   		if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
							  	ETStatus = Label.ET_NotExecuted; 
					 	  	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
						  	  	ETStatus = Label.ET_PartiallyExecuted;
					  	  	else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
						  	  	ETStatus = Label.ET_FullyExecuted;
				   		}
				   	}
				}	
            	execTracker = objApprovePlan.isInsuranceExecutionTracker__c;
               	executionTracker = execTracker ? 'Yes' : 'No';
               	isETCreated = objApprovePlan.isETcreated__c;
               	recommendedInsuranceActionPlanId = objApprovePlan.Id;
           }
           else
           { 
		        /*if((action == 'To be grown till maturity but stop saving more') || (action == 'Liquidate (Align to goal)')) 
		        {
		          execTracker = false;
		                   executionTracker = 'Yes';
		        }   
		        else
		        {    
		           execTracker = true;
		                 executionTracker = 'No';
		        } */     
		        execTracker = false;
                executionTracker = 'No';
		        isETCreated = false;
		        recommendedInsuranceActionPlanId = '';
           }
           insuranceId = objInsurance.Id;
           //Added 3 extra parameters
           objRecommendedInsurance = approvedPlanBean.populateRecommendedInsurance (insured,nominee,insuranceCompany,policyType,policyName,
                        policyNumber,commencementDate,nextPremiumDueDate,deathBenefitRs,premiumAmountRs,premiumPaymentFrequency,tenureofInsurance,
                        premiumPayingTerm,surrenderCashValue,currentAmount,maturityAmount,action,executionTracker,execTracker,insuranceId,
                        isETCreated,recommendedInsuranceActionPlanId,ETStatus);
        }
    }
    /**
    * @Description: Retrieve all Goal Related Details of New Action Plan
    * param: ApprovedPlanBean & List<Goal__c>
    * return type: None 
    */ 
    public void getGoalAssetAllocation(ApprovedPlanBean approvedPlanBean, List<Goal__c> goalList, 
    									Set<Id> familyIdSet,Map<Id,List<Execution_Tracker__c>> mapIdToExecutionTracker,
    									map<String, set<String>> mapMutualFundTosetProducts,
    									Map<String,List<Approve_Action_Plan__c>> mapIdTolstActionPlan,Account objAccount)
    {
            
        ApprovedPlanBean.GoalDetails objActionPlanGoalDetails = new ApprovedPlanBean.GoalDetails();
        ApprovedPlanBean.GoalDetails objEmergencyLumpsumActionPlanGoalDetails = new ApprovedPlanBean.GoalDetails();
        ApprovedPlanBean.AllocatedAssets objActionPlanAllocatedAssets = new ApprovedPlanBean.AllocatedAssets();
        //ApprovedPlanBean.UnAllocatedAssets objUnAllocatedAssets = new ApprovedPlanBean.UnAllocatedAssets();
   
        List<Insurance__c> insuranceList = dbSOQLObj.getInsuranceListByRecordType(approvedPlanBean.entityId);
        List<Investment_asset__c> investmentList = dbSOQLObj.getInvestmentAsset(approvedPlanBean.entityId,true);
        List<Asset__c>assetList = dbSOQLObj.getAssets(approvedPlanBean.entityId);
        Entity_Global_Assumption__c globalAssumptions = dbSOQLObj.getEntityGlobalAssumption(approvedPlanBean.entityId);
      
        List<GoalAssetAssociation__c> goalAssetAssociationList;
        List<GoalAssetAssociation__c> lstGoalAssetAssociation;
     
        List<GoalInsuranceAssociation__c> goalInsuranceAssociationList; 
        List<GoalInsuranceAssociation__c> lstGoalInsuranceAssociation;
      
       	List<GoalInvestmentAssetAssociation__c> goalInvestmentAssetAssociationList; 
        List<GoalInvestmentAssetAssociation__c> lstGoalInvestmentAssetAssociation;
        
       	goalAssetAssociationList = new List<GoalAssetAssociation__c>();
     	goalInsuranceAssociationList = new List<GoalInsuranceAssociation__c>(); 
     	goalInvestmentAssetAssociationList = new  List<GoalInvestmentAssetAssociation__c>();
     //==============================================================================================
       
        
     //===========AssetAssociation============================================================================================================
        Map<ID,List<GoalAssetAssociation__c>> goalAssetMappingMap = new Map<ID,List<GoalAssetAssociation__c>>();
        String entityId = approvedPlanBean.entityId;
        system.debug('--objAccount-'+objAccount);
        /**View State Issue : Account objAccount = dbSOQLObj.getEntity(entityId);*/
        //Query which returns all Allocated Goal Assets (Only assets, Not investment and insurance) 
        goalAssetAssociationList = dbSOQLObj.getGoalAssetAllocationList(entityId);
        
        //Map to store all AssetId's and its allocations 
        Map<String,Double> Assetpercentage = new Map<String,Double>(); 
        
        for(GoalAssetAssociation__c gaObj: goalAssetAssociationList)
        {
          //Assetpercentage returns a map of AssetId to Sum of particular Asset allocated to different goals
            if(Assetpercentage.containsKey(gaObj.asset__c))
            {
              Double dblPercentage = 0;
              if(Assetpercentage.get(gaObj.asset__c) != null)
                dblPercentage = Assetpercentage.get(gaObj.asset__c);
              Assetpercentage.put(gaObj.asset__c,dblPercentage + gaObj.allocated__c);    //If same asset allocated for different goal, then it gets added to the first allocated percentage
            }
            else
            {
                Assetpercentage.put(gaObj.asset__c, gaObj.allocated__c);          //If asset allocated for some goal
            }
            
        }
        
      	double allocatedAmountAsset = 0;
      	string strType = '';
      	String strAssetDescription = '';
        String entityName = '';
	    //goalAssetMappingMap returns map of GoalId to different assets allocated for particular goal
	    for(GoalAssetAssociation__c goalAssetAssociation : goalAssetAssociationList)
      	{
        	List<GoalAssetAssociation__c> lstGoalAsset = new List<GoalAssetAssociation__c>(); 
          	if(goalAssetMappingMap.containsKey(goalAssetAssociation.Goal__c))
          	{
	            lstGoalAsset = goalAssetMappingMap.get(goalAssetAssociation.Goal__c);
	            lstGoalAsset.add(goalAssetAssociation);
          	}
          	else
            	lstGoalAsset.add(goalAssetAssociation);
            
          	goalAssetMappingMap.put(goalAssetAssociation.Goal__c,lstGoalAsset);
      	}
      
      	//For unallocated assets only
      	for(Asset__c objAssets : assetList)
      	{
        	if(Assetpercentage.containsKey(objAssets.Id))
            {
            	if(objAssets.Action__c != '---None----')
            	{
	              	allocatedAmountAsset = Assetpercentage.get(objAssets.Id);
	              	if(objAssets.RecordType.Name == 'Govt. Saving Schemes' ||
	               		objAssets.RecordType.Name == 'Retirement Accounts'|| 
	           			objAssets.RecordType.Name == 'Deposits With Bank')
	              	{
	                	strAssetDescription = (objAssets.RecordType.Name == 'Deposits With Bank') ? 
	                      ((objAssets.Bank_Name__c != null) ? (objAssets.Bank_Name__c + ' - ' + objAssets.Account_Number__c)
	                       : (objAssets.Account_Number__c)) : (objAssets.Account_Number__c);
	              	}
	              	else
	                	strAssetDescription = (objAssets.Description__c);
	                entityName = objAssets.Entity__r.FirstName +' '+ objAssets.Entity__r.LastName;   
	              	if(objAssets.Asset_Types__c!=null && objAssets.Asset_Types__c!='')
	              	{
	                  	strType = objAssets.Asset_Types__c;
	                }
	                else
	                {
	                    strType = objAssets.Account_Type__c;
	                }
	              	if(objAssets.Monthly_Asset__c != null && allocatedAmountAsset < 100)
	              	{
	                	double CurrentValue = 0.0;
	                	CurrentValue = objAssets.Monthly_Asset__c;
	                	double remainingBalance = 0;
	                	if(CurrentValue != null)
	                	{
	                  		allocatedAmountAsset = (CurrentValue * allocatedAmountAsset) / 100;
	                  		remainingBalance = CurrentValue - allocatedAmountAsset;
	                	}
		                else
		                  	remainingBalance = 0;
		            /*    if(Math.floor(remainingBalance) > 0)
                        	objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strType,strAssetDescription,CurrentValue,remainingBalance);
                        	
                        	
                     */   	
                  	}       
            	}
            }
            /*--------------------------Prajakta - Displaying 100% Unallocated asset - 6/8/2013-------------------------------------------*/
            else if(objAssets.Allocated_Amount__c == 0.0)
      		{
      			if(objAssets.Action__c == '---None----')
      			{
	      			//allocatedAmountAsset = Assetpercentage.get(objAssets.Id);
	              	if(objAssets.RecordType.Name == 'Govt. Saving Schemes' ||
	               		objAssets.RecordType.Name == 'Retirement Accounts'|| 
	           			objAssets.RecordType.Name == 'Deposits With Bank')
	              	{
	                	strAssetDescription = (objAssets.RecordType.Name == 'Deposits With Bank') ? 
	                      ((objAssets.Bank_Name__c != null) ? (objAssets.Bank_Name__c + ' - ' + objAssets.Account_Number__c)
	                       : (objAssets.Account_Number__c)) : (objAssets.Account_Number__c);
	              	}
	              	else
	                	strAssetDescription = (objAssets.Description__c);
	                	
	                entityName = objAssets.Entity__r.FirstName +' '+ objAssets.Entity__r.LastName;
	                                
	              	if(objAssets.Asset_Types__c!=null && objAssets.Asset_Types__c!='')
	              	{
	                  	strType = objAssets.Asset_Types__c;
	                }
	                else
	                {
	                    strType = objAssets.Account_Type__c;
	                }
	              	if(objAssets.Monthly_Asset__c != null)
	              	{
	                	double CurrentValue = 0.0;
	                	CurrentValue = objAssets.Monthly_Asset__c;
	                	double remainingBalance = 0;
	                	if(CurrentValue != null)
	                	{
	                  		allocatedAmountAsset = 0.0;
	                  		remainingBalance = CurrentValue - allocatedAmountAsset;
	                	}
		                else
		                  remainingBalance = 0;
		             /*    if(Math.floor(remainingBalance) > 0)
                        	objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strType,strAssetDescription,CurrentValue,remainingBalance);
                        	
                     */
                        	
                  	}
      			}
      		}
      }

   //===========InvestmentAssets============================================================================================================      
       String strInvestmentType = '';
       double CurrentTotalValue = 0;
       double amountAllocatedInvestment = 0;
       double allocatedAmt = 0;
       double CurrentValue;
       double allocatedAmountInvestment=0;
       string strInvestmentDescription = '';
       double availableAmount = 0; 
       double balanceRemaining = 0;
	   entityName = '';	
		
       Map<ID,List<GoalInvestmentAssetAssociation__c>> goalInvestmentAssetMappingMap = new Map<ID,List<GoalInvestmentAssetAssociation__c>>();
       goalInvestmentAssetAssociationList = dbSOQLObj.getGoalInvestmentAssociationList(entityId);
       Map<String,List<Investment_Asset__c>> mapNameToInvestment = new Map<String,List<Investment_Asset__c>>();
       Integer i = 0;
       List<Investment_Asset__c> lstInvestment = new List<Investment_Asset__c>();

      //Assetpercentage map returns Investment_assetId vs particular InvestmentAsset aalocated for diff goals 
      for(GoalInvestmentAssetAssociation__c giObj: goalInvestmentAssetAssociationList)
      {
            if(Assetpercentage.containsKey(giObj.Investment_asset__c))
             { 
               Double dblPercentage = 0;
               if(Assetpercentage.get(giObj.Investment_asset__c) != null)
                 dblPercentage = Assetpercentage.get(giObj.Investment_asset__c);        //IA : Investment Asset
               Assetpercentage.put(giObj.Investment_asset__c,dblPercentage + giObj.allocated__c);  //If IA id is already present in map then sum up all the percentage allocated for diff goals
             }
             else
             {
                 Assetpercentage.put(giObj.Investment_asset__c, giObj.allocated__c);    //If IA Id is not present in the map, put it in the map
             }
        }    
       
      //goalInvestmentAssetMappingMap map returns GoalId vs different IA allocated for the same goal
      	for(GoalInvestmentAssetAssociation__c goalInvestmentAssetAssociation : goalInvestmentAssetAssociationList) 
      	{
          	List<GoalInvestmentAssetAssociation__c> lstInvestmentAssetAssociation = new List<GoalInvestmentAssetAssociation__c>();
          	if(goalInvestmentAssetMappingMap.containsKey(goalInvestmentAssetAssociation.Goal__c)) 
          	{
              	lstInvestmentAssetAssociation = goalInvestmentAssetMappingMap.get(goalInvestmentAssetAssociation.Goal__c);
                lstInvestmentAssetAssociation.add(goalInvestmentAssetAssociation);
          	}
          	else
            	lstInvestmentAssetAssociation.add(goalInvestmentAssetAssociation);
          	goalInvestmentAssetMappingMap.put(goalInvestmentAssetAssociation.Goal__c,lstInvestmentAssetAssociation);       
    	} 
    
        List<Investment_Asset__c>   lstInvestmentAsset = new List<Investment_Asset__c>();
        for(Investment_Asset__c objInvestment : investmentList)
        {
        	strInvestmentType = objInvestment.RecordType.Name;
        	if(Assetpercentage.containsKey(objInvestment.Id))
          	{
          		if(objInvestment.Action__c != '---None----')
          		{
                  	allocatedAmountInvestment = Assetpercentage.get(objInvestment.Id);
            		if(strInvestmentType == 'Fixed Income')
              		{
                    	CurrentValue = objInvestment.TotalAsset__c ;
                    	CurrentTotalValue = CurrentTotalValue + CurrentValue;
                    	amountAllocatedInvestment = (CurrentValue *  allocatedAmountInvestment)/100;
                    	entityName = objInvestment.Entity__r.FirstName +' '+ objInvestment.Entity__r.LastName;
                    	//Prajakta - FP changes - 25-02-2013
                    	if(objInvestment.Maturity_Date__c != null)
                    	{
                   	 		Datetime dtReport = objInvestment.Maturity_Date__c;
                    		String strDate = '';
                    		if(dtReport != null)
                  				strDate = dtReport.day() + '-' + dtReport.month() + '-' + dtReport.year();
                    		strInvestmentDescription = objInvestment.Description__c + ' -- ' + strDate; 
                    	}
                    	else
                    	{
                    		strInvestmentDescription = objInvestment.Description__c;
                    	}
                    	
                    	//strInvestmentDescription = '-';        
                       	if(CurrentValue != null)
                      		balanceRemaining = CurrentValue - amountAllocatedInvestment;
                		else
                      		balanceRemaining = 0;
                  	 /*	if(Math.floor(balanceRemaining) > 0 && allocatedAmountInvestment < 100)
                          	objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strInvestmentType,strInvestmentDescription,CurrentValue,balanceRemaining);
                          	
                     */     	
              		}       
                  	else
              		{
                	//Key is created to uniquely identify stocks and mutual fund of entity and its family members
                  		if(mapNameToInvestment.containsKey(objInvestment.Entity__r.FirstName + ' ' + objInvestment.Entity__r.LastName + objInvestment.RecordType.Name))
                  		{
	                     	List<Investment_Asset__c> lstRelatedInvAsset = new List<Investment_Asset__c>(); 
	                     	lstRelatedInvAsset = mapNameToInvestment.get(objInvestment.Entity__r.FirstName +' '+ objInvestment.Entity__r.LastName + objInvestment.RecordType.Name);
	                     	lstRelatedInvAsset.add(objInvestment);
	                     	mapNameToInvestment.put(objInvestment.Entity__r.FirstName +' '+ objInvestment.Entity__r.LastName + objInvestment.RecordType.Name,lstRelatedInvAsset);
                  		}
                  		else
                  		{
                     		List<Investment_Asset__c> lstRelatedInvAsset = new List<Investment_Asset__c>();
                     		lstRelatedInvAsset.add(objInvestment);
                     		mapNameToInvestment.put(objInvestment.Entity__r.FirstName + ' ' + objInvestment.Entity__r.LastName + objInvestment.RecordType.Name,lstRelatedInvAsset);
                  		}
              		}
          		}
        	}
        	/*--------------------------Prajakta - Displaying 100% Unallocated investment asset - 6/8/2013-------------------------------------------*/
        	else if(objInvestment.Allocated_Amount__c == 0.0)
        	{
        		system.debug('*****11111111 :  ');
        		if(objInvestment.Action__c == '---None----')
          		{
          			system.debug('*****2222222222 :  ');
                  	//allocatedAmountInvestment = Assetpercentage.get(objInvestment.Id);
            		if(strInvestmentType == 'Fixed Income')
              		{
                    	CurrentValue = objInvestment.TotalAsset__c ;
                    	CurrentTotalValue = CurrentTotalValue + CurrentValue;
                    	//amountAllocatedInvestment = (CurrentValue *  allocatedAmountInvestment)/100;
                    	system.debug('*****CurrentTotalValue :  '+CurrentTotalValue);  
                    	//Prajakta - FP changes - 25-02-2013
                    	if(objInvestment.Maturity_Date__c != null)
                    	{
	                   	 	Datetime dtReport = objInvestment.Maturity_Date__c;
	                    	String strDate = '';
	                    	entityName = objInvestment.Entity__r.FirstName +' '+ objInvestment.Entity__r.LastName;
	                    	if(dtReport != null)
	                  			strDate = dtReport.day() + '-' + dtReport.month() + '-' + dtReport.year();
	                    	strInvestmentDescription = objInvestment.Description__c + ' -- ' + strDate; 
                    	}
                    	else
                    	{
                    		strInvestmentDescription = objInvestment.Description__c;
                    	}
                    	//strInvestmentDescription = '-';        
                       	if(CurrentValue != null)
                      		balanceRemaining = CurrentValue;
                		else
                      		balanceRemaining = 0;
                      	system.debug('*****balanceRemaining :  '+balanceRemaining);  
                  	/*	if(Math.floor(balanceRemaining) > 0)
                          	objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strInvestmentType,strInvestmentDescription,CurrentValue,balanceRemaining);
                    */      	
              		}       
                  	else
              		{
              			system.debug('*****in else----------- :  ');
                		//Key is created to uniquely identify stocks and mutual fund of entity and its family members
                  		if(mapNameToInvestment.containsKey(objInvestment.Entity__r.FirstName + ' ' + objInvestment.Entity__r.LastName + objInvestment.RecordType.Name))
                  		{
	                     	List<Investment_Asset__c> lstRelatedInvAsset = new List<Investment_Asset__c>(); 
	                     	lstRelatedInvAsset = mapNameToInvestment.get(objInvestment.Entity__r.FirstName +' '+ objInvestment.Entity__r.LastName + objInvestment.RecordType.Name);
	                     	lstRelatedInvAsset.add(objInvestment);
	                     	mapNameToInvestment.put(objInvestment.Entity__r.FirstName +' '+ objInvestment.Entity__r.LastName + objInvestment.RecordType.Name,lstRelatedInvAsset);
                  		}
                  		else
                  		{
                     		List<Investment_Asset__c> lstRelatedInvAsset = new List<Investment_Asset__c>();
                     		lstRelatedInvAsset.add(objInvestment);
                     		mapNameToInvestment.put(objInvestment.Entity__r.FirstName + ' ' + objInvestment.Entity__r.LastName + objInvestment.RecordType.Name,lstRelatedInvAsset);
                  		}
              		}
          		}
        	}
            system.debug('*****objInvestment :  '+objInvestment);  
            //system.debug('*****mapNameToInvestment :  '+mapNameToInvestment.values());    
        }
        Integer temp = 0 ;
        for(String strEntityName : mapNameToInvestment.keySet())
        {      
           	system.debug('*****strEntityName :  '+strEntityName);    
           	CurrentValue = 0;
           	CurrentTotalValue = 0;
        	lstInvestmentAsset = mapNameToInvestment.get(strEntityName);
        
        	for(Investment_Asset__c objInvest : lstInvestmentAsset)
        	{
          		system.debug('****objInvest*****'+objInvest);
          		strInvestmentDescription = '-';      
          		CurrentValue = objInvest.TotalAsset__c ;
          		entityName = objInvest.Entity__r.FirstName + ' ' + objInvest.Entity__r.LastName;
          		system.debug('****CurrentValue*****'+CurrentValue);
          		allocatedAmountInvestment = Assetpercentage.get(objInvest.Id);
          		CurrentTotalValue = CurrentTotalValue + CurrentValue;
          		system.debug('****CurrentTotalValue*****'+CurrentTotalValue);
          		system.debug('****allocatedAmountInvestment*in stock****'+allocatedAmountInvestment);
           		strInvestmentDescription = '-';        
          		strInvestmentType = objInvest.RecordType.Name;  
          		if(objInvest.Allocated_Amount__c != 0.0) 
         			amountAllocatedInvestment = (CurrentTotalValue *  allocatedAmountInvestment)/100;
         		else
         			amountAllocatedInvestment = 0.0;       
          	}
          	//amountAllocatedInvestment = (CurrentTotalValue *  allocatedAmountInvestment)/100;
          	if(CurrentTotalValue != null)
            	balanceRemaining = CurrentTotalValue - amountAllocatedInvestment;
        	else
            	balanceRemaining = 0;
        	system.debug('****balanceRemaining****Stock n Mutual**'+balanceRemaining);
         /* 	if((Math.floor(balanceRemaining)>0) && allocatedAmountInvestment < 100)
               objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strInvestmentType,strInvestmentDescription,CurrentTotalValue,balanceRemaining);
            else if(Math.floor(balanceRemaining) > 0)
              objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strInvestmentType,strInvestmentDescription,CurrentTotalValue,balanceRemaining);
         */     
         }  
       //============================================================================================   
       
       
  //===========Insurance============================================================================================================
        
        Map<ID,List<GoalInsuranceAssociation__c>> goalInsuranceMappingMap = new Map<ID,List<GoalInsuranceAssociation__c>>();
        
      	goalInsuranceAssociationList = dbSOQLObj.getGoalInsuranceAllocationList(entityId);
        double allocatedAmountInsurance = 0;
        double currentInsuranceValue = 0;
        double calculateAllocatedAmount = 0;
        double remainingInsuranceBalance = 0;
        string strInsuranceType = '';
        string strInsuranceDescription = '';
        entityName = '';
        
        //Assetpercentage map returns InsuranceId vs Particular insurance allocated for different goals
        for(GoalInsuranceAssociation__c ginObj: goalInsuranceAssociationList)
        {
            if(Assetpercentage.containsKey(ginObj.Insurance__c))
            {
              	Double dblPercentage = 0;
              	if(Assetpercentage.get(ginObj.Insurance__c) != null)
                	dblPercentage = Assetpercentage.get(ginObj.Insurance__c);
              	Assetpercentage.put(ginObj.Insurance__c,dblPercentage + ginObj.allocated__c);
            }
            else
            {
                Assetpercentage.put(ginObj.Insurance__c, ginObj.allocated__c);
            }
        }

    	//goalInsuranceMappingMap map returns different insurances allocated for particular goal
    	for(GoalInsuranceAssociation__c goalInsuranceAssociation : goalInsuranceAssociationList) 
    	{
	        List<GoalInsuranceAssociation__c> lstInsuranceAssociation = new List<GoalInsuranceAssociation__c>();
	        if(goalInsuranceMappingMap.containsKey(goalInsuranceAssociation.Goal__c)) 
	        {
	            lstInsuranceAssociation = goalInsuranceMappingMap.get(goalInsuranceAssociation.Goal__c);
	            lstInsuranceAssociation.add(goalInsuranceAssociation);
	        }
	        else
	          	lstInsuranceAssociation.add(goalInsuranceAssociation);
	        goalInsuranceMappingMap.put(goalInsuranceAssociation.Goal__c,lstInsuranceAssociation);       
    	} 
    	AssetAllocationService objAssetAllocation = new AssetAllocationService();
      
    	for(Insurance__c objInsurance : insuranceList)
	    {
	      	if(Assetpercentage.containsKey(objInsurance.Id))
	        {
	        	if(objInsurance.Action__c != '---None----')
	        	{
		          	if(objInsurance.Insurance_Company__c != null)
		        	{
		          		if(objInsurance.Policy_Name__c != null)
			          	{
				            strInsuranceDescription = objInsurance.Policy_Number__c != null ? 
				                      (objInsurance.Insurance_Company__c + ' -- ' + objInsurance.Policy_Name__c + ' -- ' + objInsurance.Policy_Number__c)
				                      :(objInsurance.Insurance_Company__c + ' -- ' + objInsurance.Policy_Name__c);
			          	}
		          		else
		           	 		strInsuranceDescription = objInsurance.Policy_Number__c != null ? 
		                       (objInsurance.Insurance_Company__c + ' -- ' + objInsurance.Policy_Number__c) : (objInsurance.Insurance_Company__c);
		        	}
			        else
			        {
			          	if(objInsurance.Policy_Name__c != null)
			            	strInsuranceDescription = objInsurance.Policy_Number__c != null ? 
			                        (objInsurance.Policy_Name__c + ' -- ' + objInsurance.Policy_Number__c) : objInsurance.Policy_Name__c;
			          	else if(objInsurance.Policy_Number__c != null)
			            	strInsuranceDescription = objInsurance.Policy_Number__c;
			        }
					
					entityName = objInsurance.Entity__r.FirstName +' '+ objInsurance.Entity__r.LastName;
		            strInsuranceType = objInsurance.Policy_Type__c;
		          	allocatedAmountInsurance = Assetpercentage.get(objInsurance.Id);
		          	Double dblOneInstallmentAmount = 0;
		            Integer iTenureOfInsurance = 0 ;
		            Integer iMaturityYear = 0;
		            //if(!objInsurance.Premium_Frequency__c.equals('One Time Premium'))
		            if(objInsurance.Premium_Amount_Rs__c != null)
		               dblOneInstallmentAmount = objInsurance.Premium_Amount_Rs__c;
		           
		         	if(objInsurance.Tenure_of_Insurance__c != null)
		             	iTenureOfInsurance = Integer.valueOf(objInsurance.Tenure_of_Insurance__c);
			     	iMaturityYear = iTenureOfInsurance + objInsurance.Commencement_Date__c.year();
			     	Integer iCurrentYearForCalculation = 0;
				     /* Aditi - FP changes - 04-03-2013 - Changed Date.Today() to Plan_Generation_Date__c*/
			 	 	Integer startYear = objAccount.Plan_Generation_Date__c != null ? objAccount.Plan_Generation_Date__c.year() : Date.today().year();
			     	if(startYear > iMaturityYear)
				       iCurrentYearForCalculation = iMaturityYear;
			     	else
		           		iCurrentYearForCalculation = startYear;
		         	Integer totalPeriodInYears =  iCurrentYearForCalculation - objInsurance.Commencement_Date__c.year();
		        
			        if(objInsurance.Surrender_Cash_Value__c == null)
			        {  
			          	currentInsuranceValue = objAssetAllocation.GetInsuranceAmountForPeriod(objInsurance,totalPeriodInYears, dblOneInstallmentAmount);
			        }  
			        else
			          currentInsuranceValue = objInsurance.Surrender_Cash_Value__c;
		          	calculateAllocatedAmount = (allocatedAmountInsurance * currentInsuranceValue)/100 ; 
		           
		         	if(currentInsuranceValue != null)
			            remainingInsuranceBalance= currentInsuranceValue - calculateAllocatedAmount;
		          	else
		            	remainingInsuranceBalance = 0;
		         /* 	if(Math.floor(remainingInsuranceBalance) > 0)
		        	{
		              	objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strInsuranceType,strInsuranceDescription,currentInsuranceValue,remainingInsuranceBalance);
		        	}
		        	*/
	        	}
		    }
		    /*--------------------------Prajakta - Displaying 100% Unallocated insurance - 6/8/2013-------------------------------------------*/
		    else 
		    {
		    	if(objInsurance.Action__c == '---None----')
		    	{
		      		if(objInsurance.Insurance_Company__c != null)
		        	{
		          		if(objInsurance.Policy_Name__c != null)
			          	{
				            strInsuranceDescription = objInsurance.Policy_Number__c != null ? 
				                      (objInsurance.Insurance_Company__c + ' -- ' + objInsurance.Policy_Name__c + ' -- ' + objInsurance.Policy_Number__c)
				                      :(objInsurance.Insurance_Company__c + ' -- ' + objInsurance.Policy_Name__c);
			          	}
		          		else
		           	 		strInsuranceDescription = objInsurance.Policy_Number__c != null ? 
		                       (objInsurance.Insurance_Company__c + ' -- ' + objInsurance.Policy_Number__c) : (objInsurance.Insurance_Company__c);
		        	}
			        else
			        {
			          	if(objInsurance.Policy_Name__c != null)
			            	strInsuranceDescription = objInsurance.Policy_Number__c != null ? 
			                        (objInsurance.Policy_Name__c + ' -- ' + objInsurance.Policy_Number__c) : objInsurance.Policy_Name__c;
			          	else if(objInsurance.Policy_Number__c != null)
			            	strInsuranceDescription = objInsurance.Policy_Number__c;
			        }
		
					entityName = objInsurance.Entity__r.FirstName +' '+ objInsurance.Entity__r.LastName;
		            strInsuranceType = objInsurance.Policy_Type__c;
		          	allocatedAmountInsurance = 0.0;
		          	Double dblOneInstallmentAmount = 0;
		            Integer iTenureOfInsurance = 0 ;
		            Integer iMaturityYear = 0;
		            //if(!objInsurance.Premium_Frequency__c.equals('One Time Premium'))
		            if(objInsurance.Premium_Amount_Rs__c != null)
		               dblOneInstallmentAmount = objInsurance.Premium_Amount_Rs__c;
		           
		         	if(objInsurance.Tenure_of_Insurance__c != null)
		             	iTenureOfInsurance = Integer.valueOf(objInsurance.Tenure_of_Insurance__c);
			     	iMaturityYear = iTenureOfInsurance + objInsurance.Commencement_Date__c.year();
			     	Integer iCurrentYearForCalculation = 0;
				     /* Aditi - FP changes - 04-03-2013 - Changed Date.Today() to Plan_Generation_Date__c*/
			 	 	Integer startYear = objAccount.Plan_Generation_Date__c != null ? objAccount.Plan_Generation_Date__c.year() : Date.today().year();
			     	if(startYear > iMaturityYear)
				       iCurrentYearForCalculation = iMaturityYear;
			     	else
		           		iCurrentYearForCalculation = startYear;
		         	Integer totalPeriodInYears =  iCurrentYearForCalculation - objInsurance.Commencement_Date__c.year();
		        
			        if(objInsurance.Surrender_Cash_Value__c == null)
			        {  
			          	currentInsuranceValue = objAssetAllocation.GetInsuranceAmountForPeriod(objInsurance,totalPeriodInYears, dblOneInstallmentAmount);
			        }  
			        else
			          currentInsuranceValue = objInsurance.Surrender_Cash_Value__c;
		          	
		          	calculateAllocatedAmount = currentInsuranceValue; 
		           
		         	if(currentInsuranceValue != null)
			            remainingInsuranceBalance = currentInsuranceValue;
		          	else
		            	remainingInsuranceBalance = 0;
		         /* 	if(Math.floor(remainingInsuranceBalance) > 0)
		        	{
		              	objUnAllocatedAssets =  approvedPlanBean.populateUnAllocatedAssets(entityName,strInsuranceType,strInsuranceDescription,currentInsuranceValue,remainingInsuranceBalance);
		        	}*/
		    	}
	      	}
	    }
    
       //======================================================================================================================================
       
      
 
      
       ///////////////SIP MANASI
       List<Id> golIds = new List<Id>();
        for(Goal__c golObj: goalList)
        {
            golIds.add(golObj.Id);
        }
        List<GoalSIPAmount__c> goalSips= [select Goal__c,Goal__r.SIP_Start_Year__c, Goal_Year__c, SIP_Debt__c, SIP_Equity__c, SIP_Gold__c, SIP_Total__c,
                          GoldCurrentYear__c,EquityCurrentYear__c,DebtCurrentYear__c
                                from GoalSIPAmount__c 
                                where SIP_Outflow__c = true AND
                                //Goal_Year__c =: system.today().year() and
                                Goal__c In: golIds and isNewSIP__c = true];
       // List<GoalSIPAmount__c> goalSips = dbSOQLObj.getGoalSIP(system.today().year(), golIds);
        Map<Id,GoalSIPAmount__c> goalIdVsGoalSIPAmount = new Map<Id,GoalSIPAmount__c>();
         
        for(GoalSIPAmount__c objGoalSIPAmount : goalSips)
        {
	        if(objGoalSIPAmount.Goal__r.SIP_Start_Year__c != null) 
	        {
          		if(Decimal.valueOf(objGoalSIPAmount.Goal__r.SIP_Start_Year__c) == objGoalSIPAmount.Goal_Year__c)
         		{
          			if(!goalIdVsGoalSIPAmount.containsKey(objGoalSIPAmount.Goal__c))
            			goalIdVsGoalSIPAmount.put(objGoalSIPAmount.Goal__c,objGoalSIPAmount);
         		}
	        }
            
        } 
        //////////////////////SIP Funds/
        List<Approve_Action_Plan__c> lstApprove_Action_Plan  = new List<Approve_Action_Plan__c>(); 
        /*List<Approve_Action_Plan__c> lstApprove_Action_Plan  = [Select  Transaction_Type__c, a.Remarks__c,a.Goal__c ,a.isSIPexecutionTracker__c ,a.Amount__c,a.Product_Name__c, 
                                    a.Option__c, a.Installments__c, a.CreatedDate, a.Category__c,isETcreated__c From Approve_Action_Plan__c a 
                                    where a.Account__c IN: familyIdSet and a.Item_Type__c = 'SIP' and AP_Status__c = 'Opened'];*/
                                    
        if(mapIdTolstActionPlan.containsKey('SIP'))
	    {
	    	lstApprove_Action_Plan = mapIdTolstActionPlan.get('SIP');
	    }  
	                                   
        Map<Id,List<Approve_Action_Plan__c>> mapGoalIdToAppActionPlan = new Map<Id,List<Approve_Action_Plan__c>>();
        for(Approve_Action_Plan__c objApproveActionPLan :lstApprove_Action_Plan )
        {
          lstApprove_Action_Plan = mapGoalIdToAppActionPlan.get(objApproveActionPLan.Goal__c);
          if(lstApprove_Action_Plan == null)
          {
            lstApprove_Action_Plan = new List<Approve_Action_Plan__c>();
            mapGoalIdToAppActionPlan.put(objApproveActionPLan.Goal__c,lstApprove_Action_Plan);
          }
          lstApprove_Action_Plan.add(objApproveActionPLan);
        }
        //LumpsumFunds==================================
        List<Approve_Action_Plan__c> lstLumpsumApproveActionPlan  = new List<Approve_Action_Plan__c>();
        /*List<Approve_Action_Plan__c> lstLumpsumApproveActionPlan  = [Select a.Transaction_Type__c, a.Remarks__c,a.Goal__c ,a.Goal__r.Description__c ,a.Lumpsum_Equity__c,
                                      a.Amount__c,a.Fund__c,a.Amount_Per_Installment__c,a.Product_Name__c,a.Lumpsum_Debt__c,a.isLumpsumExecTracker__c,
                                      a.Option__c, a.Installments__c, a.CreatedDate, a.Category__c ,a.Lumpsum_Gold__c,isETCreated__c ,a.Goal__r.Goal_Type__c 
                                      From Approve_Action_Plan__c a where a.Account__c IN: familyIdSet and a.Item_Type__c = 'Lumpsum'
                                      and AP_Status__c = 'Opened'];*/
        Map<Id,List<Approve_Action_Plan__c>> mapGoalIdToLumpsumAppActionPlan = new Map<Id,List<Approve_Action_Plan__c>>();
        Map<Id,List<Approve_Action_Plan__c>> mapGoalIdToEmergencyLumpsumAppActionPlan = new Map<Id,List<Approve_Action_Plan__c>>();
        if(mapIdTolstActionPlan.containsKey('Lumpsum'))
	    {
	    	lstLumpsumApproveActionPlan = mapIdTolstActionPlan.get('Lumpsum');
	    }  
        for(Approve_Action_Plan__c objApproveActionPLan :lstLumpsumApproveActionPlan)
        {
          //if(objApproveActionPLan.Goal__r.Description__c == 'Emergency Fund')
          if(objApproveActionPLan.Goal__r.Goal_Type__c == 'Emergency Fund')
          {
            lstLumpsumApproveActionPlan = mapGoalIdToEmergencyLumpsumAppActionPlan.get(objApproveActionPLan.Goal__c);
            if(lstLumpsumApproveActionPlan == null)
            {
              lstLumpsumApproveActionPlan = new List<Approve_Action_Plan__c>();
              mapGoalIdToEmergencyLumpsumAppActionPlan.put(objApproveActionPLan.Goal__c,lstLumpsumApproveActionPlan);
            }
            lstLumpsumApproveActionPlan.add(objApproveActionPLan);
            
          }
          else
          {
            lstLumpsumApproveActionPlan = mapGoalIdToLumpsumAppActionPlan.get(objApproveActionPLan.Goal__c);
            if(lstLumpsumApproveActionPlan == null)
            {
              lstLumpsumApproveActionPlan = new List<Approve_Action_Plan__c>();
              mapGoalIdToLumpsumAppActionPlan.put(objApproveActionPLan.Goal__c,lstLumpsumApproveActionPlan);
            }
            lstLumpsumApproveActionPlan.add(objApproveActionPLan);
          }
        }
        
        ///Lumpsum===================================================
         Map<id,List<Double>> goalIdVsListDoubleMap = new Map<id,List<Double>>(); 
    For(Goal__c objGoal : approvedPlanBean.goalList)
    {
      if(!goalIdVsListDoubleMap.containsKey(objGoal.id))
      {
        goalIdVsListDoubleMap.put(objGoal.id,new List<Double>{0,0,0});
      }
    }
    for(ApprovedPlanBean.DoneClass objDone : approvedPlanBean.suggestedLumpSum)
    {
      String className = objDone.className;
      List<Double> dblLumsumVals = objDone.golListVals;
      
      for(Integer iCount = 0; iCount < dblLumsumVals.size(); iCount++)
      {
        List<Double> lstLumpsumVals;
        Goal__c objGoal = approvedPlanBean.goalList.get(iCount);
        if(goalIdVsListDoubleMap.containsKey(objGoal.id))
        {
          system.debug('****dblLumsumVals******'+dblLumsumVals);
          if(className == 'Equity')
          {
            lstLumpsumVals = goalIdVsListDoubleMap.get(objGoal.id);
            lstLumpsumVals[0] = dblLumsumVals[iCount];
            goalIdVsListDoubleMap.put(objGoal.id,lstLumpsumVals);
          }
          else if(className == 'Debt')
          {
            lstLumpsumVals = goalIdVsListDoubleMap.get(objGoal.id);
            lstLumpsumVals[1] = dblLumsumVals[iCount];
            goalIdVsListDoubleMap.put(objGoal.id,lstLumpsumVals);
          }
          else if(className == 'Gold')
          {
            lstLumpsumVals = goalIdVsListDoubleMap.get(objGoal.id);
            lstLumpsumVals[2] = dblLumsumVals[iCount];
            goalIdVsListDoubleMap.put(objGoal.id,lstLumpsumVals);
          }
        }
      }
      
      
    }
        
        //=======================================================
       	Map<String,List<GoalInvestmentAssetAssociation__c>> mapNameToInvestmentAsset = new Map<String,List<GoalInvestmentAssetAssociation__c>>();
     	SIPSummaryTotal = 0;
     	/*List<Approve_Action_Plan__c> lstNewApproveActionPlan = [Select Id,AP_Status__c From Approve_Action_Plan__c  
                                          where Account__c IN: familyIdSet and AP_Status__c = 'Opened'];
         
         if(lstNewApproveActionPlan.isEmpty())
         {
           isNewSIP = true;
         }*/
         String strRemark = '';
         List<Remarks__c> lstRemark = [select Remark__c from Remarks__c where entity__c =:entityId and recordtype.Name=:'EmergencyPlanning' limit 1];
         if(!lstRemark.isEmpty())
         {
            for(Remarks__c obj : lstRemark)
       		{
         		strRemark = obj.Remark__c;
       		}
         }
     
        for(Goal__c goal: goalList) 
        { 
           	lstGoalAssetAssociation = new  List<GoalAssetAssociation__c>();
           	mapNameToInvestmentAsset = new Map<String,List<GoalInvestmentAssetAssociation__c>>();
         	GoalSIPAmount__c objGoalSIPAmount;
         	List<Execution_Tracker__c> lstET = new List<Execution_Tracker__c>();
           	lstGoalInsuranceAssociation = new List<GoalInsuranceAssociation__c>();
          	lstGoalInvestmentAssetAssociation = new List<GoalInvestmentAssetAssociation__c>();
          	List<Approve_Action_Plan__c> lstPlan = new List<Approve_Action_Plan__c>();
          	List<Approve_Action_Plan__c> lstPlanForLumpsum = new List<Approve_Action_Plan__c>();
          	Double installments=0;
          	String option ='';
          	String remarks = '';
          	String productName='' ;
          	String transactionType='';
          	String category='';
          	Double amount=0;
          	Double AssetsTotal = 0;
        	String ETStatus = Label.ET_NotCreated;
        	
            String description = goal.Description__c;
            system.debug('****description******'+description);
            String startYear = goal.Goal_Start_Year__c;
            String endYear = goal.Goal_End_Year__c;
            Double annualGoalCost = goal.Cost_of_Goal_Annual__c;
           // String goalProfile = goal.Description__c == 'Emergency Fund'? 'Conservative' : goal.SelectedGoalProfile__r.Name;
            String goalProfile = goal.Goal_Type__c == 'Emergency Fund'? 'Conservative' : goal.SelectedGoalProfile__r.Name;
            
            system.debug('****goalProfile******'+goalProfile);
            //String remark = goal.Description__c == 'Emergency Fund'? strRemark : goal.Remark__c;
            String remark = goal.Goal_Type__c == 'Emergency Fund'? strRemark : goal.Remark__c;
            String goalType = goal.Goal_Type__c;
             system.debug('****remark******'+remark);
            //SIP declaration
            String strEquityAmt;
            Double debtAmt = 0;
            Double SIP = 0;
             Double equityAmt = 0;
          Double goldAmt = 0;
          Double equityPerc = 0;
          Double debtPerc = 0;
          Double goldPerc = 0;
          Boolean execTracker = false;
          String executionTracker = '';
          Boolean sipETCreated = false;
          
          //Lumpsum declaration
          Double lumpsumDebtAmt = 0;
            Double lumpsum = 0;
             Double lumpsumEquityAmt = 0;
          Double lumpsumGoldAmt = 0;
          Double lumpsumEquityPerc = 0;
          Double lumpsumDebtPerc = 0;
          Double lumpsumGoldPerc = 0;
          
          //Lumpsum Funds declaration
          Double lumpsumInstallments=0;
          String lumpsumOption ='';
          String lumpsumRemarks = '';
          String lumpsumProductName='' ;
          String lumpsumTransactionType='';
          String lumpsumCategory='';
          Double lumpsumAmount=0;
          String lumpsumFund='';
          Double lumpsumAmountPerInstall=0;
          String lumpsumExecutionTracker = '';
          Boolean lumpsumExecTracker = false;
          Boolean lumpsumETCreated = false;
          
        /*  if(isNewSIP)
          {
              SIP = 0;
                equityAmt = 0;
                debtAmt = 0;
                goldAmt = 0;
                
              equityPerc = 0;
              debtPerc = 0;
              goldPerc = 0;
                
          } 
          else
          {*/
              if(goalIdVsGoalSIPAmount.containsKey(goal.Id))
              {
                
                  objGoalSIPAmount = goalIdVsGoalSIPAmount.get(goal.Id);
                  if(objGoalSIPAmount != null)
                  {
                    //strDebtAmt = string.valueOf(objGoalSIPAmount.SIP_Debt__c);
                    SIP = objGoalSIPAmount.SIP_Total__c;
                    equityAmt = objGoalSIPAmount.SIP_Equity__c;
                    debtAmt = objGoalSIPAmount.SIP_Debt__c;
                    goldAmt = objGoalSIPAmount.SIP_Gold__c;
                    if(SIP !=0)
                    {
                      equityPerc = (equityAmt * 100)/SIP;
                      debtPerc = (debtAmt * 100)/SIP;
                      goldPerc = (goldAmt * 100)/SIP;
                    }
                  }
              }
          //}
           //=========================Emergency Funds Lumpsum=======================
         List<Approve_Action_Plan__c> lstLumpsum = new  List<Approve_Action_Plan__c>();
        // if(goal.Description__c == 'Emergency Fund')
         if(goal.Goal_Type__c == 'Emergency Fund')
         {
             system.debug('**goal.Id : Emergency Fund ****'+goal.Id);
            if(mapGoalIdToEmergencyLumpsumAppActionPlan.containsKey(goal.Id))
            {
              lstLumpsum = mapGoalIdToEmergencyLumpsumAppActionPlan.get(goal.Id);
              for(Approve_Action_Plan__c objLumpsum : lstLumpsum)
              {
                if(objLumpsum.Lumpsum_Equity__c != null)
                {
                    lumpsumEquityAmt = objLumpsum.Lumpsum_Equity__c;
                    lumpsumDebtAmt = objLumpsum.Lumpsum_Debt__c;
                    lumpsumGoldAmt = objLumpsum.Lumpsum_Gold__c;
                    lumpsum = lumpsumEquityAmt+lumpsumDebtAmt+lumpsumGoldAmt;
                    if(lumpsum !=0)
                    {
                      lumpsumEquityPerc = (lumpsumEquityAmt * 100)/lumpsum;
                      lumpsumDebtPerc = (lumpsumDebtAmt * 100)/lumpsum;
                      lumpsumGoldPerc = (lumpsumGoldAmt * 100)/lumpsum;
                    }
                    objEmergencyLumpsumActionPlanGoalDetails = approvedPlanBean.populateEmergencyLumpsumDetails(goal.Id,lumpsumEquityAmt,
                                 lumpsumDebtAmt,lumpsumGoldAmt,lumpsum,lumpsumEquityPerc,lumpsumDebtPerc,lumpsumGoldPerc,objLumpsum.Id); 
                }
              }
            }
            else
            {
                  lumpsumEquityAmt = 0;
                  lumpsumDebtAmt = 0;
                  lumpsumGoldAmt = 0;
                  lumpsum = 0;
                  lumpsumEquityPerc = 0;
                  lumpsumDebtPerc = 0;
                  lumpsumGoldPerc = 0;
                  
                  objEmergencyLumpsumActionPlanGoalDetails = approvedPlanBean.populateEmergencyLumpsumDetails(goal.Id,lumpsumEquityAmt,
                             lumpsumDebtAmt,lumpsumGoldAmt,lumpsum,lumpsumEquityPerc,lumpsumDebtPerc,lumpsumGoldPerc,''); 
            }
           }
         
           //========================================================================
           //Lumpsum
           List<Double> objLumpsums = new List<Double>();
           if(goalIdVsListDoubleMap.containsKey(goal.Id))
           {
                objLumpsums = goalIdVsListDoubleMap.get(goal.Id);
                if(objLumpsums != null)
                {
                    lumpsumEquityAmt = objLumpsums[0];
                    lumpsumDebtAmt = objLumpsums[1];
                    lumpsumGoldAmt = objLumpsums[2];
                    lumpsum = lumpsumEquityAmt+lumpsumDebtAmt+lumpsumGoldAmt;
                    if(lumpsum !=0)
                    {
                      lumpsumEquityPerc = (lumpsumEquityAmt * 100)/lumpsum;
                      lumpsumDebtPerc = (lumpsumDebtAmt * 100)/lumpsum;
                      lumpsumGoldPerc = (lumpsumGoldAmt * 100)/lumpsum;
                    }
                }
            }
            
            
            objActionPlanGoalDetails = approvedPlanBean.populateGoalList (goal.IRR__c,goal.Id,description,startYear,endYear,
                                              annualGoalCost,goalProfile,remark,equityAmt,debtAmt,goldAmt,SIP,equityPerc,debtPerc,goldPerc,lumpsumEquityAmt,
                                              lumpsumDebtAmt,lumpsumGoldAmt,lumpsum,lumpsumEquityPerc,lumpsumDebtPerc,lumpsumGoldPerc,goalType
                                              ,goal.IsDisplayDefaultProduct__c, goal.IsDisplaySIPinAP__c, goal.IsDisplayLumpsuminAP__c); 
            
            //=============SIP Funds & Lumpsum Funds==========================================================   
            //mapIdToMapMFTolstProducts.put(goal.id, mapMutualFundTolstProducts);
            
            SIPtotal = 0;
            if(mapGoalIdToAppActionPlan.containsKey(goal.id))
            {
               	lstPlan = mapGoalIdToAppActionPlan.get(goal.id);
               	for(Approve_Action_Plan__c objPlan : lstPlan)
               	{
					ETStatus = Label.ET_NotCreated;
  			 		if(mapIdToExecutionTracker.containsKey(objPlan.Id))
				  	{
						lstET = mapIdToExecutionTracker.get(objPlan.Id);
						for(Execution_Tracker__c objET : lstET)
						{
						 	if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
							  	ETStatus = Label.ET_NotExecuted; 
					 	  	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
						  	  	ETStatus = Label.ET_PartiallyExecuted;
					  	  	else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
						  	  	ETStatus = Label.ET_FullyExecuted;
						}
				  	}               	
                  	installments = objPlan.Installments__c;
                 	option = objPlan.Option__c;
             		remarks = objPlan.Remarks__c;
                 	productName = objPlan.Product_Name__c;
                 	transactionType = objPlan.Transaction_Type__c;
                 	sipETCreated = objPlan.isETCreated__c;
                 	category = objPlan.Category__c;
                 	amount = objPlan.Amount__c;
                 	execTracker = objPlan.isSIPexecutionTracker__c;
                 	executionTracker = execTracker ? 'Yes':'No';
                 	SIPtotal = SIPtotal + amount;
        			SIPSummaryTotal = SIPSummaryTotal + amount;
        			system.debug('--------objPlan.Id--SIP-----'+objPlan.Id);
          	 		objActionPlanGoalDetails.populateSIPFunds(productName,transactionType,amount,installments,category,
                  							option,remarks,execTracker,executionTracker,SipETCreated,objPlan.Id,ETStatus);
               }
            }
            
            approvedPlanBean.SIPSummaryTotal = SIPSummaryTotal;
            double Lumpsumtotal = 0;
            if(mapGoalIdToLumpsumAppActionPlan.containsKey(goal.id))
            {
               lstPlanForLumpsum = mapGoalIdToLumpsumAppActionPlan.get(goal.id);
               for(Approve_Action_Plan__c objPlan : lstPlanForLumpsum)
               {
               		ETStatus = Label.ET_NotCreated;
                	lumpsumInstallments = objPlan.Installments__c;
                 	lumpsumOption = objPlan.Option__c;
                  	lumpsumRemarks = objPlan.Remarks__c;
                 	lumpsumProductName = objPlan.Product_Name__c;
	                lumpsumTransactionType = objPlan.Transaction_Type__c;
                 	lumpsumCategory = objPlan.Category__c;
                 	lumpsumAmount = objPlan.Amount__c;
                 	lumpsumFund = objPlan.Fund__c;
                 	lumpsumAmountPerInstall = objPlan.Amount_Per_Installment__c;
                 	lumpsumExecTracker = objPlan.isLumpsumExecTracker__c;
                 	lumpsumETCreated = objPlan.isETCreated__c;
                 	if(lumpsumExecTracker)
                		lumpsumExecutionTracker = 'Yes';
               		else
                		lumpsumExecutionTracker = 'No';
                	if(mapIdToExecutionTracker.containsKey(objPlan.Id))
			  	   {
					   lstET = mapIdToExecutionTracker.get(objPlan.Id);
					   for(Execution_Tracker__c objET : lstET)
					   {
					   		if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
							  	ETStatus = Label.ET_NotExecuted; 
					 	  	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
						  	  	ETStatus = Label.ET_PartiallyExecuted;
					  	  	else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
						  	  	ETStatus = Label.ET_FullyExecuted;
					   		
					   }
			  	   }	
             		Lumpsumtotal = Lumpsumtotal + lumpsumAmount;
                	objActionPlanGoalDetails.populateLumpsumFunds(lumpsumProductName,lumpsumTransactionType,lumpsumAmount,lumpsumInstallments,lumpsumCategory,lumpsumOption,lumpsumRemarks,lumpsumFund,lumpsumAmountPerInstall
                                        ,lumpsumExecTracker,lumpsumExecutionTracker,lumpsumETCreated,objPlan.Id,ETStatus);
                 }
           }
           else if(mapGoalIdToEmergencyLumpsumAppActionPlan.containsKey(goal.Id))
           {
             	lstPlanForLumpsum = mapGoalIdToEmergencyLumpsumAppActionPlan.get(goal.id);
               	for(Approve_Action_Plan__c objPlan : lstPlanForLumpsum)
               	{
               		ETStatus = Label.ET_NotCreated;
                 	if(objPlan.Amount__c != null)
                 	{
                    	lumpsumInstallments = objPlan.Installments__c;
                     	lumpsumOption = objPlan.Option__c;
                      	lumpsumRemarks = objPlan.Remarks__c;
                     	lumpsumProductName = objPlan.Product_Name__c;
                     	lumpsumTransactionType = objPlan.Transaction_Type__c;
                     	lumpsumCategory = objPlan.Category__c;
                     	lumpsumAmount = objPlan.Amount__c;
                     	lumpsumFund = objPlan.Fund__c;
                     	lumpsumAmountPerInstall = objPlan.Amount_Per_Installment__c;
                     	lumpsumExecTracker = objPlan.isLumpsumExecTracker__c;
                     	lumpsumETCreated = objPlan.isETCreated__c;
                     	if(mapIdToExecutionTracker.containsKey(objPlan.Id))
			  	   	   	{	
					   		lstET = mapIdToExecutionTracker.get(objPlan.Id);
					   		for(Execution_Tracker__c objET : lstET)
					   		{
					   			if(objET.Suggested_Amount__c == objET.Total_Remaining_Balance__c && objET.Application_Status__c != 'Closed')
								  	ETStatus = Label.ET_NotExecuted; 
						 	  	else if(objET.Suggested_Amount__c > objET.Total_Remaining_Balance__c  && objET.Application_Status__c != 'Closed')
							  	  	ETStatus = Label.ET_PartiallyExecuted;
						  	  	else if(objET.Total_Remaining_Balance__c == objET.Agreed_Amount__c && objET.Executed_Amount__c == objET.Agreed_Amount__c )
							  	  	ETStatus = Label.ET_FullyExecuted;
					   		}
			  	   	   	}
                     	if(lumpsumExecTracker)
                    		lumpsumExecutionTracker = 'Yes';
                   		else
                    		lumpsumExecutionTracker = 'No';
                     	Lumpsumtotal = Lumpsumtotal + lumpsumAmount;
                    	objActionPlanGoalDetails.populateLumpsumFunds(lumpsumProductName,lumpsumTransactionType,lumpsumAmount,lumpsumInstallments,lumpsumCategory,lumpsumOption,lumpsumRemarks,lumpsumFund,lumpsumAmountPerInstall
                                             ,lumpsumExecTracker,lumpsumExecutionTracker,lumpsumETCreated,objPlan.Id,ETStatus);
                 	}
         		}
           }
           objActionPlanGoalDetails.SIPTotal = SIPtotal;
           objActionPlanGoalDetails.LumpsumTotal = Lumpsumtotal;
          
            //=========================================================================================================================
          
            //AssetAssociation
            strAssetDescription = '';
            double dblAssetExpectedGrowthRate = 10.0d;
            double dblAssetInterestRate = 0;
            double dblAssetGoalYearValue = 0;
            String strAssetAction = '';
            String strAssetType = '';
            String strAssetOwner = '';
            
            //goalAssetMappingMap returns map of GoalId to different assets allocated for particular goal
            if(goalAssetMappingMap.containsKey(goal.id))
            {
                  Map<Id,Asset__c> mapIdToAsset = new Map<Id,Asset__c>();
                lstGoalAssetAssociation = goalAssetMappingMap.get(goal.id);
                if(lstGoalAssetAssociation != null)
                {
                  for(GoalAssetAssociation__c objGoalAssetAssociation : lstGoalAssetAssociation)
                  {
                    for(Asset__c asset : assetList) 
                     {      
                      if(!mapIdToAsset.containsKey(asset.Id))
                      {
                        mapIdToAsset.put(asset.Id,asset);
                      }
                     }

                    if(objGoalAssetAssociation.asset__r.Action__c != '---None----')
                    {
                      
                      if(mapIdToAsset.ContainsKey(objGoalAssetAssociation.Asset__r.Id))
                      {
                        
                        if(objGoalAssetAssociation.Asset__r.RecordType.Name == 'Govt. Saving Schemes' ||
                            objGoalAssetAssociation.Asset__r.RecordType.Name == 'Retirement Accounts'|| 
                            objGoalAssetAssociation.Asset__r.RecordType.Name == 'Deposits With Bank')
                        {
                          strAssetDescription = (objGoalAssetAssociation.Asset__r.RecordType.Name == 'Deposits With Bank') ? 
                                  ((objGoalAssetAssociation.Asset__r.Bank_Name__c != null) ? 
                                  (objGoalAssetAssociation.Asset__r.Bank_Name__c + ' - ' + objGoalAssetAssociation.Asset__r.Account_Number__c) 
                                  : (objGoalAssetAssociation.Asset__r.Account_Number__c))  
                                  : (objGoalAssetAssociation.Asset__r.Account_Number__c);
                        }
                        else
                          strAssetDescription = (objGoalAssetAssociation.Asset__r.Description__c);
                          
                        
                        if(objGoalAssetAssociation.Asset__r.Asset_Types__c!=null && objGoalAssetAssociation.Asset__r.Asset_Types__c!='')
                        {
                            strAssetType = objGoalAssetAssociation.Asset__r.Asset_Types__c;
                          }
                          else
                          {
                              strAssetType = objGoalAssetAssociation.Asset__r.Account_Type__c;
                          }
                          
                        if(objGoalAssetAssociation.asset__r.entity__r.LastName == null)
                        {
                          strAssetOwner = objGoalAssetAssociation.asset__r.entity__r.FirstName;
                        }
                        else if(objGoalAssetAssociation.asset__r.entity__r.FirstName == null )
                        {
                          strAssetOwner = objGoalAssetAssociation.asset__r.entity__r.LastName;
                        }
                        else if(objGoalAssetAssociation.asset__r.entity__r.LastName != null && objGoalAssetAssociation.asset__r.entity__r.FirstName != null)
                        {
                          strAssetOwner = objGoalAssetAssociation.asset__r.entity__r.FirstName +' '+objGoalAssetAssociation.asset__r.entity__r.LastName;
                        }
                        else
                        {
                          strAssetOwner = '';
                        }
                        double allocatedAmount = 0;
                        availableAmount = 0; 
                        double amountAllocated = 0;
                        
                        strAssetAction = objGoalAssetAssociation.asset__r.action__c;
                        dblAssetGoalYearValue = objGoalAssetAssociation.GoalYearValue__c;
                        amountAllocated =objGoalAssetAssociation.Allocation__c ;
                          AssetsTotal = AssetsTotal + amountAllocated;
                        dblAssetExpectedGrowthRate = (objGoalAssetAssociation.asset__r.Expected_Growth_Rate__c != null ? 
                                        objGoalAssetAssociation.asset__r.Expected_Growth_Rate__c : 0 );
                        
                    if(objGoalAssetAssociation.asset__r.RecordType.Name.equals('Deposits With Bank') || 
                      objGoalAssetAssociation.asset__r.RecordType.Name.equals('Retirement Accounts')||
                      objGoalAssetAssociation.asset__r.RecordType.Name.equals('Govt. Saving Schemes'))
                            {
                                   if(objGoalAssetAssociation.asset__r.Interest_Rate__c != null)
                                      dblAssetInterestRate = Double.valueOf(String.valueOf(objGoalAssetAssociation.asset__r.Interest_Rate__c));
                                else
                                  {
                                       dblAssetInterestRate = 0;
                                       setInfoMessage('Please fill the Interest rate for allocated asset: '+objGoalAssetAssociation.asset__r.RecordType.Name);
                                  }
                              }
                              else
                                     dblAssetInterestRate = Double.valueOf(String.valueOf(objGoalAssetAssociation.asset__r.CalculatedInterestRate__c));
                          if(dblAssetInterestRate == null) 
                            {
                                        setInfoMessage('Interest Rate is not valid for some assets.');
                                continue;
                          }
                             if(objGoalAssetAssociation.asset__r.RecordType.Name.equals('Real Estate Assets') || 
                             objGoalAssetAssociation.asset__r.RecordType.Name.equals('Business Assets') || 
                            objGoalAssetAssociation.asset__r.RecordType.Name.equals('Personal Assets'))
                             {
                                 dblAssetInterestRate = dblAssetExpectedGrowthRate;
                             }
                        objActionPlanAllocatedAssets = objActionPlanGoalDetails.populateAllocatedAssets(strAssetDescription,strAssetType,strAssetOwner,amountAllocated,availableAmount,dblAssetGoalYearValue,strAssetAction,dblAssetInterestRate);
                      }
                   }  
                    }
                }
            }  
           //End of Asset ============================================================================================================
           //Insurance =========================================================================================================================
           
            Map<Id,Insurance__c> goalInsuranceMap = new Map<Id,Insurance__c>();
			goalInsuranceMap = dbSOQLObj.getInsuranceDetails(entityId);           
           
           
           strInsuranceDescription = '';
           strInsuranceType = '';
           String strPolicyType = '';
           String strInsuranceOwner = '';
           double dblInsuranceExpectedGrowthRate = 0;
           double dblInsuranceGoalYearValue = 0;
           string strInsuranceAction = '';
           if(goalInsuranceMappingMap.containsKey(goal.id))
           {
               lstGoalInsuranceAssociation = goalInsuranceMappingMap.get(goal.id);
               if(lstGoalInsuranceAssociation != null)
               {
                  for(GoalInsuranceAssociation__c objGoalInsuranceAssociation : lstGoalInsuranceAssociation)
                  {
                  if(objGoalInsuranceAssociation.Insurance__r.Action__c != '---None----')
                  {
                      strInsuranceType = objGoalInsuranceAssociation.Insurance__r.Policy_Type__c;
                    String InsuranceDescription = null;
                    Map<Id,Insurance__c> MapIdToInsurance = new Map<Id,Insurance__c>();
                   for(Insurance__c insurance : insuranceList) 
                   {
                      
                      if(!MapIdToInsurance.ContainsKey(insurance.Id))
                      {
                        MapIdToInsurance.put(insurance.Id,insurance);
                      }
                   }
                   if(MapIdToInsurance.ContainsKey(objGoalInsuranceAssociation.Insurance__r.Id))
                   {  
                    if(objGoalInsuranceAssociation.Insurance__r.Insurance_Company__c != null)
                {
                  if(objGoalInsuranceAssociation.Insurance__r.Policy_Name__c != null)
                  {
                    strInsuranceDescription = objGoalInsuranceAssociation.Insurance__r.Policy_Number__c != null ? 
                                (objGoalInsuranceAssociation.Insurance__r.Insurance_Company__c + ' -- ' + objGoalInsuranceAssociation.Insurance__r.Policy_Name__c + ' -- ' + objGoalInsuranceAssociation.Insurance__r.Policy_Number__c)
                                :(objGoalInsuranceAssociation.Insurance__r.Insurance_Company__c + ' -- ' + objGoalInsuranceAssociation.Insurance__r.Policy_Name__c);
                  }
                  else
                  {
                    strInsuranceDescription = objGoalInsuranceAssociation.Insurance__r.Policy_Number__c != null ? 
                                (objGoalInsuranceAssociation.Insurance__r.Insurance_Company__c + ' -- ' + objGoalInsuranceAssociation.Insurance__r.Policy_Number__c) 
                                : (objGoalInsuranceAssociation.Insurance__r.Insurance_Company__c);
                  }              
                }
                else
                {
                  if(objGoalInsuranceAssociation.Insurance__r.Policy_Name__c != null)
                  {
                    strInsuranceDescription = objGoalInsuranceAssociation.Insurance__r.Policy_Number__c != null ? 
                                (objGoalInsuranceAssociation.Insurance__r.Policy_Name__c + ' -- ' + objGoalInsuranceAssociation.Insurance__r.Policy_Number__c) 
                                : objGoalInsuranceAssociation.Insurance__r.Policy_Name__c;
                  }
                  else if(objGoalInsuranceAssociation.Insurance__r.Policy_Number__c != null)
                  {
                    strInsuranceDescription = objGoalInsuranceAssociation.Insurance__r.Policy_Number__c;
                  }                      
                }
                    }
                    if(objGoalInsuranceAssociation.Insurance__r.entity__r.LastName == null)
                    {
                      strInsuranceOwner = objGoalInsuranceAssociation.Insurance__r.entity__r.FirstName;
                    }
                    else if(objGoalInsuranceAssociation.Insurance__r.entity__r.FirstName == null )
                    {
                      strInsuranceOwner = objGoalInsuranceAssociation.Insurance__r.entity__r.LastName;
                    }
                    else if(objGoalInsuranceAssociation.Insurance__r.entity__r.LastName != null && objGoalInsuranceAssociation.Insurance__r.entity__r.FirstName != null)
                    {
                      strInsuranceOwner = objGoalInsuranceAssociation.Insurance__r.entity__r.FirstName +' '+ objGoalInsuranceAssociation.Insurance__r.entity__r.LastName;
                    }
                    else
                    {
                      strInsuranceOwner = '';
                    }
                  
                    double allocatedAmount = 0;
                    availableAmount = 0; 
                    allocatedAmount = objGoalInsuranceAssociation.Allocated__c;
                    strInsuranceAction = objGoalInsuranceAssociation.Insurance__r.action__c;
                    dblInsuranceGoalYearValue = objGoalInsuranceAssociation.GoalYearValue__c;
                    
                    Double CurrentVal;
                    double amountAllocated = 0;
                    balanceRemaining = 0;
                    Integer iTenureOfInsurance = 0;
                    if(goalInsuranceMap.containsKey(objGoalInsuranceAssociation.Insurance__c))
                          {
                            AssetAllocationService objAssetAllocationService = new AssetAllocationService();
                        Insurance__c objInsurance =goalInsuranceMap.get(objGoalInsuranceAssociation.Insurance__c);
                        Double dblOneInstallmentPremiumAmount = 0;
                        
                    // if(!objInsurance.Premium_Frequency__c.equals('One Time Premium'))
                   //{
                   if(objInsurance.Premium_Amount_Rs__c != null)
                       dblOneInstallmentPremiumAmount = objInsurance.Premium_Amount_Rs__c;
                   //}
                   if(objInsurance.Tenure_of_Insurance__c != null)
                   {
                     iTenureOfInsurance = Integer.valueOf(objInsurance.Tenure_of_Insurance__c);
                   }
                   
                   Integer iMaturityYear = iTenureOfInsurance + objInsurance.Commencement_Date__c.year();
                   Integer iCurrentYearForCalculation = 0;
                   /* Aditi - FP changes - 04-03-2013 - Changed Date.Today() to Plan_Generation_Date__c*/
                   Integer currentYear = objAccount.Plan_Generation_Date__c != null ? objAccount.Plan_Generation_Date__c.year() : Date.today().year();
                   if(currentYear > iMaturityYear)
                   {
                     iCurrentYearForCalculation = iMaturityYear;
                   }
                   else
                   {
                     iCurrentYearForCalculation = currentYear;
                   }
                   Integer totalPeriodInYears =  iCurrentYearForCalculation - objInsurance.Commencement_Date__c.year();//
                   if(objInsurance.Surrender_Cash_Value__c == null)
                   {
                     system.debug('****objInsurance*********'+objInsurance);
                     system.debug('****totalPeriodInYears*********'+totalPeriodInYears);
                     system.debug('****dblOneInstallmentPremiumAmount*********'+dblOneInstallmentPremiumAmount);
                     
                     CurrentVal = objAssetAllocationService.GetInsuranceAmountForPeriod(objInsurance,totalPeriodInYears, dblOneInstallmentPremiumAmount);
                   }else
                   {
                     CurrentVal = objInsurance.Surrender_Cash_Value__c;
                   }
                   
                   Double dblAllocated = allocatedAmount;
                   amountAllocated = (dblAllocated * CurrentVal)/100 ; 
                   system.debug('****amountAllocated*********'+amountAllocated);
                   if(CurrentVal != null)
                        {
                          balanceRemaining = CurrentVal - amountAllocated;
                        }else
                        {
                          balanceRemaining = 0;
                        }
                        
                        strPolicyType = objInsurance.Policy_Type__c;
                  dblInsuranceExpectedGrowthRate  = LifeInsuranceInterest__c.getInstance(strPolicyType).Rate__c;  
                          }
                          else
                            CurrentVal = 0; 
                         
                    AssetsTotal = AssetsTotal + amountAllocated;
                    objActionPlanAllocatedAssets = objActionPlanGoalDetails.populateAllocatedAssets(strInsuranceDescription,strInsuranceType,strInsuranceOwner,amountAllocated,availableAmount,dblInsuranceGoalYearValue,strInsuranceAction,dblInsuranceExpectedGrowthRate);
                    
                   }
                
                 }
              
                }
          
             }
         //End of Insurance ===============================================================================================================          
        
         //InvestmentAsset===============================================================================================================          
            strInvestmentType = '';
            strInvestmentDescription = '';
            String strInvestmentOwner = '';
            String strInvestmentAction = '';
            double dblInvestmentExpectedGrowthRate = 0;
            double dblInvestmentGoalYearValue = 0;
               double dblAllocatedAmt = 0;    
               double dblAmountAllocated = 0;
               String strInvestmentRecordType = '';
               double dblInvestmentCurrentValue = 0;
               boolean isNotIncome = false;
            if(goalInvestmentAssetMappingMap.containsKey(goal.id))
            {
              
               lstGoalInvestmentAssetAssociation = goalInvestmentAssetMappingMap.get(goal.id);
               if(lstGoalInvestmentAssetAssociation != null)
               {
                 for(GoalInvestmentAssetAssociation__c objGoalInvestmentAssetAssociation : lstGoalInvestmentAssetAssociation)
                     {
                       if(objGoalInvestmentAssetAssociation.Investment_asset__r.RecordType.Name == 'Fixed Income')
                       {
                     if(objGoalInvestmentAssetAssociation.Investment_asset__r.Action__c != '---None----')
                      { 
                        strInvestmentType = objGoalInvestmentAssetAssociation.Investment_asset__r.RecordType.Name;
                        if(objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.LastName == null)
                          {
                            strInvestmentOwner = objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.FirstName;
                          }
                          else if(objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.FirstName == null )
                          {
                            strInvestmentOwner = objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.LastName;
                          }
                          else if(objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.LastName != null && objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.FirstName != null)
                          {
                            strInvestmentOwner = objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.FirstName +' '+ objGoalInvestmentAssetAssociation.Investment_asset__r.entity__r.LastName;
                          }
                          else
                          {
                            strInvestmentOwner = '';
                          }
                        
                        dblAllocatedAmt = objGoalInvestmentAssetAssociation.Allocated__c;
                        dblInvestmentCurrentValue = objGoalInvestmentAssetAssociation.Investment_asset__r.TotalAsset__c ;
                        dblAmountAllocated = (dblInvestmentCurrentValue *  dblAllocatedAmt)/100;
                        
                        //Prajakta - FP changes - 25-02-2013
                        if(objGoalInvestmentAssetAssociation.Investment_asset__r.Maturity_Date__c != null)
                        {
                            Datetime dtReport = objGoalInvestmentAssetAssociation.Investment_asset__r.Maturity_Date__c;
                        	String strDate = dtReport.day() + '-' + dtReport.month() + '-' + dtReport.year();
                            strInvestmentDescription = objGoalInvestmentAssetAssociation.Investment_asset__r.Description__c + ' -- ' + strDate; 
                        }
                        else
                        {
                        	  strInvestmentDescription = objGoalInvestmentAssetAssociation.Investment_asset__r.Description__c;
                        }
                        //strInvestmentDescription = '-';
                        
                        dblInvestmentGoalYearValue = objGoalInvestmentAssetAssociation.GoalYearValue__c;
                        strInvestmentAction = objGoalInvestmentAssetAssociation.Investment_asset__r.action__c;
                        strInvestmentRecordType =  objGoalInvestmentAssetAssociation.investment_Asset__r.recordType.Name;
                              if(strInvestmentRecordType.equals('Stocks'))
                              {   
                                     dblInvestmentExpectedGrowthRate =  globalAssumptions.Stock_Growth_Rate__c;
                              }
                              /* Prajakta - FP changes - 01-04-2013 */
                              else if(strInvestmentRecordType.equals('Gold'))    
                              {   
                                     dblInvestmentExpectedGrowthRate =  globalAssumptions.Gold_Growth_Rate__c;
                              }
                              else
                                    dblInvestmentExpectedGrowthRate = globalAssumptions.Income_Growth_Rate__c;
                      }
                      AssetsTotal = AssetsTotal + dblAmountAllocated;
                         objActionPlanAllocatedAssets = objActionPlanGoalDetails.populateAllocatedAssets(strInvestmentDescription,strInvestmentType,strInvestmentOwner,dblAmountAllocated,availableAmount,dblInvestmentGoalYearValue,strInvestmentAction,dblInvestmentExpectedGrowthRate);
             
                       }
                       else
                       {
                         if(objGoalInvestmentAssetAssociation.Investment_asset__r.Action__c != '---None----')
                      { 
                            if(mapNameToInvestmentAsset.containsKey(objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.FirstName+' '+objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.LastName+objGoalInvestmentAssetAssociation.Investment_asset__r.RecordType.Name))
                           {
                             List<GoalInvestmentAssetAssociation__c> lstRelatedInvAsset = new List<GoalInvestmentAssetAssociation__c>(); 
                             lstRelatedInvAsset = mapNameToInvestmentAsset.get(objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.FirstName+' '+objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.LastName+objGoalInvestmentAssetAssociation.Investment_asset__r.RecordType.Name);
                             lstRelatedInvAsset.add(objGoalInvestmentAssetAssociation);
                             mapNameToInvestmentAsset.put(objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.FirstName+' '+objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.LastName+objGoalInvestmentAssetAssociation.Investment_asset__r.RecordType.Name,lstRelatedInvAsset);
                           }
                           else
                           {
                             List<GoalInvestmentAssetAssociation__c> lstRelatedInvAsset = new List<GoalInvestmentAssetAssociation__c>();
                             lstRelatedInvAsset.add(objGoalInvestmentAssetAssociation);
                             mapNameToInvestmentAsset.put(objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.FirstName+' '+objGoalInvestmentAssetAssociation.Investment_asset__r.Entity__r.LastName+objGoalInvestmentAssetAssociation.Investment_asset__r.RecordType.Name,lstRelatedInvAsset);
                           }
                           
                      }
                       }
                       
                     }
               system.debug('***mapNameToInvestmentAsset****'+mapNameToInvestmentAsset.keySet());
                     List<GoalInvestmentAssetAssociation__c> lstGoalInvestmentAsset = new List<GoalInvestmentAssetAssociation__c>();
                     for(String strEntityName : mapNameToInvestmentAsset.keySet())
                  {
                     CurrentValue = 0;
                     CurrentTotalValue = 0;
                     dblAmountAllocated = 0;
                  lstGoalInvestmentAsset = mapNameToInvestmentAsset.get(strEntityName);
                  system.debug('***strEntityName****'+strEntityName);
                  system.debug('***lstGoalInvestmentAsset****'+lstGoalInvestmentAsset);
                  for(GoalInvestmentAssetAssociation__c objGoalInvest : lstGoalInvestmentAsset )
                  {
                    if(objGoalInvest.Goal__c == goal.id)
                    {
                      isNotIncome = true;
                      strInvestmentDescription = '-';      
                      if(objGoalInvest.Investment_asset__r.entity__r.LastName == null)
                          {
                            strInvestmentOwner = objGoalInvest.Investment_asset__r.entity__r.FirstName;
                          }
                          else if(objGoalInvest.Investment_asset__r.entity__r.FirstName == null )
                          {
                            strInvestmentOwner = objGoalInvest.Investment_asset__r.entity__r.LastName;
                          }
                          else if(objGoalInvest.Investment_asset__r.entity__r.LastName != null && objGoalInvest.Investment_asset__r.entity__r.FirstName != null)
                          {
                            strInvestmentOwner = objGoalInvest.Investment_asset__r.entity__r.FirstName +' '+ objGoalInvest.Investment_asset__r.entity__r.LastName;
                          }
                          else
                          {
                            strInvestmentOwner = '';
                          }
                        dblAllocatedAmt = objGoalInvest.Allocated__c;
                            strInvestmentDescription = '-';        
                          strInvestmentType = objGoalInvest.Investment_asset__r.RecordType.Name;      
                          strInvestmentAction = objGoalInvest.Investment_asset__r.action__c;
                        strInvestmentRecordType =  objGoalInvest.investment_Asset__r.recordType.Name;
                        dblInvestmentCurrentValue = objGoalInvest.Investment_asset__r.TotalAsset__c ;
                        dblAmountAllocated = dblAmountAllocated + (dblInvestmentCurrentValue *  dblAllocatedAmt)/100;
                              if(strInvestmentRecordType.equals('Stocks'))
                              {   
                                     dblInvestmentExpectedGrowthRate =  globalAssumptions.Stock_Growth_Rate__c;
                              }
                              /* Prajakta - FP changes - 01-04-2013 */
                              else if(strInvestmentRecordType.equals('Gold'))    
                              {   
                                     dblInvestmentExpectedGrowthRate =  globalAssumptions.Gold_Growth_Rate__c;
                              }
                              else
                                    dblInvestmentExpectedGrowthRate = globalAssumptions.Income_Growth_Rate__c;   
                        
                        dblInvestmentGoalYearValue = objGoalInvest.GoalYearValue__c;
                    }
                    }
                    if(isNotIncome)
                    {
                      system.debug('****in isNotIncome****');
                      AssetsTotal = AssetsTotal + dblAmountAllocated;
                         objActionPlanAllocatedAssets = objActionPlanGoalDetails.populateAllocatedAssets(strInvestmentDescription,strInvestmentType,strInvestmentOwner,dblAmountAllocated,availableAmount,dblInvestmentGoalYearValue,strInvestmentAction,dblInvestmentExpectedGrowthRate);
                    }
                  } 
                     
               }
          }
         //End of InvestmentAsset ===============================================================================================================          
             objActionPlanGoalDetails.AssetsTotal = AssetsTotal;
         }
    }
    
    
    /**
    * @Description: Get family details for parent entity
    * param: None 
    * return type: void
    */  
    public void getFamilyDetails(ApprovedPlanBean beanObj){
        beanObj.accList = dbSOQLObj.getFamilyDetails(beanObj.entityId);
    }
    
    /**
    * @Description: Get Asset Allocation Details
    * param: ApprovedPlanBean
    * return type: void
    */ 
  /* 	public void getAssetAllocation(ApprovedPlanBean beanObj)
    {
        List<GoalInvestmentAssetAssociation__c> giaList = dbSOQLObj.getGoalInvestmentAssociationList(beanObj.entityId);
        List<GoalAssetAssociation__c> gaaList = dbSOQLObj.getGoalAssetAllocationList(beanObj.entityId);
        List<GoalInsuranceAssociation__c> ginaList = dbSOQLObj.getGoalInsuranceAllocationList(beanObj.entityId);
        
        Set<Id> recIds = new Set<Id>();
        Map<String,Double> Assetperc = new Map<String,Double>();
        
        for(GoalAssetAssociation__c gaObj: gaaList){
            if(Assetperc.get(gaObj.asset__c)!=null){
                Assetperc.put(gaObj.asset__c, Assetperc.get(gaObj.asset__c)+gaObj.allocated__c);
            }else{
                Assetperc.put(gaObj.asset__c, gaObj.allocated__c);
            }
        }
        
        for(GoalInvestmentAssetAssociation__c giObj: giaList){
            if(Assetperc.get(giObj.Investment_asset__c)!=null){
                Assetperc.put(giObj.Investment_asset__c, Assetperc.get(giObj.Investment_asset__c)+giObj.allocated__c);
            }else{
                Assetperc.put(giObj.Investment_asset__c, giObj.allocated__c);
            }
        }
        
        for(GoalInsuranceAssociation__c ginObj: ginaList){
            if(Assetperc.get(ginObj.Insurance__c)!=null){
                Assetperc.put(ginObj.Insurance__c, Assetperc.get(ginObj.Insurance__c)+ginObj.allocated__c);
            }else{
                Assetperc.put(ginObj.Insurance__c, ginObj.allocated__c);
            }
        }
        
       /* List<RecordType> recList = dbSOQLObj.getRecordTypeNames(recIds);
        Map<Id,String> recMap = new Map<Id,String>();
        for(RecordType recObj: recList){
            recMap.put(recObj.Id, recObj.Name);
        }*/
  /*      Set<String> processedId = new Set<String>();
        if(gaaList.size()>0){
            Map<String, double> golVal1 = new Map<String, double>();
           for(GoalAssetAssociation__c gaaObj: gaaList){
               golVal1.put(''+gaaObj.asset__c+gaaObj.goal__c, gaaObj.Allocated__c); 
           }
            for(GoalAssetAssociation__c gaaObj: gaaList){
                if(gaaObj.asset__r.Action__c != '---None----'){
                    if(!processedId.contains(gaaObj.asset__c)){
                        processedId.add(gaaObj.asset__c);
                        ApprovedPlanBean.SAssetAllocationBean tmpObj = new ApprovedPlanBean.SAssetAllocationBean();
                        tmpObj.entityName = gaaObj.asset__r.entity__r.FirstName +' '+gaaObj.asset__r.entity__r.LastName;
                        tmpObj.action = gaaObj.asset__r.action__c;
                        if(gaaObj.Asset__r.Asset_Types__c!=null && gaaObj.Asset__r.Asset_Types__c!=''){
                            tmpObj.Assets = gaaObj.Asset__r.Asset_Types__c;
                        }else{
                            tmpObj.Assets = gaaObj.Asset__r.Account_Type__c;
                        }
                        if(Assetperc.get(gaaObj.asset__c)!=null){
                            tmpObj.available = 100 - Assetperc.get(gaaObj.asset__c);
                            tmpObj.allocated = Assetperc.get(gaaObj.asset__c);
                        }else{
                            tmpObj.available = 100;
                            tmpObj.allocated = 0;
                        }
                        /** Eternus Solutions       **/
            /** Author  : Manasi Ranade **/
            /** Issue Id: FS0267        **/
            /** Date    : 11/11/2011   **/
            /** Purpose : Commented original code. Displayed the Actual Current value 
            /****************************************************/
   /*                     tmpObj.currentVal = gaaObj.asset__r.Monthly_Asset__c; //- gaaObj.asset__r.Allocated_Amount__c;
                        for(Goal__c golObj:beanObj.goalList){
                            if(golVal1.get(''+gaaObj.asset__c+golObj.Id)!=null){
                                tmpObj.golListVals.add(golVal1.get(''+gaaObj.asset__c+golObj.Id));
                            }else{
                                tmpObj.golListVals.add(0);
                            }
                        }
                        beanObj.aaBeanList.add(tmpObj);
                    }
                }
            }
        }
        
       if(ginaList.size()>0){
         //Action Plan : Manasi
    /** Eternus Solutions       **/
    /** Author  : Manasi Ranade **/
    /** Issue Id: FS0229        **/
    /** Date    : 25/10/2011   **/
    /** Purpose : Map required in calculation of current value of insurance
    /****************************************************/         
/*         Map<Id,Insurance__c> insuranceMap = new Map<Id,Insurance__c>();
        insuranceMap = dbSOQLObj.getInsuranceDetails(beanObj.entityId);
           Map<String, double> golVal = new Map<String, double>();
           for(GoalInsuranceAssociation__c ginaObj: ginaList){
               golVal.put(''+ginaObj.Insurance__c+ginaObj.goal__c, ginaObj.Allocated__c); 
           }
               
            for(GoalInsuranceAssociation__c ginaObj: ginaList){
                if(ginaObj.Insurance__r.Action__c != '---None----'){
                    if(!processedId.contains(ginaObj.Insurance__c)){
                        processedId.add(ginaObj.Insurance__c);
                        ApprovedPlanBean.SAssetAllocationBean tmpObj = new ApprovedPlanBean.SAssetAllocationBean();
                        tmpObj.entityName = ginaObj.Insurance__r.entity__r.FirstName +' '+ginaObj.Insurance__r.entity__r.LastName;
                        tmpObj.action = ginaObj.Insurance__r.action__c;
                        tmpObj.Assets =ginaObj.Insurance__r.RecordType.Name;
                        
                        if(Assetperc.get(ginaObj.Insurance__c)!=null){
                            tmpObj.available = 100 - Assetperc.get(ginaObj.Insurance__c);
                            tmpObj.allocated = Assetperc.get(ginaObj.Insurance__c);
                        }else{
                            tmpObj.available = 100;
                            tmpObj.allocated = 0;
                        }
                        
                        //tmpObj.currentVal = ginaObj.Insurance__r.total_insurance__c - ginaObj.Insurance__r.Allocated_Amount__c;
                        //Previuos Code:
                        //tmpObj.currentVal = ginaObj.Insurance__r.Premium_Amount_Rs__c;
                        //Action Plan : Manasi
                        //FS0229
                        /** Eternus Solutions       **/
            /** Author  : Manasi Ranade **/
            /** Issue Id: FS0229        **/
            /** Date    : 25/10/2011   **/
            /** Purpose : Code to calculate current value of insurance
            /****************************************************/
 /*                        if(insuranceMap.containsKey(ginaObj.Insurance__c))
                       {
                          Integer iTenureOfInsurance = 0;
                          Integer iMaturityYear = 0;
                          Integer totalPeriodInYears = 0;
                          AssetAllocationService objAssetAllocationService = new AssetAllocationService();
                      Insurance__c objInsurance =insuranceMap.get(ginaObj.Insurance__c);
                      Double dblOneInstallmentPremiumAmount = 0;
                      //if(!objInsurance.Premium_Frequency__c.equals('One Time Premium'))
                       if(objInsurance.Premium_Amount_Rs__c != null)
                     dblOneInstallmentPremiumAmount = objInsurance.Premium_Amount_Rs__c;
               
               if(objInsurance.Tenure_of_Insurance__c != null)
               {
                 iTenureOfInsurance = Integer.valueOf(objInsurance.Tenure_of_Insurance__c);
                 iMaturityYear = iTenureOfInsurance + objInsurance.Commencement_Date__c.year();
               }
               Integer iCurrentYearForCalculation = 0;
               /* Aditi - FP changes - 04-03-2013 - Changed Date.Today() to Plan_Generation_Date__c*/
 /*              Integer startYear = objAccount.Plan_Generation_Date__c != null ? objAccount.Plan_Generation_Date__c.year() : Date.today().year();
               if(startYear > iMaturityYear)
                 iCurrentYearForCalculation = iMaturityYear;
               else
                 iCurrentYearForCalculation = startYear;
               if(objInsurance.Commencement_Date__c.year() > 0)  
                 totalPeriodInYears =  iCurrentYearForCalculation - objInsurance.Commencement_Date__c.year();//
               if(objInsurance.Surrender_Cash_Value__c == null)
                 tmpObj.currentVal = objAssetAllocationService.GetInsuranceAmountForPeriod(objInsurance,totalPeriodInYears, dblOneInstallmentPremiumAmount);
               else
                 tmpObj.currentVal = objInsurance.Surrender_Cash_Value__c;
               Double dblAllocated = tmpObj.allocated;
                          //Original Code
               //tmpObj.currentVal = tmpObj.currentVal * ((100- Decimal.valueof(dblAllocated)) / 100 );
                        }
                        else
                          tmpObj.currentVal = 0; 
                        
                        for(Goal__c golObj:beanObj.goalList){
                            if(golVal.get(''+ginaObj.Insurance__c+golObj.Id)!=null){
                                tmpObj.golListVals.add(golVal.get(''+ginaObj.Insurance__c+golObj.Id));
                            }else{
                                tmpObj.golListVals.add(0);
                            }
                        }
                        beanObj.aaBeanList.add(tmpObj);
                    }
                }
            }
        }
        
        if(giaList.size()>0){
           Map<String, double> golVal2 = new Map<String, double>();
           for(GoalInvestmentAssetAssociation__c giaObj: giaList){
               golVal2.put(''+giaObj.Investment_asset__c+giaObj.goal__c, giaObj.Allocated__c); 
           }
           
           Map<String, double> totCurrent = new Map<String, double>();
           for(GoalInvestmentAssetAssociation__c giaObj: giaList){
               if(totCurrent.get(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c)!=null){
                   /** Eternus Solutions       **/
           /** Author  : Manasi Ranade **/
           /** Issue Id: FS0267        **/
           /** Date    : 11/11/2011   **/
           /** Purpose : Commented original code. Displayed the Actual Current value 
           /****************************************************/
                 //Original Code
                   //double tmpVal1 = giaObj.Investment_asset__r.TotalAsset__c - giaObj.Investment_asset__r.Allocated_Amount__c;
/*                   double tmpVal1 = giaObj.Investment_asset__r.TotalAsset__c;// - giaObj.Investment_asset__r.Allocated_Amount__c;
                   tmpVal1 = tmpVal1 + totCurrent.get(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c);
                   totCurrent.put(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c, tmpVal1);
               }else{
                   /** Eternus Solutions       **/
           /** Author  : Manasi Ranade **/
           /** Issue Id: FS0267        **/
           /** Date    : 11/11/2011   **/
           /** Purpose : Commented original code. Displayed the Actual Current value 
           /****************************************************/
                 //Original Code
                   //double tmpVal = giaObj.Investment_asset__r.TotalAsset__c - giaObj.Investment_asset__r.Allocated_Amount__c;
/*                   double tmpVal = giaObj.Investment_asset__r.TotalAsset__c;// - giaObj.Investment_asset__r.Allocated_Amount__c;
                   totCurrent.put(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c, tmpVal);
               } 
           }
            
            for(GoalInvestmentAssetAssociation__c giaObj: giaList){
                if(giaObj.Investment_asset__r.Action__c != '---None----'){
                    if(!processedId.contains(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c)){
                        processedId.add(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c);
                        ApprovedPlanBean.SAssetAllocationBean tmpObj = new ApprovedPlanBean.SAssetAllocationBean();
                        tmpObj.entityName = giaObj.Investment_asset__r.entity__r.FirstName +' '+giaObj.Investment_asset__r.entity__r.LastName;
                        tmpObj.action = giaObj.Investment_asset__r.action__c;
                        
                        if(Assetperc.get(giaObj.Investment_asset__c)!=null){
                            tmpObj.available = 100 - Assetperc.get(giaObj.Investment_asset__c);
                            tmpObj.allocated = Assetperc.get(giaObj.Investment_asset__c);
                        }else{
                            tmpObj.available = 100;
                            tmpObj.allocated = 0;
                        }
                        tmpObj.Assets = giaObj.Investment_asset__r.RecordType.Name;
                        if(totCurrent.get(''+giaObj.Investment_asset__r.RecordType.Name +giaObj.Investment_asset__r.Entity__c)!=null){
                            tmpObj.currentVal = totCurrent.get(''+giaObj.Investment_asset__r.RecordType.Name+giaObj.Investment_asset__r.Entity__c);
                            
                        }else{
                            tmpObj.currentVal = 0;
                        }
                        
                        for(Goal__c golObj:beanObj.goalList){
                            if(golVal2.get(''+giaObj.Investment_asset__c+golObj.Id)!=null){
                                tmpObj.golListVals.add(golVal2.get(''+giaObj.Investment_asset__c+golObj.Id));
                            }else{
                                tmpObj.golListVals.add(0);
                            }
                        }
                        beanObj.aaBeanList.add(tmpObj);
                    }
                }
            }
        }
    }
    */
    /**
    * @Description: Get General Insurance records which are created during the Insurence planning
    * param: List<Account>
    * return type: List<Insurance__c>
    */ 
    public List<Insurance__c> getGenerelInsurance(List<Account> accList){
        return dbSOQLObj.getAnalysisInsurances(InsuranceRecTypes__c.getInstance('General Insurance').RecordTypeId__c, accList);
    }
    
     /**
    * @Description: Get Life Insurance records which are created during the Insurence planning
    * param: List<Account>
    * return type: List<Insurance__c>
    */ 
    public List<Insurance__c> getLifeInsurance(List<Account> accList){
        return dbSOQLObj.getAnalysisInsurances(InsuranceRecTypes__c.getInstance('Life Insurance').RecordTypeId__c, accList);
    }
    
     /**
    * @Description: Get Approved Life insurance records which are created on Approved plan page
    * param: ApprovedPlanBean 
    * return type: void
    */
    //Commented on 19/12/13 : Aditi Satpute   
    /*public void getApprGenerelInsurance(ApprovedPlanBean beanObj){
        beanObj.giApprovedList = dbSOQLObj.getApprovedInsurances(InsuranceRecTypes__c.getInstance('General Insurance').RecordTypeId__c, beanObj.accList);
        if(beanObj.giApprovedList.size()<=0){
            for(Insurance__c insObj: beanObj.giList){
                Insurance__c insTmp = new Insurance__c();
                insTmp.Flag__c = 'Approved';
                insTmp.Suggested_Cover_General_Insurance__c = insObj.Suggested_Cover_General_Insurance__c;
                insTmp.Premium_Amount_Rs__c =insObj.Premium_Amount_Rs__c;
                insTmp.Policy_Type__c = insObj.Policy_Type__c;
                insTmp.Entity__c = insObj.Entity__c;
                insTmp.Entity_Name__c = insObj.Entity__r.FirstName + ' ' + insObj.Entity__r.LastName;
                insTmp.Insurance_Company__c = insObj.Insurance_Company__c;
                insTmp.RecordTypeId = InsuranceRecTypes__c.getInstance('General Insurance').RecordTypeId__c;
                beanObj.giApprovedList.add(insTmp);
                beanObj.isApprovedGeneralInsExist = true;
            }
        }else{
            beanObj.isApprovedGeneralInsExist = true;
        }
    }*/
    
    /**
    * @Description: Get Approved Life insurance records which are created on Approved plan page
    * param: ApprovedPlanBean 
    * return type: void
    */ 
    //Commented on 19/12/13 : Aditi Satpute   
    /*public void getApprLifeInsurance(ApprovedPlanBean beanObj){
        beanObj.liApprovedList = dbSOQLObj.getApprovedInsurances(InsuranceRecTypes__c.getInstance('Life Insurance').RecordTypeId__c, beanObj.accList);
        system.debug('size***'+beanObj.liApprovedList.size());
        if(beanObj.liApprovedList.size()<=0){
            system.debug('size1***');
            for(Insurance__c insObj: beanObj.liList){
                Insurance__c insTmp = new Insurance__c();
                insTmp.Flag__c = 'Approved';
                insTmp.Suggested_Cover_General_Insurance__c = insObj.Suggested_Cover_General_Insurance__c;
                insTmp.Premium_Amount_Rs__c =insObj.Premium_Amount_Rs__c;
                insTmp.Policy_Type__c = insObj.Policy_Type__c;
                insTmp.Entity__c = insObj.Entity__c;
                insTmp.Entity_Name__c = insObj.Entity__r.FirstName + ' ' + insObj.Entity__r.LastName;
                insTmp.Insurance_Company__c = insObj.Insurance_Company__c;
                insTmp.RecordTypeId = InsuranceRecTypes__c.getInstance('Life Insurance').RecordTypeId__c;
                beanObj.liApprovedList.add(insTmp);
                beanObj.isApprovedLifeInsExist = true;
                //system.debug('size2***');
            }
        }
        else
        {
            beanObj.isApprovedLifeInsExist = true;
        }
    }
    */
    
    /**
    * @Description: Get goals for the parent entity
    * param: void
    * return type: void
    */ 
    public void getGoals(ApprovedPlanBean beanObj){
         beanObj.goalList = dbSOQLObj.getAllGoals(beanObj.entityId);
    }
    
     /**
    * @Description: Prepare current Lumpsum approved data
    * param: ApprovedPlanBean 
    * return type: void
    */ 
    //Commented on 19/12/13 : Aditi Satpute
    /*
    public void getCurMFLumpSumApprovedPlans(ApprovedPlanBean beanObj){
         Map<Id, List<ApprovedPlanBean.Goals>> mapcurrMFLump = new Map<Id, List<ApprovedPlanBean.Goals>>();
         mapcurrMFLump = getGoalsAllocated(currentLump ,beanObj);         
         set<id> investId = new set<id>();
         system.debug('********beanObj.approvedPlanList'+beanObj.approvedPlanList);
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList){
             if(apObj.RecordType.Name == currentLump ){
                if(mapcurrMFLump.get(apObj.Investment_Asset__c) != null){
                    investId.add(apObj.Investment_Asset__c);
                    ApprovedPlanBean.CurrentMFLumpSum tmpObj = new ApprovedPlanBean.CurrentMFLumpSum(); 
                    
                    tmpObj.entityId = apObj.Investment_Asset__r.Entity__c;
                    tmpObj.recordId = apObj;
                    tmpObj.assetId = apObj.Investment_Asset__c;
                    tmpObj.schemeName = apObj.Investment_Asset__r.Fund__r.Scheme_Name__c; //FS0235
                    tmpObj.schemeName = apObj.Investment_Asset__r.Scheme_Name_Text__c;//FS0235
                    tmpObj.assetsClass = apObj.Investment_Asset__r.Asset_Type__c;
                    tmpObj.assetAmount = apObj.Investment_Asset__r.TotalAsset__c;
                    tmpObj.entityName = apObj.Investment_Asset__r.Entity__r.FirstName +' '+apObj.Investment_Asset__r.Entity__r.LastName;
                    tmpObj.action = apObj.Lumpsum_Action__c;
                    tmpObj.actionAmount = apObj.Amount__c;
                    tmpObj.golCurrMFLumpSum = mapcurrMFLump.get(apObj.Investment_Asset__c);
                    mapcurrMFLump.remove(apObj.Investment_Asset__c);
                    beanObj.currentMFLumpSumList.add(tmpObj);
                }
             }
         }
         
         //if(beanObj.currentMFLumpSumList.size()<=0){
             for(Investment_Asset__c investObj: beanObj.investment){
                 if(!investId.contains(investObj.Id)){
                     ApprovedPlanBean.CurrentMFLumpSum tmpObj = new ApprovedPlanBean.CurrentMFLumpSum();
                     tmpObj.entityId = investObj.Entity__c;
                     tmpObj.assetId = investObj.Id;
                     //tmpObj.schemeName = investObj.Fund__r.Scheme_Name__c;//FS0235
                     tmpObj.schemeName = investObj.Scheme_Name_Text__c;//FS0235
                     tmpObj.assetsClass = investObj.Asset_Type__c;
                     tmpObj.assetAmount = investObj.TotalAsset__c;
                     tmpObj.entityName = investObj.Entity__r.FirstName +' '+investObj.Entity__r.LastName;
                     
                     for(Goal__c golObj:beanObj.goalList){
                         ApprovedPlanBean.Goals tmpInObj = new ApprovedPlanBean.Goals();
                         tmpInObj.goalId = golObj.Id;
                         tmpInObj.allocated = 0;
                         tmpObj.golCurrMFLumpSum.add(tmpInObj);
                     }
                     beanObj.currentMFLumpSumList.add(tmpObj);
                 }
             }
         //}
     }   
     */
      /**
    * @Description: Prepare current SIP approved data
    * param: ApprovedPlanBean 
    * return type: void
    */ 
    //Commented on 19/12/13 : Aditi Satpute
    /* public void getCurMFSIPApprovedPlans(ApprovedPlanBean beanObj)
     {
         Map<Id, List<ApprovedPlanBean.Goals>> mapcurrMFSIP = new Map<Id, List<ApprovedPlanBean.Goals>>();
         mapcurrMFSIP = getGoalsAllocated(currentSIP ,beanObj);         
         set<id> investId = new set<id>();       
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList)
         {
             if(apObj.RecordType.Name == currentSIP )
             {
                if(mapcurrMFSIP.get(apObj.Investment_Asset__c) != null)
                {
                    if(apObj.Investment_Asset__r.Monthly_SIP_Amount__c!= null && apObj.Investment_Asset__r.Monthly_SIP_Amount__c!=0)
                    {
                        ApprovedPlanBean.CurrentMFSIP tmpObj = new ApprovedPlanBean.CurrentMFSIP(); 
                        investId.add(apObj.Investment_Asset__c);
                        tmpObj.entityId = apObj.Investment_Asset__r.Entity__c;
                        tmpObj.recordId = apObj;
                        tmpObj.assetId = apObj.Investment_Asset__c;
                        //tmpObj.schemeName = apObj.Investment_Asset__r.Fund__r.Scheme_Name__c;//FS0235
                        tmpObj.schemeName = apObj.Investment_Asset__r.Scheme_Name_Text__c;//FS0235
                        tmpObj.assetsClass = apObj.Investment_Asset__r.Asset_Type__c;
                        tmpObj.currentSIP = apObj.Investment_Asset__r.Monthly_SIP_Amount__c;
                        tmpObj.entityName = apObj.Investment_Asset__r.Entity__r.FirstName +' '+apObj.Investment_Asset__r.Entity__r.LastName;
                        tmpObj.SIPAction = apObj.SIP_Action__c;
                        tmpObj.SIPChange = apObj.Amount__c;
                        //tmpObj.allocatedAmount = apObj.Allocated_Amount__c;
                        tmpObj.golCurrMFSIP = mapcurrMFSIP.get(apObj.Investment_Asset__c);
                        mapcurrMFSIP.remove(apObj.Investment_Asset__c);
                        beanObj.currentMFSIPList.add(tmpObj);
                    }
                }
             }
         }
         
         //if(beanObj.currentMFSIPList.size()<=0){
             for(Investment_Asset__c investObj: beanObj.investment){
                 if(!investId.contains(investObj.Id)){
                     if(investObj.Monthly_SIP_Amount__c!=null && investObj.Monthly_SIP_Amount__c != 0){
                         ApprovedPlanBean.CurrentMFSIP tmpObj = new ApprovedPlanBean.CurrentMFSIP();
                         tmpObj.entityId = investObj.Entity__c;
                         tmpObj.assetId = investObj.Id;
                         //tmpObj.schemeName = investObj.Fund__r.Scheme_Name__c;//FS0235
                         tmpObj.schemeName = investObj.Scheme_Name_Text__c;//FS0235
                         tmpObj.assetsClass = investObj.Asset_Type__c;
                         tmpObj.currentSIP = investObj.Monthly_SIP_Amount__c;
                         tmpObj.entityName = investObj.Entity__r.FirstName +' '+investObj.Entity__r.LastName;
                         
                         for(Goal__c golObj:beanObj.goalList){
                             ApprovedPlanBean.Goals tmpInObj = new ApprovedPlanBean.Goals();
                             tmpInObj.goalId = golObj.Id;
                             tmpInObj.allocated = 0;
                             tmpObj.golCurrMFSIP.add(tmpInObj);
                         }
                         beanObj.currentMFSIPList.add(tmpObj);
                     }
                 }
             }
         //}
     }*/
     
       /**
    * @Description: Prepare Suggested Lumpsum approved data
    * param: ApprovedPlanBean 
    * return type: void
    */ 
    //Commented on 19/12/13 : Aditi Satpute
    /* public void getSuggMFLumpApprovedPlans(ApprovedPlanBean beanObj)
     {
         Map<String, List<ApprovedPlanBean.Goals>> mapSuggMFLump = new Map<String, List<ApprovedPlanBean.Goals>>();
         mapSuggMFLump = getSuggGoalsAllocated(suggestedLump,beanObj);
            
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList)
         {
           if(apObj.RecordType.Name == suggestedLump)
             {
                if(mapSuggMFLump.get(apObj.entity__c+apObj.Scheme_Name_Text__c) != null)
                {
                    ApprovedPlanBean.SuggestedMFLumpSum tmpObj = new ApprovedPlanBean.SuggestedMFLumpSum(); 
                    tmpObj.entityId = apObj.Entity__c;
                    tmpObj.recordId = apObj;
                    tmpObj.assetId = apObj.Investment_Asset__c;
                    //tmpObj.schemeName = apObj.Scheme_Name__c;//FS0235
                    tmpObj.schemeName = apObj.Scheme_Name_Text__c;//FS0235
                    tmpObj.assetsClass = apObj.Asset_Class__c;
                    tmpObj.entityName = apObj.Entity__r.FirstName +' '+apObj.Entity__r.LastName;
                    tmpObj.action = apObj.Suggested_LumpSum_Action__c;
                    tmpObj.amount = apObj.Amount__c;
                    tmpObj.notes = apObj.Notes__c;
                    //tmpObj.allocatedAmount = apObj.Allocated_Amount__c;
                    tmpObj.golsuggMFLump = mapSuggMFLump.get(apObj.entity__c+apObj.Scheme_Name_Text__c);
                    mapSuggMFLump.remove(apObj.entity__c+apObj.Scheme_Name_Text__c);
                    beanObj.suggestedMFLumpSumList.add(tmpObj);
                }
             }
         }
         
         if(beanObj.suggestedMFLumpSumList.size()<=0)
         {
             ApprovedPlanBean.SuggestedMFLumpSum tmpObj = AddNewSuggMFLump(beanObj);
             beanObj.SuggestedMFLumpSumList.add(tmpObj);
         }
     }
     */
       /**
    * @Description: Prepare Suggested SIP approved data
    * param: ApprovedPlanBean 
    * return type: void
    */
    
   /** Eternus Solutions       **/
  /** Author  : Dipak Nikam **/
  /** Case Number 00001521        **/
  /** Date    : 24/02/2012   **/
  /** Purpose :Modified  the code Replace Scheme_Name__c to Scheme_Name_Text__c
  /****************************************************/
     //Commented on 19/12/13 : Aditi Satpute
     /*public void getSuggMFSIPApprovedPlans(ApprovedPlanBean beanObj)
     {
         Map<String, List<ApprovedPlanBean.Goals>> mapSuggMFSIP = new Map<String, List<ApprovedPlanBean.Goals>>();
         mapSuggMFSIP = getSuggGoalsAllocated(suggestedSIP,beanObj);
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList)
  		 {
         	if(apObj.RecordType.Name == suggestedSIP)
           	{
              	if(mapSuggMFSIP.get(apObj.entity__c+apObj.Scheme_Name_Text__c) != null)
              	{
                  ApprovedPlanBean.SuggestedMFSIP tmpObj = new ApprovedPlanBean.SuggestedMFSIP(); 
                  tmpObj.entityId = apObj.Entity__c;
      			  tmpObj.entityName = apObj.Entity__r.FirstName +' ' +apObj.Entity__r.LastName;
                                      
                  tmpObj.recordId = apObj;
                  tmpObj.assetId = apObj.Investment_Asset__c;
                  //tmpObj.schemeName = apObj.Scheme_Name__c;//FS0235
                  tmpObj.schemeName = apObj.Scheme_Name_Text__c;//FS0235
                  tmpObj.assetsClass = apObj.Asset_Class__c;
                  tmpObj.SIPAmount= apObj.Amount__c;
                  //tmpObj.allocatedAmount = apObj.Allocated_Amount__c;
                  tmpObj.golSuggMFSIP = mapSuggMFSIP.get(apObj.entity__c+apObj.Scheme_Name_Text__c);
                  mapSuggMFSIP.remove(apObj.entity__c+apObj.Scheme_Name_Text__c);
                  beanObj.suggestedMFSIPList.add(tmpObj);
              	}
           	}
       	 }
         if(beanObj.suggestedMFSIPList.size()<=0){
             ApprovedPlanBean.SuggestedMFSIP tmpObj = AddNewSuggMFSIP(beanObj);
             beanObj.SuggestedMFSIPList.add(tmpObj);
         }
     }
     */
      /**
    * @Description: Add new record for the suggested Lumpsum
    * param: ApprovedPlanBean
    * return type: ApprovedPlanBean.SuggestedMFLumpSum
    */ 
    //Commented on 19/12/13 : Aditi Satpute
    
    /*public ApprovedPlanBean.SuggestedMFLumpSum AddNewSuggMFLump(ApprovedPlanBean beanObj){
        ApprovedPlanBean.SuggestedMFLumpSum tmpObj = new ApprovedPlanBean.SuggestedMFLumpSum();
        tmpObj.entityId = beanObj.entityId;
        for(Goal__c golObj:beanObj.goalList){
                     ApprovedPlanBean.Goals tmpInObj = new ApprovedPlanBean.Goals();
                     tmpInObj.goalId = golObj.Id;
                     tmpInObj.allocated = 0;
                     tmpInObj.allocatedAmount = 0;
                     tmpObj.golsuggMFLump.add(tmpInObj);
        }
        return tmpObj;
    } */
    
    /**
    * @Description: Add new record for the suggested SIP
    * param: ApprovedPlanBean
    * return type: ApprovedPlanBean.SuggestedMFSIP
    */ 
    //Commented on 19/12/13 : Aditi Satpute
    /*public ApprovedPlanBean.SuggestedMFSIP AddNewSuggMFSIP(ApprovedPlanBean beanObj){
        ApprovedPlanBean.SuggestedMFSIP tmpObj = new ApprovedPlanBean.SuggestedMFSIP();
        tmpObj.entityId = beanObj.entityId; 
        for(Goal__c golObj:beanObj.goalList){
                     ApprovedPlanBean.Goals tmpInObj = new ApprovedPlanBean.Goals();
                     tmpInObj.goalId = golObj.Id;
                     tmpInObj.allocated = 0;
                     tmpInObj.allocatedAmount = 0;
                     tmpObj.golSuggMFSIP.add(tmpInObj);
        }
        return tmpObj;
    }*/                             
    
    
     /**
    * @Description: Add new record for the  SIP Funds
    * param: ApprovedPlanBean
    * return type: ApprovedPlanBean.SIPFunds
    */ 
    public ApprovedPlanBean.SIPFunds AddNewSIPFunds(ApprovedPlanBean beanObj){
       	 Approve_Action_Plan__c obj = new Approve_Action_Plan__c();
         ApprovedPlanBean.SIPFunds objSIPFunds = new ApprovedPlanBean.SIPFunds();
         objSIPFunds.execTracker = false;
         objSIPFunds.ETStatus = Label.ET_NotCreated;
         return objSIPFunds;
    }          
     public ApprovedPlanBean.LumpsumFunds AddNewLumpsumFunds(ApprovedPlanBean beanObj){
         ApprovedPlanBean.LumpsumFunds objLumpsumFunds = new ApprovedPlanBean.LumpsumFunds();
         objLumpsumFunds.ETStatus = Label.ET_NotCreated;
         return objLumpsumFunds;
    }   
    
    
    
    
    
    
    
    
    /**
    * @Description: get allocated goals for the current approved data
    * param: Recordtype.Name, ApprovedPlanBean 
    * return type: Map<Id, List<ApprovedPlanBean.Goals>>
    */ 
    //Commented on 19/12/13 : Aditi Satpute
    /*public Map<Id, List<ApprovedPlanBean.Goals>> getGoalsAllocated(String recType,ApprovedPlanBean beanObj)
    {
         Map<Id, List<ApprovedPlanBean.Goals>> mapAllocatedVal = new Map<Id, List<ApprovedPlanBean.Goals>>();
         Map<String, double> goalAllocatedMap = new Map<String, double>();
         Map<String, double> goalAmountMap = new Map<String, double>();
         set<string> proceesRec = new set<string>();
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList)
         {
             if(apObj.RecordType.Name == recType)
             {
                goalAllocatedMap.put(''+apObj.goal__c+apObj.Investment_Asset__c,apObj.Allocated__c);
                if(apObj.Allocated__c!=null && apObj.Allocated__c != 0 && apObj.Amount__c != null && apObj.Amount__c != 0)
                {
                    goalAmountMap.put (''+apObj.goal__c+apObj.Investment_Asset__c, (apObj.Amount__c * apObj.Allocated__c) / 100) ;
                }
                else
                {
                    goalAmountMap.put (''+apObj.goal__c+apObj.Investment_Asset__c, 0) ;
                }
             }
         }
         
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList){
             if(!proceesRec.contains(apObj.Investment_Asset__c)){
                 if(apObj.RecordType.Name == recType){
                     proceesRec.add(apObj.Investment_Asset__c);
                     for(Goal__c golObj:beanObj.goalList){
                       if(mapAllocatedVal.get(apObj.Investment_Asset__c)!=null){
                            List<ApprovedPlanBean.Goals> tmpList = mapAllocatedVal.get(apObj.Investment_Asset__c);
                            ApprovedPlanBean.Goals tmpGol = new ApprovedPlanBean.Goals();
                            tmpGol.goalId = golObj.Id;
                            if(goalAllocatedMap.get(''+golObj.Id+apObj.Investment_Asset__c)!=null){
                                tmpGol.allocated= goalAllocatedMap.get(''+golObj.Id+apObj.Investment_Asset__c);
                            }else{
                                tmpGol.allocated= 0;
                            }
                            
                            if(goalAmountMap.get(''+golObj.Id+apObj.Investment_Asset__c)!=null){
                                tmpGol.allocatedAmount = goalAmountMap.get(''+golObj.Id+apObj.Investment_Asset__c);
                            }else{
                                tmpGol.allocatedAmount = 0;
                            }
                            tmpList.add(tmpGol);
                            mapAllocatedVal.put(apObj.Investment_Asset__c, tmpList);
                       }else{
                            List<ApprovedPlanBean.Goals> tmpList1 = new List<ApprovedPlanBean.Goals>();
                            ApprovedPlanBean.Goals tmpGol1 = new ApprovedPlanBean.Goals();
                            tmpGol1.goalId = golObj.Id;
                            if(goalAllocatedMap.get(''+golObj.Id+apObj.Investment_Asset__c)!=null){
                                tmpGol1.allocated= goalAllocatedMap.get(''+golObj.Id+apObj.Investment_Asset__c);
                            }else{
                                tmpGol1.allocated= 0;
                            }
                            
                            if(goalAmountMap.get(''+golObj.Id+apObj.Investment_Asset__c)!=null){
                                tmpGol1.allocatedAmount = goalAmountMap.get(''+golObj.Id+apObj.Investment_Asset__c);
                            }else{
                                tmpGol1.allocatedAmount = 0;
                            }
                            tmpList1.add(tmpGol1);
                            mapAllocatedVal.put(apObj.Investment_Asset__c, tmpList1);
                           
                       }                      
                     }
                 }
             }
         }
         return mapAllocatedVal; 
     }*/
     
    /**
    * @Description: get allocated goals for the suggested approved data
    * param: Recordtype.Name, ApprovedPlanBean 
    * return type: Map<Id, List<ApprovedPlanBean.Goals>>
    */
    /** Eternus Solutions       **/
  /** Author  : Dipak Nikam **/
  /** Case Number 00001521        **/
  /** Date    : 24/02/2012   **/
  /** Purpose :Modified  the code :To Replace Scheme_Name__c to Scheme_Name_Text__c
  /****************************************************/
  	 //Commented on 19/12/13 : Aditi Satpute
     /*public Map<String, List<ApprovedPlanBean.Goals>> getSuggGoalsAllocated(String recType,ApprovedPlanBean beanObj)
     {
         Map<String, List<ApprovedPlanBean.Goals>> mapAllocatedVal = new Map<String, List<ApprovedPlanBean.Goals>>();
         Map<String, double> goalAllocatedMap = new Map<String, double>();
         Map<String, double> goalAmountMap = new Map<String, double>();
         set<string> proceesRec = new set<string>();
         
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList)
         {
             if(apObj.RecordType.Name == recType)
             {
                goalAllocatedMap.put(''+apObj.goal__c+apObj.entity__c+apObj.Scheme_Name_Text__c,apObj.Allocated__c);
                if(apObj.Allocated__c!=null && apObj.Allocated__c != 0 && apObj.Amount__c != null && apObj.Amount__c != 0)
                {
                    goalAmountMap.put (''+apObj.Goal__c+apObj.entity__c+apObj.Scheme_Name_Text__c, (apObj.Amount__c * apObj.Allocated__c) / 100) ;
                }
                else
                {
                    goalAmountMap.put (''+apObj.Goal__c+apObj.entity__c+apObj.Scheme_Name_Text__c, 0) ;
                }
             }
         }
        
         for(Approved_Action_Plan__c apObj: beanObj.approvedPlanList)
         {
           if(!proceesRec.contains(apObj.entity__c+apObj.Scheme_Name_Text__c))
             {
                 if(apObj.RecordType.Name == recType)
                 {
                     proceesRec.add(apObj.entity__c+apObj.Scheme_Name_Text__c);
                     for(Goal__c golObj:beanObj.goalList)
                     {
                       if(mapAllocatedVal.get(apObj.entity__c+apObj.Scheme_Name_Text__c)!=null)
                       {
                            List<ApprovedPlanBean.Goals> tmpList = mapAllocatedVal.get(apObj.entity__c+apObj.Scheme_Name_Text__c);
                            ApprovedPlanBean.Goals tmpGol = new ApprovedPlanBean.Goals();
                            tmpGol.goalId = golObj.Id;
                            if(goalAllocatedMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c)!=null)
                            {
                                tmpGol.allocated= goalAllocatedMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c);
                            }
                            else
                            {
                                tmpGol.allocated= 0;
                            }
                            
                            if(goalAmountMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c)!=null)
                            {
                                tmpGol.allocatedAmount = goalAmountMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c);
                            }
                            else
                            {
                                tmpGol.allocatedAmount = 0;
                            }
                            tmpList.add(tmpGol);
                            mapAllocatedVal.put(apObj.entity__c+apObj.Scheme_Name_Text__c, tmpList);
                        }
                        else
                        {
                            List<ApprovedPlanBean.Goals> tmpList1 = new List<ApprovedPlanBean.Goals>();
                            ApprovedPlanBean.Goals tmpGol1 = new ApprovedPlanBean.Goals();
                            tmpGol1.goalId = golObj.Id;
                            if(goalAllocatedMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c)!=null)
                            {
                                tmpGol1.allocated= goalAllocatedMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c);
                            }else
                            {
                                tmpGol1.allocated= 0;
                            }
                            
                            if(goalAmountMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c)!=null)
                            {
                                tmpGol1.allocatedAmount = goalAmountMap.get(''+golObj.Id+apObj.entity__c+apObj.Scheme_Name_Text__c);
                            }else
                            {
                                tmpGol1.allocatedAmount = 0;
                            }
                            tmpList1.add(tmpGol1);
                            mapAllocatedVal.put(apObj.entity__c+apObj.Scheme_Name_Text__c, tmpList1); 
                        }                   
                     }
                 }
             }
         }
         return mapAllocatedVal; 
     }
    */
    /**
    * @Description: Prepare summary table for original allocated assets 
    * param: ApprovedPlanBean 
    * return type: void
    */
    public void PrpeareSummary(ApprovedPlanBean beanObj){
        beanObj.doneLumpSum = new List<ApprovedPlanBean.DoneClass>();
        beanObj.doneSIP  = new List<ApprovedPlanBean.DoneClass>();
         Map<String, double> mapLumpDoneVals = new Map<String, double>();
         Map<String, double> mapSIPDoneVals = new Map<String, double>();
         //Following variables are only for internal calculations, please dont change the values. 
         //Its risk to save this in custom labels
         String debt = 'DEBT';
         String equity = 'EQUITY';
         String gold = 'GOLD';
         
         for(ApprovedPlanBean.CurrentMFLumpSum tmpObj: beanObj.currentMFLumpSumList){
             for(ApprovedPlanBean.Goals golObj: tmpObj.golCurrMFLumpSum){
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(debt)){
                     mapLumpDoneVals = calculateTotal(mapLumpDoneVals,debt,golObj.goalId,golObj.allocatedAmount);
                  }  
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(equity)){
                     mapLumpDoneVals = calculateTotal(mapLumpDoneVals,equity ,golObj.goalId,golObj.allocatedAmount);
                 }
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(gold)){
                     mapLumpDoneVals = calculateTotal(mapLumpDoneVals,gold ,golObj.goalId,golObj.allocatedAmount);
                 }
             }
         }
         for(ApprovedPlanBean.SuggestedMFLumpSum tmpObj: beanObj.suggestedMFLumpSumList){
             for(ApprovedPlanBean.Goals golObj: tmpObj.golsuggMFLump){
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(debt)){
                     mapLumpDoneVals = calculateTotal(mapLumpDoneVals,debt,golObj.goalId,golObj.allocatedAmount);
                  }  
                 
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(equity)){
                     mapLumpDoneVals = calculateTotal(mapLumpDoneVals,equity ,golObj.goalId,golObj.allocatedAmount);
                 }
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(gold)){
                     mapLumpDoneVals = calculateTotal(mapLumpDoneVals,gold,golObj.goalId,golObj.allocatedAmount);
                 }
             }
         }
         for(ApprovedPlanBean.CurrentMFSIP tmpObj: beanObj.currentMFSIPList){
             for(ApprovedPlanBean.Goals golObj: tmpObj.golCurrMFSIP){
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(debt)){
                     mapSIPDoneVals = calculateTotal(mapSIPDoneVals ,debt,golObj.goalId,golObj.allocatedAmount);
                  }  
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(equity)){
                     mapSIPDoneVals = calculateTotal(mapSIPDoneVals ,equity ,golObj.goalId,golObj.allocatedAmount);
                 }
                 if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(gold)){
                     mapSIPDoneVals = calculateTotal(mapSIPDoneVals ,gold ,golObj.goalId,golObj.allocatedAmount);
                 }
             }
         }
         
         if(beanObj.suggestedMFSIPList != null && beanObj.suggestedMFSIPList.size() > 0)
         {
           for(ApprovedPlanBean.SuggestedMFSIP tmpObj: beanObj.suggestedMFSIPList)
           {
               if(tmpObj.golSuggMFSIP != null &&  tmpObj.golSuggMFSIP.size() > 0)
                {
                 for(ApprovedPlanBean.Goals golObj: tmpObj.golSuggMFSIP){
                     if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(debt)){
                         mapSIPDoneVals = calculateTotal(mapSIPDoneVals ,debt,golObj.goalId,golObj.allocatedAmount);
                      }  
                     if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(equity)){
                         mapSIPDoneVals = calculateTotal(mapSIPDoneVals ,equity ,golObj.goalId,golObj.allocatedAmount);
                     }
                     if(tmpObj.assetsClass !=null && (tmpObj.assetsClass.toUpperCase()).contains(gold)){
                         mapSIPDoneVals = calculateTotal(mapSIPDoneVals ,gold ,golObj.goalId,golObj.allocatedAmount);
                     }
                 }
                }
           }
         }
                 
         List<double> debtLumpList = new List<double>();
         List<double> equityLumpList = new List<double>();
         List<double> goldLumpList = new List<double>();
         List<double> debtSIPList = new List<double>();
         List<double> equitySIPList = new List<double>();
         List<double> goldSIPList = new List<double>();
         for(Goal__c golObj:beanObj.goalList){
             if(mapLumpDoneVals.get(debt+golObj.Id)!=null){
                 debtLumpList.add(mapLumpDoneVals.get(debt+golObj.Id));
             }else{
                 debtLumpList.add(0);
             }
             if(mapLumpDoneVals.get(equity+golObj.Id)!=null){
                 equityLumpList.add(mapLumpDoneVals.get(equity+golObj.Id));
             }else{
                 equityLumpList.add(0);
             }
             if(mapLumpDoneVals.get(gold+golObj.Id)!=null){
                 goldLumpList.add(mapLumpDoneVals.get(gold+golObj.Id));
             }else{
                 goldLumpList.add(0);
             }
             
             if(mapSIPDoneVals.get(debt+golObj.Id)!=null){
                 debtSIPList.add(mapSIPDoneVals.get(debt+golObj.Id));
             }else{
                 debtSIPList.add(0);
             }
             if(mapSIPDoneVals.get(equity+golObj.Id)!=null){
                 equitySIPList.add(mapSIPDoneVals.get(equity+golObj.Id));
             }else{
                 equitySIPList.add(0);
             }
             if(mapSIPDoneVals.get(gold+golObj.Id)!=null){
                 goldSIPList.add(mapSIPDoneVals.get(gold+golObj.Id));
             }else{
                 goldSIPList.add(0);
             }
         }
         
        ApprovedPlanBean.DoneClass tmp1 = new ApprovedPlanBean.DoneClass('Debt',debtLumpList);
        ApprovedPlanBean.DoneClass tmp2 = new ApprovedPlanBean.DoneClass('Equity',equityLumpList);
        ApprovedPlanBean.DoneClass tmp3 = new ApprovedPlanBean.DoneClass('Gold',goldLumpList);
        ApprovedPlanBean.DoneClass tmp4 = new ApprovedPlanBean.DoneClass('Debt', debtSIPList);
        ApprovedPlanBean.DoneClass tmp5 = new ApprovedPlanBean.DoneClass('Equity', equitySIPList);
        ApprovedPlanBean.DoneClass tmp6 = new ApprovedPlanBean.DoneClass('Gold',goldSIPList);
        
        beanObj.doneLumpSum.add(tmp1);
        beanObj.doneLumpSum.add(tmp2);
        beanObj.doneLumpSum.add(tmp3);
        
        beanObj.doneSIP.add(tmp4);
        beanObj.doneSIP.add(tmp5);
        beanObj.doneSIP.add(tmp6);
    } 
    
    /**
    * @Description: calculate total amount as per asset type per each goal 
    * param: Map, String, Id , double
    * return type: Map<String, double>
    */
    public Map<String, double> calculateTotal(Map<String, double> tmpMap, String cType, Id goalId, double amt){
        if(amt==null){
            amt = 0;
        }
        if(tmpMap.get(cType+goalId)!=null){
             double val = tmpMap.get(cType+goalId);
             val = val + amt;
             tmpMap.put(cType+goalId, val);
         }else{
             double val = 0;
             val = val + amt;
             tmpMap.put(cType+goalId, val);
        }
        return tmpMap;
    }
    /*//FS0290
    private Boolean AmountValidation(double dblTotalAmount, Double dblAllocatedAmount)
    {
      Boolean blnIsValid = true;
      if(dblTotalAmount < dblAllocatedAmount)
      {
        blnIsValid = false
      }
      return blnIsValid;
    }*/
    
    
    
    /**
    * @Description: save SIP Funds data in approve plan object and insurance object 
    * param: ApprovedPlanBean 
    * return type: 
    */
    public Pagereference saveActionPlan(ApprovedPlanBean beanObj,Map<String, ApprovedPlanBean.SIPFunds> mapStringToSIPFunds, 
    						List<Account> lstAcc, Map<String,String> mapTypeToProductNames,//Map<String,Set<String>> mapLoanTypeToLstProducts,
    						List<Product_Master__c> lstProductMaster,//Map<String,Map<String,Map<String,List<Commission__c>>>> mapProductType_PM_Comm,
    						Map<String,Map<String,Set<String>>> mapCompanyNameToProducts,
    						Map<Id,Goal__c> mapGoalIdToGoalDetails)
    {
     	system.debug('*************before lstApprove_Action_Plan1 1******'+limits.getQueries());     
        
        List<Approve_Action_Plan__c> lstUpsertActionPlan = new List<Approve_Action_Plan__c>();
        Map<String,Set<String>> innerMapCompanyNameToProducts = new Map<String,Set<String>>();
        
        EstatePlanningBean bean;
        EstatePlanningServices service;
        
        boolean isSIPAmountGreater = false;
        boolean isLumpsumAmountGreater = false;
        Boolean isMFAmountGreater = false;
        
	    //Added on 24/12/2012 : for Retrieving Family member
	    Set<Id> familyIdSet = new Set<Id>(); 
	    for(Account objAcc : lstAcc)
	    {
	       familyIdSet.add(objAcc.Id);
	    }
	    
	    
	    Map<Id,Approve_Action_Plan__c> mapIdToAP = new Map<Id,Approve_Action_Plan__c>([select Id,isWill__c,isUnallocatedRemark__c,isWillExecTracker__c,Account__c
	    				 from Approve_Action_Plan__c where AP_Status__c = 'Opened' and Account__c IN: familyIdSet]);
	    				 
       //==========Execution Tracker Will save=============
        Boolean isWillPresent = false;
        Set<Id> RecordPresent = new Set<Id>(); 
        if(beanObj.entityId!=null)
        {
            bean = new EstatePlanningBean();
            service = new EstatePlanningServices();
            for(Account objAcc : lstAcc)
            	if(objAcc.Id == beanObj.entityId)
            		bean.entity = objAcc;//service.getEntityDetails(beanObj.entityId);
            
            if(bean.entity.Will__c==true)
            {
		      Approve_Action_Plan__c willPresentInAp = new Approve_Action_Plan__c();
		      
		      for(Approve_Action_Plan__c objAP : mapIdToAP.values())
		      {
		      	  if(objAP.isWill__c)
		      	  {
		      	  	isWillPresent = true;
		      	  	willPresentInAp = objAP;
		      	  	RecordPresent.add(objAP.Id);
		      	  }
		      }
		      if(isWillPresent)
		      {
	                if(beanObj.isWillExecutionTracker == 'Yes')
	                	willPresentInAp.isWillExecTracker__c = true;
	                else
	               		willPresentInAp.isWillExecTracker__c = false;
	               		
               		lstUpsertActionPlan.add(willPresentInAp);
		      }
		      else
		      {
		      		Approve_Action_Plan__c objActionWillExec = new Approve_Action_Plan__c();
	                objActionWillExec.isWillExecTracker__c = true;
	                objActionWillExec.Account__c = beanObj.entityId;
	                objActionWillExec.isWill__c = true;
	                
	                /*Added on : 07/02/13 : Aditi Satpute : Generate New AP */
	                objActionWillExec.AP_Status__c = Label.Opened;
	                
	                if(beanObj.isWillExecutionTracker == 'Yes')
	                	objActionWillExec.isWillExecTracker__c = true;
	                else
	               		objActionWillExec.isWillExecTracker__c = false;
               		lstUpsertActionPlan.add(objActionWillExec);
		      }
              
            }  
        }
             
        double SIPSummaryTotal = 0;
        //Set<Id> ApprovePlanAccountId = new Set<Id>(); 
        List<Goal__c> lstGoalUpdate = new List<Goal__c>();
        for(ApprovedPlanBean.GoalDetails objGoals : beanObj.lstGoalDetails)
        {
        	Double lumpsumTotal  = 0;
           	Double SIPTotal  = 0;
           	if(mapGoalIdToGoalDetails.containsKey(objGoals.goalId))
           	{
           		Goal__c objGoal = mapGoalIdToGoalDetails.get(objGoals.goalId);
           		objGoal.IsDisplayDefaultProduct__c = objGoals.dispDefaultProduct;
           		objGoal.IsDisplaySIPinAP__c  = objGoals.displaySIPinAP;
           		objGoal.IsDisplayLumpsuminAP__c  = objGoals.displayLumpsuminAP;
           		lstGoalUpdate.add(objGoal);
           	}
           	system.debug('**objGoals.lstSIPFunds*'+objGoals.lstSIPFunds);
           	for(ApprovedPlanBean.SIPFunds objSIPs: objGoals.lstSIPFunds)
           	{    
            	/*Changes by Gaurav (16-5-2013):  To validate product name from SIP or not */
            	if(!(mapTypeToProductNames.get('SIP').contains('"'+objSIPs.productName+'"')))
            	{
	                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please Enter proper SIP funds name of "'+objGoals.description + '" Goal'));
	                return null;
                }
            	
                if(objSIPs.amount <= 0 || objSIPs.productName == '' || objSIPs.installments <= 0 )
                {
	                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all SIP Funds Required fields of "'+objGoals.description + '" Goal'));
	                return null;
                } 
             	Approve_Action_Plan__c tmpInsObj = new Approve_Action_Plan__c();
             	if(mapIdToAP.containsKey(objSIPs.SIPFundActionPlanId))
             	{
             		system.debug('----in if All Goal SIp Fund---');
             		tmpInsObj = mapIdToAP.get(objSIPs.SIPFundActionPlanId);
             		tmpInsObj.isSIPexecutionTracker__c =  (objSIPs.executionTracker == 'Yes') ? true : false;
	                tmpInsObj.Product_Name__c = objSIPs.productName;
	                tmpInsObj.Installments__c = objSIPs.installments;
	                tmpInsObj.Amount__c = objSIPs.amount;
	                tmpInsObj.Option__c = objSIPs.option;
	                tmpInsObj.Category__c = objSIPs.category;
	                tmpInsObj.Transaction_Type__c = objSIPs.transactionType;
	                tmpInsObj.Remarks__c = objSIPs.remarks;
	                tmpInsObj.Goal__c = objGoals.goalId;
	                
	            	//if(objSIPs.isETCreated != null && objSIPs.isETCreated )
		         	//tmpInsObj.isETCReated__c = true;
	                //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	                tmpInsObj.AP_Status__c = Label.Opened;
	                tmpInsObj.Item_Type__c = 'SIP';
	               	//lstUpdateActionPlan.add(tmpInsObj);
	                RecordPresent.add(objSIPs.SIPFundActionPlanId);
	                lstUpsertActionPlan.add(tmpInsObj);
             	}
             	else
             	{
             		system.debug('----in else All Goal SIp Fund---');
         		 	tmpInsObj.Account__c = beanObj.entityId;
         		 	tmpInsObj.isSIPexecutionTracker__c =  (objSIPs.executionTracker == 'Yes') ? true : false;
	                tmpInsObj.Product_Name__c = objSIPs.productName;
	                tmpInsObj.Installments__c = objSIPs.installments;
	                tmpInsObj.Amount__c = objSIPs.amount;
	                tmpInsObj.Option__c = objSIPs.option;
	                tmpInsObj.Category__c = objSIPs.category;
	                tmpInsObj.Transaction_Type__c = objSIPs.transactionType;
	                tmpInsObj.Remarks__c = objSIPs.remarks;
	                tmpInsObj.Goal__c = objGoals.goalId;
	                
	            	//if(objSIPs.isETCreated != null && objSIPs.isETCreated )
		         	//tmpInsObj.isETCReated__c = true;
	                //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	                tmpInsObj.AP_Status__c = Label.Opened;
	                tmpInsObj.Item_Type__c = 'SIP';
	                //lstInsertActionPlan.add(tmpInsObj);
	                lstUpsertActionPlan.add(tmpInsObj);
             	}
             	SIPTotal += objSIPs.amount;
             	//ApprovePlanAccountId.add(beanObj.entityId);
                
             	// Date : 12/12/12 : Commented due to Removal of Execution Tacker from SIP Summary Table & Added to individual SIP Funds
             	/*
             	String strKey = objSIPs.productName + '-' + objSIPs.transactionType + '-' + objSIPs.installments + '-' + objSIPs.option;
             	ApprovedPlanBean.SIPFunds objSF;
             	if(mapStringToSIPFunds.containsKey(strKey))
             	{
              	 	objSF = mapStringToSIPFunds.get(strKey);
	               	if(objSF.executionTracker == 'Yes')
	               	{
	               		tmpInsObj.isSIPexecutionTracker__c = true;
	               		objSIPs.execTracker = true;
	               	}
            		else
		            {
		               tmpInsObj.isSIPexecutionTracker__c = false;
		               objSIPs.execTracker = false;
		            }
	             
	            }
	            else
	            {
	            	if(objSIPs.executionTracker == 'Yes')
	               	{
	              		 tmpInsObj.isSIPexecutionTracker__c = true;
	               		 objSIPs.execTracker = true;
	               	}
		            else
		            {
		               tmpInsObj.isSIPexecutionTracker__c = false;
		               objSIPs.execTracker = false;
		            }
	            }*/
                //Date : 08/01/13 : Commented as per discussion with Vinita 
	            /*if(SIPTotal > (1.2*objGoals.SIP))
	            {
	              ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'SIP Funds Total should not exceed more than 20% of SIP Total for "'+objGoals.description + '" Goal'));
	              return null;
	            }*/
	        }
       
        	/*  if(objGoals.lstSIPFunds.size() ==  0)
            	isSIPAmountGreater = true;*/
            for(ApprovedPlanBean.LumpsumFunds objLumpsums: objGoals.lstLumpsumFunds)
            {    
        	  	/*Changes by Gaurav (16-5-2013):  To validate product name from lumpsum or not */ 
                if(!(mapTypeToProductNames.get('Lumpsum').contains('"'+objLumpsums.lumpsumProductName+'"')))
            	{
	                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please Enter proper Lumpsum funds product name "'+objGoals.description + '" Goal'));
	                return null;
                }  
                /*End Changes*/ 
                
                if( objLumpsums.lumpsumProductName == '' )
                {
                	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill Lumpsum Funds "Product Name" of "'+objGoals.description + '" Goal'));
	              	return null;
                }
                if(objLumpsums.lumpsumTransactionType == 'STP From' && (objLumpsums.lumpsumAmount <= 0 || objLumpsums.lumpsumProductName == '' || objLumpsums.lumpsumInstallments <= 0
         		|| objLumpsums.lumpsumFund == '' || objLumpsums.lumpsumAmountPerInstall <= 0))
                {
	              	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Lumpsum Funds Required fields of "'+objGoals.description + '" Goal'));
	              	return null;
                }	
              	if(objLumpsums.lumpsumAmount <= 0)
	            {
	              	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Lumpsum Funds "Amount" should be greater than zero for "'+objGoals.description + '" Goal'));
	                return null;
	            }
              
                Approve_Action_Plan__c tmpInsObj = new Approve_Action_Plan__c();
                if(mapIdToAP.containsKey(objLumpsums.LumpsumFundActionPlanId))
             	{
             		tmpInsObj = mapIdToAP.get(objLumpsums.LumpsumFundActionPlanId);
             		tmpInsObj.Product_Name__c = objLumpsums.lumpsumProductName;
	                tmpInsObj.Installments__c = objLumpsums.lumpsumInstallments;
	                tmpInsObj.Amount__c = objLumpsums.lumpsumAmount;
	                tmpInsObj.Option__c = objLumpsums.lumpsumOption;
	                tmpInsObj.Category__c = objLumpsums.lumpsumCategory;
	                tmpInsObj.Transaction_Type__c = objLumpsums.lumpsumTransactionType;
	                tmpInsObj.Remarks__c = objLumpsums.lumpsumRemarks;
	                tmpInsObj.Goal__c = objGoals.goalId;
	                tmpInsObj.Amount_Per_Installment__c = objLumpsums.lumpsumAmountPerInstall;
	                tmpInsObj.Fund__c = objLumpsums.lumpsumFund;
	                tmpInsObj.Item_Type__c = 'Lumpsum';
	                //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	                RecordPresent.add(objLumpsums.LumpsumFundActionPlanId);
                 	tmpInsObj.AP_Status__c = Label.Opened;
	                //Date : 12/12/12 : Added new column Execution Tracker in Lumpsum funds 
                 	tmpInsObj.isLumpsumExecTracker__c = objLumpsums.lumpsumExecutionTracker == 'Yes' ? true : false;
	               	/*if(objLumpsums.isETCreated != null )
		            {
		              if(objLumpsums.isETCreated)
	              		tmpInsObj.isETCReated__c = true;
		            }*/
		            lstUpsertActionPlan.add(tmpInsObj);
             	}
             	else
             	{
             		tmpInsObj.Account__c = beanObj.entityId;
	                tmpInsObj.Product_Name__c = objLumpsums.lumpsumProductName;
	                tmpInsObj.Installments__c = objLumpsums.lumpsumInstallments;
	                tmpInsObj.Amount__c = objLumpsums.lumpsumAmount;
	                tmpInsObj.Option__c = objLumpsums.lumpsumOption;
	                tmpInsObj.Category__c = objLumpsums.lumpsumCategory;
	                tmpInsObj.Transaction_Type__c = objLumpsums.lumpsumTransactionType;
	                tmpInsObj.Remarks__c = objLumpsums.lumpsumRemarks;
	                tmpInsObj.Goal__c = objGoals.goalId;
	                tmpInsObj.Amount_Per_Installment__c = objLumpsums.lumpsumAmountPerInstall;
	                tmpInsObj.Fund__c = objLumpsums.lumpsumFund;
	                tmpInsObj.Item_Type__c = 'Lumpsum';
	                /*if(objLumpsums.isETCreated != null )
		            {
		              if(objLumpsums.isETCreated)
		              tmpInsObj.isETCReated__c = true;
		            }*/
		            //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	                tmpInsObj.AP_Status__c = Label.Opened;
	                //Date : 12/12/12 : Added new column Execution Tracker in Lumpsum funds 
	                tmpInsObj.isLumpsumExecTracker__c = (objLumpsums.lumpsumExecutionTracker == 'Yes') ? true : false;
	                lstUpsertActionPlan.add(tmpInsObj);
             	}
                lumpsumTotal +=  objLumpsums.lumpsumAmount;
                 
              
                //Date : 08/01/13 : Commented as per discussion with Vinita 
                /*if(lumpsumTotal >( 1.2*objGoals.lumpsum))
                {
                  ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Lumpsum Funds Total should not exceed more than 20% of Lumpsum Total for "'+objGoals.description + '" Goal'));
                  return null;
                }*/
                /*if(objLumpsums.lumpsumAmount > 0)
	            {
	                isLumpsumAmountGreater = true;
	                UpsertLumpsumList.add(tmpInsObj); 
	            }*/
            }
            
            objGoals.LumpsumTotal = lumpsumTotal;
            objGoals.SIPTotal = SIPTotal;
            SIPSummaryTotal += SIPTotal; 
            
           /* if(objGoals.lstLumpsumFunds.size() ==  0)
            	isLumpsumAmountGreater = true;*/
       }
       
       //============================Save Emergency Fund's Sip ============================
       List<GoalSIPAmount__c> lstGoalSIPAmount = [Select SIP_Total__c, SIP_Gold__c, SIP_Equity__c, SIP_Debt__c, Goal__c 
				                                  From GoalSIPAmount__c 
				                                  where Goal__c = :beanObj.objEmergencyFundGoalDetails.goalId and isNewSIP__c = true];
           		                       
       delete lstGoalSIPAmount;
           
       GoalSIPAmount__c objGoalSIPAmount = new GoalSIPAmount__c();
       objGoalSIPAmount.SIP_Gold__c = beanObj.objEmergencyFundGoalDetails.goldAmt;
       objGoalSIPAmount.SIP_Equity__c = beanObj.objEmergencyFundGoalDetails.equityAmt;
       objGoalSIPAmount.SIP_Debt__c = beanObj.objEmergencyFundGoalDetails.debtAmt;
       objGoalSIPAmount.Goal__c = beanObj.objEmergencyFundGoalDetails.goalId;
       objGoalSIPAmount.Goal_Year__c = Date.today().year();
       objGoalSIPAmount.SIP_Outflow__c = true;
       upsert objGoalSIPAmount;
          
       beanObj.objEmergencyFundGoalDetails.SIP = beanObj.objEmergencyFundGoalDetails.equityAmt + beanObj.objEmergencyFundGoalDetails.debtAmt + beanObj.objEmergencyFundGoalDetails.goldAmt;
        
        if(beanObj.objEmergencyFundGoalDetails.SIP != 0)
        {
       		beanObj.objEmergencyFundGoalDetails.equityPerc = (beanObj.objEmergencyFundGoalDetails.equityAmt * 100)/beanObj.objEmergencyFundGoalDetails.SIP;
          	beanObj.objEmergencyFundGoalDetails.debtPerc = (beanObj.objEmergencyFundGoalDetails.debtAmt * 100)/beanObj.objEmergencyFundGoalDetails.SIP;
          	beanObj.objEmergencyFundGoalDetails.goldPerc = (beanObj.objEmergencyFundGoalDetails.goldAmt * 100)/beanObj.objEmergencyFundGoalDetails.SIP;
        }  
        else
        {
          	beanObj.objEmergencyFundGoalDetails.equityPerc = 0;
         	beanObj.objEmergencyFundGoalDetails.debtPerc = 0;
          	beanObj.objEmergencyFundGoalDetails.goldPerc = 0;
        }            
          
        //============================Save Emergency Fund's Lumpsum ============================
           
        Approve_Action_Plan__c objLumpsumApproveActionPlan = new Approve_Action_Plan__c();
    	system.debug('-----beanObj.objEmergencyFundLumpsum.EmergencyLumpsumActionPlanId--'+beanObj.objEmergencyFundLumpsum.EmergencyLumpsumActionPlanId);
    	if(mapGoalIdToGoalDetails.containsKey(beanObj.objEmergencyFundGoalDetails.goalId))
       	{
       		Goal__c objGoal = mapGoalIdToGoalDetails.get(beanObj.objEmergencyFundGoalDetails.goalId);
       		objGoal.IsDisplayDefaultProduct__c = beanObj.objEmergencyFundGoalDetails.dispDefaultProduct;
       		objGoal.IsDisplaySIPinAP__c  = beanObj.objEmergencyFundGoalDetails.displaySIPinAP;
           	objGoal.IsDisplayLumpsuminAP__c  = beanObj.objEmergencyFundGoalDetails.displayLumpsuminAP;
       		lstGoalUpdate.add(objGoal);
       	}
    	if(beanObj.objEmergencyFundLumpsum.EmergencyLumpsumActionPlanId != '')
    	{
    		if(mapIdToAP.containsKey(beanObj.objEmergencyFundLumpsum.EmergencyLumpsumActionPlanId))
	 		{
	       		objLumpsumApproveActionPlan = mapIdToAP.get(beanObj.objEmergencyFundLumpsum.EmergencyLumpsumActionPlanId);
	       		objLumpsumApproveActionPlan.Lumpsum_Gold__c = beanObj.objEmergencyFundLumpsum.lumpsumGoldAmt;
		        objLumpsumApproveActionPlan.Lumpsum_Debt__c = beanObj.objEmergencyFundLumpsum.lumpsumDebtAmt;
		        objLumpsumApproveActionPlan.Lumpsum_Equity__c = beanObj.objEmergencyFundLumpsum.lumpsumEquityAmt;
		        objLumpsumApproveActionPlan.Goal__c = beanObj.objEmergencyFundLumpsum.goalId;
		        objLumpsumApproveActionPlan.Item_Type__c = 'Lumpsum';
		        //Added on : 07/02/13 : Aditi Satpute : Generate New AP
		        RecordPresent.add(beanObj.objEmergencyFundLumpsum.EmergencyLumpsumActionPlanId);
		        objLumpsumApproveActionPlan.AP_Status__c = Label.Opened;
		        lstUpsertActionPlan.add(objLumpsumApproveActionPlan);
	 		}
	 		else
	 		{
	 			objLumpsumApproveActionPlan.Lumpsum_Gold__c = beanObj.objEmergencyFundLumpsum.lumpsumGoldAmt;
		        objLumpsumApproveActionPlan.Lumpsum_Debt__c = beanObj.objEmergencyFundLumpsum.lumpsumDebtAmt;
		        objLumpsumApproveActionPlan.Lumpsum_Equity__c = beanObj.objEmergencyFundLumpsum.lumpsumEquityAmt;
		        objLumpsumApproveActionPlan.Goal__c = beanObj.objEmergencyFundLumpsum.goalId;
		        objLumpsumApproveActionPlan.Item_Type__c = 'Lumpsum';
		        objLumpsumApproveActionPlan.Account__c = beanObj.entityId;
		        
		        //Added on : 07/02/13 : Aditi Satpute : Generate New AP
		        objLumpsumApproveActionPlan.AP_Status__c = Label.Opened;
		        lstUpsertActionPlan.add(objLumpsumApproveActionPlan);
	 		}
    	}
    	else
 		{
 			objLumpsumApproveActionPlan.Lumpsum_Gold__c = beanObj.objEmergencyFundLumpsum.lumpsumGoldAmt;
	        objLumpsumApproveActionPlan.Lumpsum_Debt__c = beanObj.objEmergencyFundLumpsum.lumpsumDebtAmt;
	        objLumpsumApproveActionPlan.Lumpsum_Equity__c = beanObj.objEmergencyFundLumpsum.lumpsumEquityAmt;
	        objLumpsumApproveActionPlan.Goal__c = beanObj.objEmergencyFundLumpsum.goalId;
	        objLumpsumApproveActionPlan.Item_Type__c = 'Lumpsum';
	        objLumpsumApproveActionPlan.Account__c = beanObj.entityId;
	        //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	        objLumpsumApproveActionPlan.AP_Status__c = Label.Opened;
	        lstUpsertActionPlan.add(objLumpsumApproveActionPlan);
 		}
        //UpsertEmergencyLumpsumList.add(objLumpsumApproveActionPlan);
        beanObj.objEmergencyFundLumpsum.lumpsum = beanObj.objEmergencyFundLumpsum.lumpsumEquityAmt + beanObj.objEmergencyFundLumpsum.lumpsumDebtAmt + beanObj.objEmergencyFundLumpsum.lumpsumGoldAmt;
        if(beanObj.objEmergencyFundLumpsum.lumpsum !=0)
        {
          	beanObj.objEmergencyFundLumpsum.lumpsumEquityPerc = (beanObj.objEmergencyFundLumpsum.lumpsumEquityAmt * 100)/beanObj.objEmergencyFundLumpsum.lumpsum;
          	beanObj.objEmergencyFundLumpsum.lumpsumDebtPerc = (beanObj.objEmergencyFundLumpsum.lumpsumDebtAmt * 100)/beanObj.objEmergencyFundLumpsum.lumpsum;
          	beanObj.objEmergencyFundLumpsum.lumpsumGoldPerc = (beanObj.objEmergencyFundLumpsum.lumpsumGoldAmt * 100)/beanObj.objEmergencyFundLumpsum.lumpsum;
        }
        else
        {
          	beanObj.objEmergencyFundLumpsum.lumpsumEquityPerc = 0;
          	beanObj.objEmergencyFundLumpsum.lumpsumDebtPerc = 0;
         	beanObj.objEmergencyFundLumpsum.lumpsumGoldPerc = 0;
        }
        //============================Save Emergency Fund's Sip Funds=============================
        double emergencySIPTotal = 0;
        double emergencyLumpsumTotal = 0;
         
        for(ApprovedPlanBean.SIPFunds objSIPs: beanObj.objEmergencyFundGoalDetails.lstSIPFunds)
        {    
        	//Added on : 06/08/13 : Gaurav : Message to Enter Proper SIP Name
            if(!(mapTypeToProductNames.get('SIP').contains('"'+objSIPs.productName+'"')))
        	{
                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please Enter proper SIP funds name of "Emergency Funds" Goal '));
                return null;
            }
            
            if(objSIPs.amount <= 0 || objSIPs.productName == '' || objSIPs.installments <= 0)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all SIP Funds Required fields of "Emergency Funds" Goal'));
            	return null;
            }
            /* else
            {
          		isSIPAmountGreater = true;
          		UpsertEmergencySIPList.add(tmpInsObj); 
          
            }*/
           	Approve_Action_Plan__c tmpInsObj = new Approve_Action_Plan__c();
           	system.debug('----in  Emergency Fund Goal SIp Fund-objSIPs.SIPFundActionPlanId--'+objSIPs.SIPFundActionPlanId);
			if(mapIdToAP.containsKey(objSIPs.SIPFundActionPlanId))
         	{
         		system.debug('----in if Emergency Fund Goal SIp Fund---');
     			tmpInsObj = mapIdToAP.get(objSIPs.SIPFundActionPlanId);
     			tmpInsObj.Product_Name__c = objSIPs.productName;
	            tmpInsObj.Installments__c = objSIPs.installments;
	            tmpInsObj.Amount__c = objSIPs.amount;
	            tmpInsObj.Option__c = objSIPs.option;
	            tmpInsObj.Category__c = objSIPs.category;
	            tmpInsObj.Transaction_Type__c = objSIPs.transactionType;
	            tmpInsObj.Remarks__c = objSIPs.remarks;
	            tmpInsObj.Goal__c = beanObj.objEmergencyFundGoalDetails.goalId;
	          	/*if(objSIPs.isETCreated != null )
	            {
		          if(objSIPs.isETCreated)
		            tmpInsObj.isETCReated__c = true;
	            }*/
	            //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	            tmpInsObj.AP_Status__c = Label.Opened;
	            RecordPresent.add(objSIPs.SIPFundActionPlanId);
	            tmpInsObj.Item_Type__c = 'SIP';
	            tmpInsObj.isSIPexecutionTracker__c = (objSIPs.executionTracker == 'Yes') ? true : false;
	            //lstUpdateActionPlan.add(tmpInsObj);
	            lstUpsertActionPlan.add(tmpInsObj);
         	}
         	else
         	{
         		system.debug('----in else Emergency Fund Goal SIp Fund---');
                tmpInsObj.isSIPexecutionTracker__c = (objSIPs.executionTracker == 'Yes') ? true : false;
                tmpInsObj.Account__c = beanObj.entityId;
	            tmpInsObj.Product_Name__c = objSIPs.productName;
	            tmpInsObj.Installments__c = objSIPs.installments;
	            tmpInsObj.Amount__c = objSIPs.amount;
	            tmpInsObj.Option__c = objSIPs.option;
	            tmpInsObj.Category__c = objSIPs.category;
	            tmpInsObj.Transaction_Type__c = objSIPs.transactionType;
	            tmpInsObj.Remarks__c = objSIPs.remarks;
	            tmpInsObj.Goal__c = beanObj.objEmergencyFundGoalDetails.goalId;
	          /*  if(objSIPs.isETCreated != null )
	            {
		          if(objSIPs.isETCreated)
		            tmpInsObj.isETCReated__c = true;
	            }*/
	            //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	            tmpInsObj.AP_Status__c = Label.Opened;
	            
	            tmpInsObj.Item_Type__c = 'SIP';
             	//lstInsertActionPlan.add(tmpInsObj);
             	lstUpsertActionPlan.add(tmpInsObj);
         	}
         	emergencySIPTotal += objSIPs.amount;
           	// Date : 12/12/12 : Commented due to Removal of Execution Tacker from SIP Summary Table & Added to individual SIP Funds 
         	/*  
         	String strKey = objSIPs.productName + '-' + objSIPs.transactionType + '-' + objSIPs.installments + '-' + objSIPs.option;
         	ApprovedPlanBean.SIPFunds objSF;
         	if(mapStringToSIPFunds.containsKey(strKey))
           	{
	             objSF = mapStringToSIPFunds.get(strKey);
	             if(objSF.executionTracker == 'Yes')
	             {
	             tmpInsObj.isSIPexecutionTracker__c = true;
	             objSIPs.execTracker = true;
	             }
	           else
	           {
	             tmpInsObj.isSIPexecutionTracker__c = false;
	             objSIPs.execTracker = false;
	           }
	           }
	           else
	           {
	             if(objSIPs.executionTracker == 'Yes')
	             {
	             tmpInsObj.isSIPexecutionTracker__c = true;
	             objSIPs.execTracker = true;
	             }
	           else
	           {
	             tmpInsObj.isSIPexecutionTracker__c = false;
	             objSIPs.execTracker = false;
	           }
	        }*/
            //ApprovePlanAccountId.add(beanObj.entityId);
	        //Date : 08/01/13 : Commented as per discussion with Vinita 
	        /*if(emergencySIPTotal > (1.2*beanObj.objEmergencyFundGoalDetails.SIP) )
	           {
	            ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'SIP Funds Total should not exceed more than 20% of SIP Total for "Emergency Funds" Goal'));
	            return null;
	          }
	        */	
           
           
            
        }
        beanObj.objEmergencyFundGoalDetails.SIPTotal = emergencySIPTotal;
        if(beanObj.objEmergencyFundGoalDetails.lstSIPFunds.size() ==  0)
        	isSIPAmountGreater = true;
        SIPSummaryTotal += emergencySIPTotal;   
        beanObj.SIPSummaryTotal = SIPSummaryTotal;
        //=================================================================================================================    
            
        //============================Save Emergency Fund's Lumpsum Funds=============================
        for(ApprovedPlanBean.LumpsumFunds objLumpsums: beanObj.objEmergencyFundGoalDetails.lstLumpsumFunds)
        {    
        	/* Gaurav (15-5-2013) : To validate entered product name of Lumpsum is available in lumpsum product name list */   
          	if(!(mapTypeToProductNames.get('Lumpsum').contains('"'+objLumpsums.lumpsumProductName+'"')))
          	{
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please Enter proper Lumpsum funds product name of "Emergency Funds" Goal'));
                return null;
          	}  
            /* End Changes */
            if( objLumpsums.lumpsumProductName == '' )
           	{
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill Lumpsum Funds "Product Name" of "Emergency Funds" Goal'));
              	return null;
           	}
            if(objLumpsums.lumpsumTransactionType == 'STP From' && (objLumpsums.lumpsumAmount <= 0 || objLumpsums.lumpsumProductName == '' || objLumpsums.lumpsumInstallments <= 0
                 || objLumpsums.lumpsumFund == '' || objLumpsums.lumpsumAmountPerInstall <= 0))
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Lumpsum Funds Required fields of "Emergency Funds" Goal'));
              	return null;
            }
        	if(objLumpsums.lumpsumAmount <= 0)
        	{
        		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Lumpsum Funds "Amount" should be greater than zero for "Emergency Funds" Goal'));
                return null;
        	}
            /*if(objLumpsums.lumpsumAmount > 0)
           	{
	        	isLumpsumAmountGreater = true;
	            UpsertEmergencyLumpsumList.add(tmpInsObj); 
            }*/ 
            
       		Approve_Action_Plan__c tmpInsObj = new Approve_Action_Plan__c();
       		if(mapIdToAP.containsKey(objLumpsums.LumpsumFundActionPlanId))
     		{
            	tmpInsObj = mapIdToAP.get(objLumpsums.LumpsumFundActionPlanId);
        		tmpInsObj.Product_Name__c = objLumpsums.lumpsumProductName;
		      	tmpInsObj.Installments__c = objLumpsums.lumpsumInstallments;
		        tmpInsObj.Amount__c = objLumpsums.lumpsumAmount;
		        tmpInsObj.Option__c = objLumpsums.lumpsumOption;
		        tmpInsObj.Category__c = objLumpsums.lumpsumCategory;
		        tmpInsObj.Transaction_Type__c = objLumpsums.lumpsumTransactionType;
		        tmpInsObj.Remarks__c = objLumpsums.lumpsumRemarks;
		        tmpInsObj.Goal__c = beanObj.objEmergencyFundGoalDetails.goalId;
		        tmpInsObj.Amount_Per_Installment__c = objLumpsums.lumpsumAmountPerInstall;
	       		/*if(objLumpsums.isETCreated != null )
	       		{
	          		if(objLumpsums.isETCreated)
	           			tmpInsObj.isETCReated__c = true;
	       		}*/
	       		tmpInsObj.Fund__c = objLumpsums.lumpsumFund;
	       		tmpInsObj.Item_Type__c = 'Lumpsum';
	       		//Added on : 07/02/13 : Aditi Satpute : Generate New AP
	       		RecordPresent.add(objLumpsums.LumpsumFundActionPlanId);
	       		tmpInsObj.AP_Status__c = Label.Opened;
         		tmpInsObj.isLumpsumExecTracker__c = (objLumpsums.lumpsumExecutionTracker == 'Yes') ? true : false;
         		lstUpsertActionPlan.add(tmpInsObj);
         		
            }
            else
            {
            	tmpInsObj.Account__c = beanObj.entityId;
		       	tmpInsObj.Product_Name__c = objLumpsums.lumpsumProductName;
		      	tmpInsObj.Installments__c = objLumpsums.lumpsumInstallments;
		        tmpInsObj.Amount__c = objLumpsums.lumpsumAmount;
		        tmpInsObj.Option__c = objLumpsums.lumpsumOption;
		        tmpInsObj.Category__c = objLumpsums.lumpsumCategory;
		        tmpInsObj.Transaction_Type__c = objLumpsums.lumpsumTransactionType;
		        tmpInsObj.Remarks__c = objLumpsums.lumpsumRemarks;
		        tmpInsObj.Goal__c = beanObj.objEmergencyFundGoalDetails.goalId;
		        tmpInsObj.Amount_Per_Installment__c = objLumpsums.lumpsumAmountPerInstall;
	       		/*if(objLumpsums.isETCreated != null )
	       		{
	          		if(objLumpsums.isETCreated)
	           			tmpInsObj.isETCReated__c = true;
	       		}*/
	       		tmpInsObj.Fund__c = objLumpsums.lumpsumFund;
	       		tmpInsObj.Item_Type__c = 'Lumpsum';
	       		//Added on : 07/02/13 : Aditi Satpute : Generate New AP
	       		tmpInsObj.AP_Status__c = Label.Opened;
         		tmpInsObj.isLumpsumExecTracker__c = (objLumpsums.lumpsumExecutionTracker == 'Yes') ? true : false;
         		lstUpsertActionPlan.add(tmpInsObj);
            }
      		emergencyLumpsumTotal += objLumpsums.lumpsumAmount; 
            //Date : 08/01/13 : Commented as per discussion with Vinita 
            /*
            	if(emergencyLumpsumTotal >  (1.2*beanObj.objEmergencyFundLumpsum.lumpsum))
	            {
	              ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Lumpsum Funds Total should not exceed more than 20% of Lumpsum Total for "Emergency Funds" Goal'));
	              return null;
	            }
            */
              
        }
        beanObj.objEmergencyFundGoalDetails.LumpsumTotal =  emergencyLumpsumTotal;
       /* if(beanObj.objEmergencyFundGoalDetails.lstLumpsumFunds.size() ==  0)
        	isLumpsumAmountGreater = true;*/
    	
      
       
       /*   List<Approve_Action_Plan__c> lstApprove_Action_Plan  = [Select a.Transaction_Type__c,
                                            a.Remarks__c,a.Goal__c ,
                                            a.Amount__c,a.Product_Name__c, 
                                            a.Option__c, a.Installments__c, 
                                            a.CreatedDate, a.Category__c,isLumpsumExecTracker__c
                                            From Approve_Action_Plan__c a where Account__c IN: familyIdSet and Item_Type__c = 'Lumpsum'
                                            and AP_Status__c = 'Opened'];
            system.debug('*************lstApprove_Action_Plan 1******'+limits.getQueries());
                                              
           if(!lstApprove_Action_Plan.isEmpty())
             delete lstApprove_Action_Plan;
            */ 
        /* UpsertList.addAll(UpsertEmergencySIPList);
         UpsertList.addAll(UpsertLumpsumList);
         UpsertList.addAll(UpsertEmergencyLumpsumList);
         upsert UpsertList;*/
        
        /*=========================================Prajakta - 19-8-2013======ADVICE ON EXISTIING GOLD & SILVER SCHEMES==============================================*/
        
        List<Approve_Action_Plan__c> lstUpsertCurrentGoldSilver = new List<Approve_Action_Plan__c>();
        List<Approve_Action_Plan__c> lstUpsertSIPCurrentGoldSilver = new List<Approve_Action_Plan__c>();
        Map<Id,ApprovedPlanBean.CurrentGoldSilver> mapIdToSIPGoldSilver = new Map<Id,ApprovedPlanBean.CurrentGoldSilver>();
        Map<Id,Investment_Asset__c> mapIdToInvestmentAsset = new  Map<Id,Investment_Asset__c>
                                  ([Select Monthly_SIP_Amount__c, Entity__c, Asset_Type__c,Scheme_Name_Text__c, 
											Entity__r.FirstName, Entity__r.LastName, Asset_Name__c, TotalAsset__c ,
											RecordType.Name, Allocated_Amount__c,  Action__c 
									From Investment_Asset__c  
									where  Entity__c =: familyIdSet
									and  (RecordType.Name = 'Gold and Silver' or RecordType.Name = 'Mutual Fund')]);    
        for(ApprovedPlanBean.CurrentGoldSilver objSIPCurrentGoldSilver: beanObj.lstSIPCurrentGold)
        {
	    	if(objSIPCurrentGoldSilver.currentSIP < objSIPCurrentGoldSilver.SIPactionAmount)
	        {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Action Amount "'
					            		+objSIPCurrentGoldSilver.SIPactionAmount+'" of Gold and Silver-Running SIP scheme "'
					            		+objSIPCurrentGoldSilver.schemeName+'" cannot be greater than Current SIP "'
					            		+objSIPCurrentGoldSilver.currentSIP+'".'));
            	return null;
          	}
            if(!mapIdToSIPGoldSilver.containsKey(objSIPCurrentGoldSilver.investmentId))
          	{
            	mapIdToSIPGoldSilver.put(objSIPCurrentGoldSilver.investmentId,objSIPCurrentGoldSilver);
          	}
        }
        system.debug('--------mapIdToSIPGoldSilver----------'+mapIdToSIPGoldSilver);
        List<ApprovedPlanBean.CurrentGoldSilver> lstCurrentGoldSilver = new List<ApprovedPlanBean.CurrentGoldSilver>();
            
        for(Id InvestmentId : beanObj.mapIdToCurrentGold.keySet())
        { 
        	Double totalActionAmount = 0;
          	lstCurrentGoldSilver = beanObj.mapIdToCurrentGold.get(InvestmentId);
          	for(ApprovedPlanBean.CurrentGoldSilver objCurrentGoldSilver : lstCurrentGoldSilver)
          	{ 
            	if(objCurrentGoldSilver.amount != null && objCurrentGoldSilver.actionAmount != null)
                {
                	if(Math.ceil(objCurrentGoldSilver.amount) < Math.ceil(objCurrentGoldSilver.actionAmount) )
                  	{
                   		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Action amount "'
                   								+Math.ceil(objCurrentGoldSilver.actionAmount)+'" of Gold and Silver - Lumpsum scheme "'
                   								+objCurrentGoldSilver.schemeName+'" cannot be greater than Amount "'
                   								+Math.ceil(objCurrentGoldSilver.amount)+'".'));
                    	return null;
                  	}
                  	totalActionAmount += objCurrentGoldSilver.actionAmount;
                 	Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
                 	if(objCurrentGoldSilver.GoldSilverActionPlanId != '')
                 	{
                 		if(mapIdToAP.containsKey(objCurrentGoldSilver.GoldSilverActionPlanId))
			         	{
			         		system.debug('----in Gold Silver---');
			     			objApprovePlan = mapIdToAP.get(objCurrentGoldSilver.GoldSilverActionPlanId); 
			     			RecordPresent.add(objCurrentGoldSilver.GoldSilverActionPlanId);
			         	}
			         	else
			         	{
			         		objApprovePlan.Account__c = objCurrentGoldSilver.account;
			         	}
                 	}
                 	else
                 	{
                 		objApprovePlan.Account__c = objCurrentGoldSilver.account;
                 	}
                 	
               	  	objApprovePlan.Asset_Name__c = objCurrentGoldSilver.schemeName;
                  	objApprovePlan.Action_Amount__c = objCurrentGoldSilver.actionAmount;
                  	//Added on : 07/02/13 : Aditi Satpute : Generate New AP
                  	objApprovePlan.AP_Status__c = Label.Opened;
            
	               	objApprovePlan.Amount__c = objCurrentGoldSilver.amount;
	                objApprovePlan.Asset_Class__c = objCurrentGoldSilver.assetClass;
	               
	               	if(objCurrentGoldSilver.isNewGoldSilver != null && objCurrentGoldSilver.isNewGoldSilver)
	                	objApprovePlan.isNewGoldSilver__c = true;
	                 
	               	if(objCurrentGoldSilver.executionTracker == 'Yes')
	                	objApprovePlan.isGS_ExecutionTracker__c = true;
	                else
	                	objApprovePlan.isGS_ExecutionTracker__c = false;
                 
	                //Added on : 02/04/13 : Aditi Satpute : As no ET should be created for Action None : ET Screen changes
	                if((objCurrentGoldSilver.lumpsumAction == '') || (objCurrentGoldSilver.lumpsumAction == '--None--') || (objCurrentGoldSilver.lumpsumAction == null))
	                   	objApprovePlan.isGS_ExecutionTracker__c = false;
	                     
	                objApprovePlan.Current_SIP__c = objCurrentGoldSilver.currentSIP;
	                objApprovePlan.Lumpsum_Action__c = objCurrentGoldSilver.lumpsumAction;
	                objApprovePlan.Investment_Asset__c = objCurrentGoldSilver.investmentId;
               
	                if(mapIdToSIPGoldSilver.containsKey(objCurrentGoldSilver.investmentId))
	                {
	                	system.debug('******in if **'+objCurrentGoldSilver.investmentId);
	                	
		              	ApprovedPlanBean.CurrentGoldSilver objSIPMFunds = mapIdToSIPGoldSilver.get(objCurrentGoldSilver.investmentId);
		                 
		                objApprovePlan.SIP_Action__c = objSIPMFunds.SIPaction;
		                objApprovePlan.SIP_Action_Amount__c = objSIPMFunds.SIPactionAmount;
		                
		                if(objSIPMFunds.SIPexecutionTracker == 'Yes')
		                	objApprovePlan.isGSsip_ExecutionTracker__c = true;
		                else
		                    objApprovePlan.isGSsip_ExecutionTracker__c = false;
               		}
               		
           		   	
		            lstUpsertActionPlan.add(objApprovePlan);
                  
                   	if(lstCurrentGoldSilver.size() > 1 && objApprovePlan.Action_Amount__c <= 0)
                   	{
                      	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Gold and Silver Action Amount should be greater than Zero'));
                      	return null;
                   	}
               	}
            }
          /*  system.debug('****mapIdToInvestmentAssetGold.get(InvestmentId).TotalAsset__c**'+mapIdToInvestmentAssetGold.get(InvestmentId).TotalAsset__c);
            system.debug('******totalActionAmount**'+totalActionAmount);
			if(Math.ceil(mapIdToInvestmentAssetGold.get(InvestmentId).TotalAsset__c) < Math.ceil(totalActionAmount))
            {
           		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING, 'Total Action Amount "'
					                			+totalActionAmount+'" of Gold and Silver-Lumpsum scheme "'
					                			+mapIdToInvestmentAssetGold.get(InvestmentId).Asset_Name__c+'" cannot be greater than Amount "'
					                			+Math.ceil(mapIdToInvestmentAssetGold.get(InvestmentId).TotalAsset__c)+'".'));
	            return null;
            }*/
            system.debug('****mapIdToInvestmentAsset.get(InvestmentId).TotalAsset__c**'+mapIdToInvestmentAsset.get(InvestmentId).TotalAsset__c);
            system.debug('******totalActionAmount**'+totalActionAmount);
			if(Math.ceil(mapIdToInvestmentAsset.get(InvestmentId).TotalAsset__c) < Math.ceil(totalActionAmount))
            {
           		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING, 'Total Action Amount "'
					                			+totalActionAmount+'" of Gold and Silver-Lumpsum scheme "'
					                			+mapIdToInvestmentAsset.get(InvestmentId).Asset_Name__c+'" cannot be greater than Amount "'
					                			+Math.ceil(mapIdToInvestmentAsset.get(InvestmentId).TotalAsset__c)+'".'));
	            return null;
            }
		}
          
/*=============================================================End - Prajakta - Gold and Silver======================================================= */
 

        /*/============ADVICE ON EXISTIING MUTUAL FUND SCHEMES==============================================================*/
        List<Approve_Action_Plan__c> lstUpsertCurrentMutualFunds = new List<Approve_Action_Plan__c>();
        List<Approve_Action_Plan__c> lstUpsertSIPCurrentMutualFunds = new List<Approve_Action_Plan__c>();
        // Map<String,List<ApprovedPlanBean.CurrentMutualFunds>> mapActionToCurrentMFlist = new Map<String,List<ApprovedPlanBean.CurrentMutualFunds>>();
        //Map<String,List<ApprovedPlanBean.CurrentMutualFunds>> mapActionToCurrentMFSIPlist = new Map<String,List<ApprovedPlanBean.CurrentMutualFunds>>();
        Map<Id,ApprovedPlanBean.CurrentMutualFunds> mapIdToSIPMutualFunds = new Map<Id,ApprovedPlanBean.CurrentMutualFunds>();
            
        for(ApprovedPlanBean.CurrentMutualFunds objSIPCurrentMutualFunds: beanObj.lstSIPCurrentFunds)
        {
	    	if(objSIPCurrentMutualFunds.currentSIP < objSIPCurrentMutualFunds.SIPactionAmount)
	        {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Action Amount "'
            		+objSIPCurrentMutualFunds.SIPactionAmount+'" of Mutual Fund-Running SIP scheme "'+objSIPCurrentMutualFunds.schemeName+'" cannot be greater than Current SIP "'+objSIPCurrentMutualFunds.currentSIP+'".'));
            	return null;
          	}
            if(!mapIdToSIPMutualFunds.containsKey(objSIPCurrentMutualFunds.investmentId))
          	{
            	mapIdToSIPMutualFunds.put(objSIPCurrentMutualFunds.investmentId,objSIPCurrentMutualFunds);
          	}
	        //Added code for displaying Action wise in pdf
           	/*List<ApprovedPlanBean.CurrentMutualFunds> lstCurrentMFSIPalreadyExists = new List<ApprovedPlanBean.CurrentMutualFunds>();
           	if(beanObj.mapActionToCurrentMFSIPlist.containsKey(objSIPCurrentMutualFunds.SIPaction))
           	{
	             lstCurrentMFSIPalreadyExists = beanObj.mapActionToCurrentMFSIPlist.get(objSIPCurrentMutualFunds.SIPaction);
	             lstCurrentMFSIPalreadyExists.add(objSIPCurrentMutualFunds);
          	 }
           	 else
             	lstCurrentMFSIPalreadyExists.add(objSIPCurrentMutualFunds);
           	 beanObj.mapActionToCurrentMFSIPlist.put(objSIPCurrentMutualFunds.SIPaction,lstCurrentMFSIPalreadyExists);*/
              
        }
        List<ApprovedPlanBean.CurrentMutualFunds> lstCurrentMutualFunds = new List<ApprovedPlanBean.CurrentMutualFunds>();
            
        for(Id InvestmentId : beanObj.mapIdToCurrentFunds.keySet())
        { 
        	Double totalActionAmount = 0;
          	lstCurrentMutualFunds = beanObj.mapIdToCurrentFunds.get(InvestmentId);
          	for(ApprovedPlanBean.CurrentMutualFunds objCurrentMutualFunds : lstCurrentMutualFunds)
          	{ 
            	if(objCurrentMutualFunds.amount != null && objCurrentMutualFunds.actionAmount != null)
                {
                	if(Math.ceil(objCurrentMutualFunds.amount) < Math.ceil(objCurrentMutualFunds.actionAmount) )
                  	{
                   		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Action amount "'
                   				+Math.ceil(objCurrentMutualFunds.actionAmount)+'" of Mutual Fund - Lumpsum scheme "'+objCurrentMutualFunds.schemeName+'" cannot be greater than Amount "'+Math.ceil(objCurrentMutualFunds.amount)+'".'));
                    	return null;
                  	}
                  	totalActionAmount += objCurrentMutualFunds.actionAmount;
                 	Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
                 	if(objCurrentMutualFunds.MutualFundActionPlanId != '')
                 	{
                 		if(mapIdToAP.containsKey(objCurrentMutualFunds.MutualFundActionPlanId))
			         	{
			         		system.debug('----in Mutual Fund---');
			     			objApprovePlan = mapIdToAP.get(objCurrentMutualFunds.MutualFundActionPlanId); 
			     			RecordPresent.add(objCurrentMutualFunds.MutualFundActionPlanId);
			         	}
			         	else
			         	{
			         		objApprovePlan.Account__c = objCurrentMutualFunds.account;
			         	}
                 	}
                 	else
                 	{
                 		objApprovePlan.Account__c = objCurrentMutualFunds.account;
                 	}
                 	
               	  	objApprovePlan.Scheme_Name__c = objCurrentMutualFunds.schemeName;
                  	objApprovePlan.Action_Amount__c = objCurrentMutualFunds.actionAmount;
                  	//Added on : 07/02/13 : Aditi Satpute : Generate New AP
                  	objApprovePlan.AP_Status__c = Label.Opened;
            
	               	objApprovePlan.Amount__c = objCurrentMutualFunds.amount;
	                objApprovePlan.Asset_Class__c = objCurrentMutualFunds.assetClass;
	               
	               	if(objCurrentMutualFunds.isNewMutualFund != null && objCurrentMutualFunds.isNewMutualFund)
	                	objApprovePlan.isNewMutualFund__c = true;
	                 
	               	if(objCurrentMutualFunds.executionTracker == 'Yes')
	                	objApprovePlan.isExecutionTracker__c = true;
	                else
	                	objApprovePlan.isExecutionTracker__c = false;
                 
	                //Added on:18/02/2013 : Aditi Satpute : AP changes
	                //objApprovePlan.MF_LumpsumRemark__c = objCurrentMutualFunds.mfLumpsumRemark;
	                if(objCurrentMutualFunds.isETCreated != null && objCurrentMutualFunds.isETCreated)
	                   	objApprovePlan.isETCReated__c = true;
	                   
	                //Added on : 02/04/13 : Aditi Satpute : As no ET should be created for Action None : ET Screen changes
	                if((objCurrentMutualFunds.lumpsumAction == '') || (objCurrentMutualFunds.lumpsumAction == '--None--') || (objCurrentMutualFunds.lumpsumAction == null))
	                   	objApprovePlan.isExecutionTracker__c = false;
	                     
	                objApprovePlan.Current_SIP__c = objCurrentMutualFunds.currentSIP;
	                objApprovePlan.Lumpsum_Action__c = objCurrentMutualFunds.lumpsumAction;
	                objApprovePlan.Investment_Asset__c = objCurrentMutualFunds.investmentId;
               
	                if(mapIdToSIPMutualFunds.containsKey(objCurrentMutualFunds.investmentId))
	                {
		                 ApprovedPlanBean.CurrentMutualFunds objSIPMFunds = mapIdToSIPMutualFunds.get(objCurrentMutualFunds.investmentId);
		                 
		                 objApprovePlan.SIP_Action__c = objSIPMFunds.SIPaction;
		                 objApprovePlan.SIP_Action_Amount__c = objSIPMFunds.SIPactionAmount;
		                 //Added on:18/02/2013 : Aditi Satpute : AP changes
		                 //objApprovePlan.MF_SIPRemark__c = objCurrentMutualFunds.mfSIPRemark;
		                system.debug('*******objCurrentMutualFunds.isMFsipETCreated***in service**'+objCurrentMutualFunds.isMFsipETCreated);
		                if(objSIPMFunds.isMFsipETCreated != null)
		                {
		                   if(objSIPMFunds.isMFsipETCreated)
		                     objApprovePlan.isMFsipETCreated__c = true;
		                }
	               
		                if(objSIPMFunds.SIPexecutionTracker == 'Yes')
		                     objApprovePlan.isSIPexecutionTracker__c = true;
		                else
		                     objApprovePlan.isSIPexecutionTracker__c = false;
               		}
               		
           		   	
		            lstUpsertActionPlan.add(objApprovePlan);
              
                  
                   if(lstCurrentMutualFunds.size() > 1 && objApprovePlan.Action_Amount__c <= 0)
                   {
                      ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Mutual Fund Action Amount should be greater than Zero'));
                      return null;
                   }
            
             	   /*  	
             	   		else
	                   	{
	                    	isMFAmountGreater = true;
	                    	lstUpsertCurrentMutualFunds.add(objApprovePlan);
	                   	}
	               */
                }
                
                
              /*  List<ApprovedPlanBean.CurrentMutualFunds> lstCurrentMFalreadyExists = new List<ApprovedPlanBean.CurrentMutualFunds>();
             if(beanObj.mapActionToCurrentMFlist.containsKey(objCurrentMutualFunds.lumpsumAction))
             {
               lstCurrentMFalreadyExists = beanObj.mapActionToCurrentMFlist.get(objCurrentMutualFunds.lumpsumAction);
               lstCurrentMFalreadyExists.add(objCurrentMutualFunds);
             }
             else
               lstCurrentMFalreadyExists.add(objCurrentMutualFunds);
             beanObj.mapActionToCurrentMFlist.put(objCurrentMutualFunds.lumpsumAction,lstCurrentMFalreadyExists);*/
                
              }
              
              if(Math.ceil(mapIdToInvestmentAsset.get(InvestmentId).TotalAsset__c) < Math.ceil(totalActionAmount))
              {
                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING, 'Total Action Amount "'
                			+totalActionAmount+'" of Mutual Fund-Lumpsum scheme "'+mapIdToInvestmentAsset.get(InvestmentId).Scheme_Name_Text__c+'" cannot be greater than Amount "'+Math.ceil(mapIdToInvestmentAsset.get(InvestmentId).TotalAsset__c)+'".'));
                  return null;
              }
            }
            //delete previous records. 
            //===========Added on 30/11/2012 : for Retrieving Family member
	        //List<Account> lstAccount = dbSOQLObj.getFamilyMembers(beanObj.entityId);
		    //set<Id> familyIdSet = new set<Id>(); 
		    //for(Account objAcc : lstAccount)
		    //{
		    //  familyIdSet.add(objAcc.Id);
		    //}
		    //==============================================================
            //List<Approve_Action_Plan__c> lstApproveActionPlan = [Select Id from Approve_Action_Plan__c where Account__c =: beanObj.entityId and Investment_Asset__c != null];
            /*List<Approve_Action_Plan__c> lstApproveActionPlan = [Select Id from Approve_Action_Plan__c where Account__c =: familyIdSet and ((Investment_Asset__c != null
                                       								and AP_Status__c = 'Opened' ) or 
                                       								((Item_Type__c = 'Life Insurance' or Item_Type__c = 'General Insurance' or Item_Type__c = 'Recommended Insurance') 
                                       								and AP_Status__c = 'Opened'))]; */
                                  
            //if(!lstApproveActionPlan.isEmpty())
               //delete lstApproveActionPlan;
            
            //if(!lstUpsertCurrentMutualFunds.isEmpty())
              //insert lstUpsertCurrentMutualFunds;
          
            //=============================================================================================================================== 
            
        Map<String,List<ApprovedPlanBean.CurrentMutualFunds>> mapActionToMutualFundLumpsum = new Map<String,List<ApprovedPlanBean.CurrentMutualFunds>>();
        Map<String,List<ApprovedPlanBean.CurrentMutualFunds>> mapActionToMutualFundSIP = new Map<String,List<ApprovedPlanBean.CurrentMutualFunds>>();
       
       system.debug('--------beanObj.mapIdToCurrentFunds.keySet()---------'+beanObj.mapIdToCurrentFunds.keySet());
        for( Id idMF  : beanObj.mapIdToCurrentFunds.keySet())
        {
        	List<ApprovedPlanBean.CurrentMutualFunds> lstMF = beanObj.mapIdToCurrentFunds.get(idMF);
          	for(ApprovedPlanBean.CurrentMutualFunds objMF : lstMF)
          	{  
            	List<ApprovedPlanBean.CurrentMutualFunds> lstCurrentMFalreadyExists = new List<ApprovedPlanBean.CurrentMutualFunds>();
             	if(mapActionToMutualFundLumpsum.containsKey(objMF.lumpsumAction))
             	{
               		lstCurrentMFalreadyExists = mapActionToMutualFundLumpsum.get(objMF.lumpsumAction);
               		lstCurrentMFalreadyExists.add(objMF);
             	}
             	else
             		lstCurrentMFalreadyExists.add(objMF);
             	mapActionToMutualFundLumpsum.put(objMF.lumpsumAction,lstCurrentMFalreadyExists);
          	}
        }
        
        beanObj.mapActionToCurrentMFlist = mapActionToMutualFundLumpsum ;        
      
      	for(ApprovedPlanBean.CurrentMutualFunds objSIP : beanObj.lstSIPCurrentFunds)
      	{
        	List<ApprovedPlanBean.CurrentMutualFunds> lstCurrentMFSIPalreadyExists = new List<ApprovedPlanBean.CurrentMutualFunds>();
           	if(mapActionToMutualFundSIP.containsKey(objSIP.SIPaction))
           	{
             	lstCurrentMFSIPalreadyExists = mapActionToMutualFundSIP.get(objSIP.SIPaction);
             	lstCurrentMFSIPalreadyExists.add(objSIP);
           	}
           	else
             	lstCurrentMFSIPalreadyExists.add(objSIP);
           	mapActionToMutualFundSIP.put(objSIP.SIPaction,lstCurrentMFSIPalreadyExists);
      	}
      	beanObj.mapActionToCurrentMFSIPlist = mapActionToMutualFundSIP;
        //-----------------------------------------------------------------------------------------------------------------------------
        
            
            
            //===Life Insurance=============================================================================================================
            List<Approve_Action_Plan__c> lstUpsertLifeInsurance = new List<Approve_Action_Plan__c>();
            /*List<Approve_Action_Plan__c> lstDeleteApproveActionPlan = [Select Id From Approve_Action_Plan__c  
                                          where Account__c IN: familyIdSet and Item_Type__c = 'Life Insurance' and AP_Status__c = 'Opened'];
               
                                          
      		delete lstDeleteApproveActionPlan;  */   
      		//for(ApprovedPlanBean.LifeInsurance objLifeInsurance: beanObj.lstLifeInsurance)
            //{            
            List<ApprovedPlanBean.LifeInsurance> lstLifeInsurance = new List<ApprovedPlanBean.LifeInsurance>();
           	List<ApprovedPlanBean.LifeInsurance> lstLifeInsuranceRecord_pdf_Html;
             beanObj.lstLifeInsuranceCombinedInnerclass = new List<ApprovedPlanBean.LifeInsurance>();
            //List<Approve_Action_Plan__c> lstLifeInsuranceRecordCount = new List<Approve_Action_Plan__c>();
            //List<Approve_Action_Plan__c> lstGeneralInsuranceRecordCount = new List<Approve_Action_Plan__c>();
            for(Id InsuracneID : beanObj.mapIdToLifeInsuranceInnerClass.keySet())
            { 
              	Double totalSuggestedCover = 0;
              	lstLifeInsurance = beanObj.mapIdToLifeInsuranceInnerClass.get(InsuracneID);
              	lstLifeInsuranceRecord_pdf_Html = new List<ApprovedPlanBean.LifeInsurance>();
              	for(ApprovedPlanBean.LifeInsurance objLifeInsurance : lstLifeInsurance)
              	{
	          		/*if(objLifeInsurance.suggestedCover != null && objLifeInsurance.sumAssured != null)
	                {	
	                  	if(Math.ceil(objLifeInsurance.suggestedCover) < Math.ceil(objLifeInsurance.sumAssured) )
	                  	{
	                    	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Sum Assured value of Life Insurance cannot exceed Suggested Cover value'));
	                    	return null;
	                  	}
	                }*/
	                //totalSuggestedCover += objLifeInsurance.sumAssured;
	                Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
	                if(objLifeInsurance.LifeInsuranceActionPlanId != '')
	                {
	                 	if(mapIdToAP.containsKey(objLifeInsurance.LifeInsuranceActionPlanId))
				        {
				     		objApprovePlan = mapIdToAP.get(objLifeInsurance.LifeInsuranceActionPlanId); 
				     		RecordPresent.add(objLifeInsurance.LifeInsuranceActionPlanId);
				     		if((objLifeInsurance.policyName == null || objLifeInsurance.policyName == '') && objLifeInsurance.sumAssured <= 0)
					        {
					          	 ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter all required fields for Life Insurance record of "'+objLifeInsurance.insured+'".'));
					             return null;
					       	}  
					       	if((objLifeInsurance.policyName == null || objLifeInsurance.policyName == ''))
					        {
					          	 ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter Policy Name for Life Insurance record of "'+objLifeInsurance.insured+'".'));
					             return null;
					       	}
					       	if(objLifeInsurance.sumAssured <= 0)
					        {
					          	 ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter Sum Assured for Life Insurance record of "'+objLifeInsurance.insured+'".'));
					             return null;
					       	}
			         	}
			         	else
			         	{
			         		objApprovePlan.Account__c = beanObj.entityId;
			         	}
                 	}
                 	else
                 	{
                 		objApprovePlan.Account__c = beanObj.entityId;
                 	}
	                 
	                 
	                Remarks__c objRemark = new Remarks__c();
		            objApprovePlan.Insurance__c = objLifeInsurance.insuranceId;
		            objApprovePlan.Item_Type__c = 'Life Insurance';
		            objApprovePlan.InsuranceRemark__c = objLifeInsurance.insuranceRemark;
		            objApprovePlan.Policy_Name__c = objLifeInsurance.policyName;
		            //Added on : 07/02/13 : Aditi Satpute : Generate New AP
		            objApprovePlan.AP_Status__c = Label.Opened;
		            //Added on:06/02/2013 : Aditi Satpute : AP changes
		            objApprovePlan.Sum_Assured_Rs__c = objLifeInsurance.sumAssured;
		            //Added on:18/02/2013 : Aditi Satpute : AP changes
		            objApprovePlan.Premium_Amount_Rs__c = objLifeInsurance.premiumAmount;
		            //Added on:18/02/2013 : Aditi Satpute : AP changes
		            objApprovePlan.Tenure_of_Insurance__c = objLifeInsurance.tenureOfInsurance;
		            /*if(objLifeInsurance.isETCreated != null )
		            {
		            	if(objLifeInsurance.isETCreated)
		                 	objApprovePlan.isETCReated__c = true;
		            }*/
		           
		            objApprovePlan.Suggested_Cover__c = objLifeInsurance.suggestedCover;
		            objApprovePlan.Policy_Type__c = objLifeInsurance.policyType;
		            objApprovePlan.Insured__c = objLifeInsurance.insured;
		            
		            system.debug('----------objLifeInsurance.suggestedCover--------'+objLifeInsurance.suggestedCover);
		            system.debug('----------objLifeInsurance.sumAssured------'+objLifeInsurance.sumAssured);
		            if(objLifeInsurance.isNewLI != null && objLifeInsurance.isNewLI)
	                   objApprovePlan.isNewLI__c = true;
		             
		            if(objLifeInsurance.executionTracker == 'Yes')
		               	objApprovePlan.isInsuranceExecutionTracker__c = true;
		            else
		               	objApprovePlan.isInsuranceExecutionTracker__c = false;
		             
		           /* if(objLifeInsurance.sumAssured > objLifeInsurance.suggestedCover)
		            {
		               	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Sum Assured value of Life Insurance cannot exceed Suggested Cover value'));
		                    return null;
		            }*/
		            system.debug('---objLifeInsurance.policyName---'+objLifeInsurance.policyName); 
		            /* Gaurav (15-5-2013) : To validate entered product name of Life Inusrance is available in Life Inusrance  product name list    */
		            if(objLifeInsurance.policyName != null && objLifeInsurance.policyName != '')
		            {
		            	 /*-----------Prajakta - 11-12-13----------------
			            String strCommaSeparatedLIProducts = '';
			            for(String strLifeProducts : objLifeInsurance.lifeInsuranceList)
			          	{
			          		strCommaSeparatedLIProducts +=  strLifeProducts+',';
			          	}
			          	objApprovePlan.Multiple_Products__c = strCommaSeparatedLIProducts.substring(0,strCommaSeparatedLIProducts.length()-1);
				        /*----------------------------------------------*/
				        
		            	if(!(mapTypeToProductNames.get('Life Insurance').contains('"'+objLifeInsurance.policyName+'"')))
		            	{
			             	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please Enter valid Policy Name for Life Insurance record of "'+objLifeInsurance.insured+'".'));
			             	return null;
		            	}
		            	if(objLifeInsurance.sumAssured == null || objLifeInsurance.sumAssured == 0)
			          	{
			          		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Sum Assured Amount for Life Insurance record of "'+objLifeInsurance.insured+'".'));
			                return null;
			          	}
		            	lstUpsertActionPlan.add(objApprovePlan);
		            	lstLifeInsuranceRecord_pdf_Html.add(objLifeInsurance);
		            	beanObj.lstLifeInsuranceCombinedInnerclass.add(objLifeInsurance);
		            }  
		            /* Enf Changes */
		            
		          /*  if(lstUpsertLifeInsurance.size() > 1 && objLifeInsurance.sumAssured <= 0)
		            {
		                 ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Life Insurance Sum Assured value must be greater than Zero'));
		                 return null;
		            }*/
	             	//lstUpsertLifeInsurance.add(objApprovePlan);
	           }
             /*  if(Math.ceil(MapIdToLifeInsurance.get(InsuracneID).Suggested_Cover_General_Insurance__c) < Math.ceil(totalSuggestedCover))
               {
                	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING, 'Life Insurance Total Sum Assured value must not be greater than Suggested Cover'));
                  	return null;
               }*/
           //    if(!beanObj.mapIdToLifeInsuranceInnerClass_Html_Pdf.containsKey(InsuracneID))
               {
               		if(lstLifeInsuranceRecord_pdf_Html.size() > 0)
               		{
               			//beanObj.mapIdToLifeInsuranceInnerClass_Html_Pdf.put(InsuracneID,lstLifeInsuranceRecord_pdf_Html);
        				beanObj.isLifeInsExist_in_Pdf_Html = true;
               		}
               }
               //system.debug('------beanObj.mapIdToLifeInsuranceInnerClass_Html_Pdf-----'+beanObj.mapIdToLifeInsuranceInnerClass_Html_Pdf.size());
              /* else
               {
               		if(lstLifeInsuranceRecord_pdf_Html.size() > 0)
               		{
               			beanObj.mapIdToLifeInsuranceInnerClass_Html_Pdf.get(InsuracneID).add(lstLifeInsuranceRecord_pdf_Html);
               		}
               }*/
        
            }
            
            system.debug('---LI---beanObj.lstnewLifeInsurance--------'+beanObj.lstnewLifeInsurance);
            //Added on : 24/10/13 : Aditi Satpute - LI Capping Removal changes
            for(ApprovedPlanBean.LifeInsurance objLifeInsurance : beanObj.lstnewLifeInsurance)
          	{
                Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
                if(objLifeInsurance.LifeInsuranceActionPlanId != '')
                {
                 	if(mapIdToAP.containsKey(objLifeInsurance.LifeInsuranceActionPlanId))
			        {
			     			objApprovePlan = mapIdToAP.get(objLifeInsurance.LifeInsuranceActionPlanId); 
			     			RecordPresent.add(objLifeInsurance.LifeInsuranceActionPlanId);
		         	}
		         	else
		         	{
		         		objApprovePlan.Account__c = beanObj.entityId;
		         	}
             	}
             	else
             	{
             		objApprovePlan.Account__c = beanObj.entityId;
             	}
                /*-----------Prajakta - 11-12-13----------------
	            String strCommaSeparatedLIProducts = '';
	            //error.debugLog('---LI---objLifeInsurance.lifeInsuranceList--------'+objLifeInsurance.lifeInsuranceList);
	            for(String strLifeProducts : objLifeInsurance.lifeInsuranceList)
	          	{
	          		strCommaSeparatedLIProducts +=  strLifeProducts+',';
	          	}
	          	objApprovePlan.Multiple_Products__c = strCommaSeparatedLIProducts.substring(0,strCommaSeparatedLIProducts.length()-1);
	          	system.debug('---LI---objApprovePlan.Multiple_Products__c--------'+objApprovePlan.Multiple_Products__c);
		        /*----------------------------------------------*/
	            objApprovePlan.Item_Type__c = 'Life Insurance';
	            objApprovePlan.Policy_Name__c = objLifeInsurance.policyName;
	            //Added on : 07/02/13 : Aditi Satpute : Generate New AP
	            objApprovePlan.AP_Status__c = Label.Opened;
	            //Added on:06/02/2013 : Aditi Satpute : AP changes
	            objApprovePlan.Sum_Assured_Rs__c = objLifeInsurance.sumAssured;
	            //Added on:18/02/2013 : Aditi Satpute : AP changes
	            objApprovePlan.Premium_Amount_Rs__c = objLifeInsurance.premiumAmount;
	            //Added on:18/02/2013 : Aditi Satpute : AP changes
	            objApprovePlan.Tenure_of_Insurance__c = objLifeInsurance.tenureOfInsurance;
	            objApprovePlan.Suggested_Cover__c = objLifeInsurance.suggestedCover;
	            objApprovePlan.Policy_Type__c = objLifeInsurance.policyType;
	            objApprovePlan.Insured__c = objLifeInsurance.insured;
	            
	            if(objLifeInsurance.executionTracker == 'Yes')
	               	objApprovePlan.isInsuranceExecutionTracker__c = true;
	            else
	               	objApprovePlan.isInsuranceExecutionTracker__c = false;
             	
             	if(objLifeInsurance.sumAssured <= 0 || objLifeInsurance.policyName == null || objLifeInsurance.policyType == null 
               			|| objLifeInsurance.premiumAmount == null || objLifeInsurance.premiumAmount == 0 || objLifeInsurance.tenureOfInsurance == 0 || objLifeInsurance.tenureOfInsurance == null)
         		{
             		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Required fields for newly added Life Insurance record of "'+objLifeInsurance.insured+'".'));
            		return null;
         		}
	          	             
	            /* Gaurav (15-5-2013) : To validate entered product name of Life Inusrance is available in Life Inusrance  product name list    */
	            if(!(mapTypeToProductNames.get('Life Insurance').contains('"'+objLifeInsurance.policyName+'"')))
	            {
		             ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Policy Name for newly added Life Insurance record of "'+objLifeInsurance.insured+'".'));
		             return null;
	            }  
	            /* End Changes */
	            system.debug('---LI---objApprovePlan--------'+objApprovePlan);
             	lstUpsertActionPlan.add(objApprovePlan);
             	beanObj.lstLifeInsuranceCombinedInnerclass.add(objLifeInsurance);
           }
            
            
            
            
            
            
            
            /*if(!lstUpsertLifeInsurance.isEmpty())
              insert lstUpsertLifeInsurance;*/
           //==End of Life Insurance==========================================================================================================
           //===General Insurance=============================================================================================================
            List<Approve_Action_Plan__c> lstUpsertGeneralInsurance = new List<Approve_Action_Plan__c>();
            List<Approve_Action_Plan__c> lstUpsertNewGeneralInsurance = new List<Approve_Action_Plan__c>();
            //beanObj.lstGeneralInsuranceInnerclassRecordCount = new List<ApprovedPlanBean.GeneralInsurance>();
            beanObj.lstGeneralInsuranceCombinedInnerclass = new List<ApprovedPlanBean.GeneralInsurance>();
             List<ApprovedPlanBean.GeneralInsurance> lstGeneralInsuranceRecord_pdf_Html = new List<ApprovedPlanBean.GeneralInsurance>();
            /*List<Approve_Action_Plan__c> lstDeleteGeneralApproveActionPlan = [Select Id From Approve_Action_Plan__c 
                                            where Account__c IN: familyIdSet and Item_Type__c = : 'General Insurance'
                                            and AP_Status__c = 'Opened'];
                                              
           delete lstDeleteGeneralApproveActionPlan; */   
           for(ApprovedPlanBean.GeneralInsurance objGeneralInsurance: beanObj.lstGeneralInsurance)
           {  
              	system.debug('********objGeneralInsurance********'+objGeneralInsurance);
              	Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
              	if(objGeneralInsurance.GeneralInsuranceActionPlanId != '')
            	{
             		if(mapIdToAP.containsKey(objGeneralInsurance.GeneralInsuranceActionPlanId))
		        	{
		     			objApprovePlan = mapIdToAP.get(objGeneralInsurance.GeneralInsuranceActionPlanId); 
		     			RecordPresent.add(objGeneralInsurance.GeneralInsuranceActionPlanId);
				       	if((objGeneralInsurance.productName == null || objGeneralInsurance.productName == ''))
				        {
				          	 ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter Product Name for General Insurance record of "'+objGeneralInsurance.insured+'".'));
				             return null;
				       	}
	         		}
	         		else
	         		{
	         			objApprovePlan.Account__c = beanObj.entityId;
	         		}
         		}
         		else
         		{
         			objApprovePlan.Account__c = beanObj.entityId;
         		}
	                 
	          	objApprovePlan.Insurance__c = objGeneralInsurance.insuranceId;
	          	objApprovePlan.Item_Type__c = 'General Insurance';
	          	
	          	/*
	          	if(objGeneralInsurance.generalInsuranceList != null)
	          	{
		          	String strCommaSeparatedGIProducts = '';
		          	for(String  strGeneralProducts : objGeneralInsurance.generalInsuranceList)
		          	{
		          		strCommaSeparatedGIProducts +=  strGeneralProducts+',';
		          	}
		          	objApprovePlan.Multiple_Products__c = strCommaSeparatedGIProducts.substring(0,strCommaSeparatedGIProducts.length()-1);
	          	}*/
	          	/*if(objGeneralInsurance.isETCreated != null )
	          	{
	             	if(objGeneralInsurance.isETCreated)
	               objApprovePlan.isETCReated__c = true;
	          	}*/
	          
              	//Added on : 19/02/13 : Aditi Satpute : AP Changes
	           	objApprovePlan.Insured__c = objGeneralInsurance.insured;
	           	objApprovePlan.Policy_Type__c = objGeneralInsurance.policyType;
	           	objApprovePlan.Sum_Assured_Rs__c = objGeneralInsurance.sumAssured;
          	   	objApprovePlan.Premium_Amount_Rs__c = objGeneralInsurance.premiumAmount;
	          	/* if(objGeneralInsurance.isETCreated != null )
	           	{
	             	if(objGeneralInsurance.isETCreated)
	               objApprovePlan.isETCReated__c = true;
	           	}*/
	           	//Added on : 07/02/13 : Aditi Satpute : Generate New AP
	           	objApprovePlan.AP_Status__c = Label.Opened;
	           	objApprovePlan.Product_Name__c = objGeneralInsurance.productName;
	           	if(objGeneralInsurance.executionTracker == 'Yes')
	             	objApprovePlan.isInsuranceExecutionTracker__c = true;
	           	else
	             	objApprovePlan.isInsuranceExecutionTracker__c = false;
             	
             	if(objApprovePlan.Product_Name__c != null && objApprovePlan.Product_Name__c != '')
         		{
     				/* Gaurav (15-5-2013) : To validate entered product name of General Insurance is available in General Insurance  product name list    */
		          	if(!(mapTypeToProductNames.get('General Insurance').contains('"'+objGeneralInsurance.productName+'"')))
		          	{
		                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please Enter valid Product Name for General Insurance record of "'+objGeneralInsurance.insured+'".'));
		                return null;
		          	}  
		          	lstUpsertActionPlan.add(objApprovePlan);
		          	//beanObj.lstGeneralInsuranceInnerclassRecordCount.add(objGeneralInsurance);
		          	lstGeneralInsuranceRecord_pdf_Html.add(objGeneralInsurance);
		          	beanObj.lstGeneralInsuranceCombinedInnerclass.add(objGeneralInsurance);
         		}
         		
             
             	
             	
             	/* Enf Changes */   
             
        		// lstUpsertGeneralInsurance.add(objApprovePlan);
          	}
          	
          	 /*if(beanObj.lstGeneralInsuranceInnerclassRecordCount.size() > 0)
            	beanObj.isGeneralInsExist_in_Pdf_Html = true;
            	*/
             if(lstGeneralInsuranceRecord_pdf_Html.size() > 0)
            	beanObj.isGeneralInsExist_in_Pdf_Html = true;		
          	//Add Life Insurace and General Insurance records.
          	//lstUpsertLifeInsurance.addAll(lstUpsertGeneralInsurance);
          	/*Anupam
          	if(!lstUpsertGeneralInsurance.isEmpty())
              insert lstUpsertGeneralInsurance;*/
              
          	//Map<Id,Account> mapIdToAcc = new Map<Id,Account>([select Id,Name from Account where Id IN: familyIdSet]);
            
            //Added on:19/02/2013 : Aditi Satpute : AP changes   : Add new GI blank rows
        	if(!beanObj.lstNewGeneralInsurance.isEmpty())
        	{
          		for(ApprovedPlanBean.GeneralInsurance objNewGeneralInsurance: beanObj.lstNewGeneralInsurance)
            	{ 
                	Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
	                //Added on : 19/02/13 : Aditi Satpute : AP Changes
	                //objApprovePlan.Insured__c = objNewGeneralInsurance.insured;
               		system.debug('objNewGeneralInsurance.insured***********'+objNewGeneralInsurance.insured);
	               	/*if(mapIdToAcc.containsKey(objNewGeneralInsurance.insured))
	               	{
	                   Account objAccount = mapIdToAcc.get(objNewGeneralInsurance.insured);
	                   objApprovePlan.Insured__c = objAccount.Name;
	                   objNewGeneralInsurance.insuredName = objAccount.Name;
	               	}*/
	               	if(objNewGeneralInsurance.actionPlanGeneralInsuranceID != '')
	            	{
	             		if(mapIdToAP.containsKey(objNewGeneralInsurance.actionPlanGeneralInsuranceID))
			        	{
			     			objApprovePlan = mapIdToAP.get(objNewGeneralInsurance.actionPlanGeneralInsuranceID); 
			     			RecordPresent.add(objNewGeneralInsurance.actionPlanGeneralInsuranceID);
		         		}
		         		else
		         		{
		         			objApprovePlan.Account__c = beanObj.entityId;
		         		}
	         		}
	         		else
	         		{
	         			objApprovePlan.Account__c = beanObj.entityId;
	         		}
	         		/*---------Prajakta - 12-12-13----------
	         		if(objNewGeneralInsurance.generalInsuranceList != null)
	          		{
		         		String strCommaSeparatedGIProducts = '';
			          	for(String  strGeneralProducts : objNewGeneralInsurance.generalInsuranceList)
			          	{
			          		strCommaSeparatedGIProducts +=  strGeneralProducts+',';
			          	}
			          	objApprovePlan.Multiple_Products__c = strCommaSeparatedGIProducts.substring(0,strCommaSeparatedGIProducts.length()-1);
	          		}*/
		          	//----------------
               		objApprovePlan.Insured__c = objNewGeneralInsurance.insured;
               		objApprovePlan.Policy_Type__c = objNewGeneralInsurance.policyType;
               		objApprovePlan.Sum_Assured_Rs__c = objNewGeneralInsurance.sumAssured;
               		objApprovePlan.Premium_Amount_Rs__c = objNewGeneralInsurance.premiumAmount;
               		/*if(objNewGeneralInsurance.isETCreated != null )
               		{
                  		if(objNewGeneralInsurance.isETCreated)
                      		objApprovePlan.isETCReated__c = true;
               		}*/
               		//objApprovePlan.Insurance__c = objGeneralInsurance.insuranceId;
               		objApprovePlan.Item_Type__c = 'General Insurance';
               		//Added on : 07/02/13 : Aditi Satpute : Generate New AP
               		objApprovePlan.AP_Status__c = Label.Opened;
               		objApprovePlan.Product_Name__c = objNewGeneralInsurance.productName;
               		if(objNewGeneralInsurance.executionTracker == 'Yes')
                   		objApprovePlan.isInsuranceExecutionTracker__c = true;
              	 	else
                   		objApprovePlan.isInsuranceExecutionTracker__c = false;
             
             		if(objNewGeneralInsurance.sumAssured <= 0 || objNewGeneralInsurance.productName == null || objNewGeneralInsurance.policyType == null 
               			|| objNewGeneralInsurance.premiumAmount == null || objNewGeneralInsurance.premiumAmount == 0)
             		{
                 		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Required fields for newly added General Insurance record of "'+objNewGeneralInsurance.insured+'".'));
                		return null;
             		}
             		
             		/* Gaurav (15-5-2013) : To validate entered product name of General Insurance is available in General Insurance  product name list  */  
              		if(!(mapTypeToProductNames.get('General Insurance').contains('"'+objNewGeneralInsurance.productName+'"')))
              		{
	                	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Product Name for newly added General Insurance record of "'+objNewGeneralInsurance.insured+'".'));
	                	return null;
              		}  
             		/* Enf Changes */   
             
             		
             		lstUpsertActionPlan.add(objApprovePlan);
             		beanObj.lstGeneralInsuranceCombinedInnerclass.add(objNewGeneralInsurance);
             		//lstUpsertNewGeneralInsurance.add(objApprovePlan);
          		}
        	}
      		//Add Life Insurace and General Insurance records.
        	//lstUpsertLifeInsurance.addAll(lstUpsertNewGeneralInsurance);
        
        	/*Anupam
        	if(!lstUpsertNewGeneralInsurance.isEmpty())
              	insert lstUpsertNewGeneralInsurance;*/
              
        	/*  if(lstUpsertGeneralInsurance.size() > 0 || lstUpsertLifeInsurance.size() > 0 
                || lstUpsertCurrentMutualFunds.size() > 0 || UpsertList.size() > 0 || UpsertEmergencySIPList.size() > 0
                || UpsertLumpsumList.size() > 0 || UpsertEmergencyLumpsumList.size() > 0)
        	{
         	 	return false;
        	}
        	return true;*/
        	/*====================================================================================================================
          	Aditi - 25-11-2013 - display Insured and Policy Type wise on save in Action Plan PDF for General Insurance
			==================================================================================================================== */          
        	//beanObj.lstGeneralInsuranceCombinedInnerclass.sort();
        	List<ApprovedPlanBean.GeneralInsurance> lstGeneralInsuranceCombinedInnerclass = beanObj.lstGeneralInsuranceCombinedInnerclass;
        	beanObj.lstGeneralInsuranceCombinedInnerclass = new List<ApprovedPlanBean.GeneralInsurance>();
        	beanObj.lstGeneralInsuranceCombinedInnerclass = getGICombinedListforPDF(lstGeneralInsuranceCombinedInnerclass);
        	/*==================================================================================================================== */ 
        	
        	/*====================================================================================================================
          	Aditi - 26-11-2013 - display Insured and Policy Type wise on save in Action Plan PDF for Life Insurance
			==================================================================================================================== */          
        	//beanObj.lstLifeInsuranceCombinedInnerclass.sort();
        	List<ApprovedPlanBean.LifeInsurance> lstLifeInsuranceCombinedInnerclass = beanObj.lstLifeInsuranceCombinedInnerclass;
        	beanObj.lstLifeInsuranceCombinedInnerclass = new List<ApprovedPlanBean.LifeInsurance>();
        	beanObj.lstLifeInsuranceCombinedInnerclass = getLICombinedListforPDF(lstLifeInsuranceCombinedInnerclass);
        	/*==================================================================================================================== */    
        //===Recommended Insurance=============================================================================================================
        List<Approve_Action_Plan__c> lstUpsertRecommendedInsurance = new List<Approve_Action_Plan__c>();
        /*List<Approve_Action_Plan__c> lstDeleteRecommendedApproveActionPlan = [Select Id From Approve_Action_Plan__c 
                                        where Account__c IN: familyIdSet and Item_Type__c = : 'Recommended Insurance'
                                        and AP_Status__c = 'Opened'];
                                       
        if(!lstDeleteRecommendedApproveActionPlan.isEmpty())  delete lstDeleteRecommendedApproveActionPlan; */
                         
        for(ApprovedPlanBean.RecommendedInsurance objRecommendedInsurance: beanObj.lstRecommendedInsurance)
        {  
            Approve_Action_Plan__c objApprovePlan = new Approve_Action_Plan__c();
            if(objRecommendedInsurance.recommendedInsuranceActionPlanId != '')
        	{
         		if(mapIdToAP.containsKey(objRecommendedInsurance.recommendedInsuranceActionPlanId))
	        	{
	     			objApprovePlan = mapIdToAP.get(objRecommendedInsurance.recommendedInsuranceActionPlanId); 
	     			RecordPresent.add(objRecommendedInsurance.recommendedInsuranceActionPlanId);
         		}
         		else
         		{
         			objApprovePlan.Account__c = beanObj.entityId;
         		}
     		}
     		else
     		{
     			objApprovePlan.Account__c = beanObj.entityId;
     		}
            objApprovePlan.Item_Type__c = Label.Surrender_Insurance;
            objApprovePlan.Insurance__c = objRecommendedInsurance.insuranceId;
	        objApprovePlan.AP_Status__c = Label.Opened;
	        //objApprovePlan.Account__c = beanObj.entityId;
	        
	        /*if(objRecommendedInsurance.isETCreated != null)
	        {
	          	if(objRecommendedInsurance.isETCreated)
	             	objApprovePlan.isETCreated__c = true;
	        }*/
	        if(objRecommendedInsurance.recInsuranceExecutionTracker == 'Yes')
	           	objApprovePlan.isInsuranceExecutionTracker__c = true;
	        else
             	objApprovePlan.isInsuranceExecutionTracker__c = false;
	             
	        lstUpsertActionPlan.add(objApprovePlan);
	        //lstUpsertRecommendedInsurance.add(objApprovePlan);
        }
       Map<Id,Product_Manufacturer_Master__c> mapIdToPM = new Map<Id,Product_Manufacturer_Master__c>([select Id,Name from Product_Manufacturer_Master__c]);
      //===Loan Section====5/12/13 Aditi Satpute=================================================================================================   
        
      	for(ApprovedPlanBean.Loan objLoan: beanObj.lstLoan)
       	{    
       		Approve_Action_Plan__c objApprovePlanLoanRecod = new Approve_Action_Plan__c();
         	if(mapIdToAP.containsKey(objLoan.loanAPid))
         	{
         		objApprovePlanLoanRecod = mapIdToAP.get(objLoan.loanAPid);
         		RecordPresent.add(objLoan.loanAPid);
         	}
         	else
         	{	
         		objApprovePlanLoanRecod.Account__c = beanObj.entityId;
         	}
 		 	objApprovePlanLoanRecod.isAddOnExecutionTracker__c =  (objLoan.AddOnExecutionTracker == 'Yes') ? true : false;
            objApprovePlanLoanRecod.Product_Name__c = objLoan.vendorName;
            objApprovePlanLoanRecod.Insured__c = objLoan.applicant;
            objApprovePlanLoanRecod.Loan_Type__c = objLoan.loanType;
            objApprovePlanLoanRecod.Amount__c = objLoan.loanAmount;
            objApprovePlanLoanRecod.AP_Status__c = Label.Opened;
            objApprovePlanLoanRecod.Item_Type__c = 'Loan';
            
         	if((objLoan.vendorName == null || objLoan.vendorName == '') && (objLoan.loanAmount == 0 || objLoan.loanAmount == null))
     		{
         		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Required fields for newly added Loan record of "'+objLoan.applicant+'".'));
        		return null;
     		}
            /*if(!(mapTypeToProductNames.get('Loan').contains('"'+objLoan.vendorName+'"')))
            {
	             ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Vendor Name for newly added Loan record of "'+objLoan.applicant+'".'));
	             return null;
            }*/
            if(objLoan.vendorName == null || objLoan.vendorName == '')
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Vendor Name" for newly added Loan record of "'
            								+objLoan.applicant+'".'));
        		return null;
            }
            if(objLoan.loanAmount == 0 || objLoan.loanAmount == null)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Loan Amount" for newly added Loan record of "'
            								+objLoan.applicant+'".'));
        		return null;
            }
          /*  Set<String> setLoanProducts = new Set<String>();
            if(mapLoanTypeToLstProducts.containsKey(objLoan.loanType))
            {
            	setLoanProducts = mapLoanTypeToLstProducts.get(objLoan.loanType);
            	if(!setLoanProducts.contains(objLoan.vendorName))
	            { 
	            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Vendor Name for newly added Loan record of "'+objLoan.applicant+'".'));
		             return null;
	            }
            }*/
            //error.debugLog('---mapCompanyNameToProducts---'+mapCompanyNameToProducts);
            if(mapCompanyNameToProducts.containsKey('Loan'))
            {
            	innerMapCompanyNameToProducts = mapCompanyNameToProducts.get('Loan');
	            Set<String> setLoanProducts = new Set<String>();
	            if(innerMapCompanyNameToProducts.containsKey(objLoan.loanType))
	            {
	            	setLoanProducts = innerMapCompanyNameToProducts.get(objLoan.loanType);
	            	if(!setLoanProducts.contains(objLoan.vendorName))
		            { 
		            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Vendor Name for newly added Loan record of "'+objLoan.applicant+'".'));
			             return null;
		            }
	            }
            }
            
            lstUpsertActionPlan.add(objApprovePlanLoanRecod);
        }	
     //===Fixed Deposit Section====12/12/13 Aditi Satpute=================================================================================================   
        Map <String,Map<String,List<Commission__c>>> mapPM_ProductToComm = new Map <String,Map<String,List<Commission__c>>>();
        Map<String,List<Commission__c>> mapProductToComm = new Map<String,List<Commission__c>>();
      	for(ApprovedPlanBean.FixedDeposit objFD: beanObj.lstFixedDeposit)
       	{    
       		Approve_Action_Plan__c objApprovePlanFDRecord = new Approve_Action_Plan__c();
         	if(mapIdToAP.containsKey(objFD.actionPlanFDobj.Id))
         	{
         		objApprovePlanFDRecord = mapIdToAP.get(objFD.actionPlanFDobj.Id);
         		RecordPresent.add(objFD.actionPlanFDobj.Id);
         	}
         	else
         	{	
         		objApprovePlanFDRecord.Account__c = beanObj.entityId;
         	}
 		 	objApprovePlanFDRecord.isAddOnExecutionTracker__c =  (objFD.AddOnExecutionTracker == 'Yes') ? true : false;
            objApprovePlanFDRecord.Product_Name__c = objFD.actionPlanFDobj.Product_Name__c;
            objApprovePlanFDRecord.Insured__c = objFD.actionPlanFDobj.Insured__c;
            objApprovePlanFDRecord.Goal_Type__c = objFD.actionPlanFDobj.Goal_Type__c;
            objApprovePlanFDRecord.Amount__c = objFD.actionPlanFDobj.Amount__c;
            objApprovePlanFDRecord.Company_Name__c = objFD.actionPlanFDobj.Company_Name__c;
            objApprovePlanFDRecord.Period_in_Months__c = objFD.actionPlanFDobj.Period_in_Months__c;
            objApprovePlanFDRecord.AP_Status__c = Label.Opened;
            objApprovePlanFDRecord.Item_Type__c = 'Fixed Deposit';
            
            
          
           /* List<Commission__c> lstCommission = new List<Commission__c>();
		    if(lstCommission != null)
		    {
		     	for(Commission__c comm : lstCommission)
		     	{
		      		if(comm.Min_Months__c <= objAAP.Period_in_Months__c && objAAP.Period_in_Months__c < comm.Max_Months__c)
		      		{
		       			objComm = comm;
		       			break;
	      			}
		     	}
		    }*/
            
            
            if(objFD.actionPlanFDobj.Company_Name__c == null && (objFD.actionPlanFDobj.Product_Name__c == null || objFD.actionPlanFDobj.Product_Name__c == '')
            	&& (objFD.actionPlanFDobj.Period_in_Months__c == null || objFD.actionPlanFDobj.Period_in_Months__c == 0) 
            	&& (objFD.actionPlanFDobj.Amount__c == null || objFD.actionPlanFDobj.Amount__c == 0))
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Required fields for Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
        		return null;
            }
            
            if(objFD.actionPlanFDobj.Company_Name__c == null)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill Company Name for Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
        		return null;
            }
            
            if(objFD.actionPlanFDobj.Period_in_Months__c == null || objFD.actionPlanFDobj.Period_in_Months__c == 0)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Period in Months" for Fixed Deposit record of "'
            								+objFD.actionPlanFDobj.Insured__c+'".'));
        		return null;
            }
             if(objFD.actionPlanFDobj.Amount__c == null || objFD.actionPlanFDobj.Amount__c == 0)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Amount" for Fixed Deposit record of "'
            								+objFD.actionPlanFDobj.Insured__c+'".'));
        		return null;
            }
            if(objFD.actionPlanFDobj.Product_Name__c == null || objFD.actionPlanFDobj.Product_Name__c == '')
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Scheme Name" for Fixed Deposit record of "'
            								+objFD.actionPlanFDobj.Insured__c+'".'));
        		return null;
            }
            if(mapCompanyNameToProducts.containsKey('Fixed Deposit'))
            {
            	innerMapCompanyNameToProducts = mapCompanyNameToProducts.get('Fixed Deposit');
	            Set<String> setFDProducts = new Set<String>();
	            //error.debugLog('--objFD.companyName---'+objFD.companyName);
	            if(innerMapCompanyNameToProducts.containsKey(objFD.actionPlanFDobj.Company_Name__c))
	            {
	            	setFDProducts = innerMapCompanyNameToProducts.get(objFD.actionPlanFDobj.Company_Name__c);
	            	if(!setFDProducts.contains(objFD.actionPlanFDobj.Product_Name__c))
		            { 
		            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Scheme Name for selected Company Name "'
	            		+mapIdToPM.get(objFD.actionPlanFDobj.Company_Name__c).Name+'" for Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
			             return null;
		            }
	            }
	            else
	            {
	            	if(mapIdToPM.containsKey(objFD.actionPlanFDobj.Company_Name__c))
	            	{
	            		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Fixed Deposit Product "'+objFD.actionPlanFDobj.Product_Name__c
	            							+'" is not available in Product Master for selected Company Name "'+mapIdToPM.get(objFD.actionPlanFDobj.Company_Name__c).Name
		            						+'" for Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
			             return null;
	            	}
	            }
            }
            
            /*if(mapProductType_PM_Comm.containsKey('Fixed Deposit'))
            {
            	mapPM_ProductToComm = mapProductType_PM_Comm.get('Fixed Deposit');
            	if(mapPM_ProductToComm.containsKey(objFD.actionPlanFDobj.Company_Name__c))
            	{
            		mapProductToComm = mapPM_ProductToComm.get(objFD.actionPlanFDobj.Company_Name__c);
            		if(!mapProductToComm.KeySet().contains(objFD.actionPlanFDobj.Product_Name__c))
		            { 
		            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid Scheme Name for selected Company Name "'
	            		+mapIdToPM.get(objFD.actionPlanFDobj.Company_Name__c).Name+'" for Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
			             return null;
		            }
            		if(mapProductToComm.containsKey(objFD.actionPlanFDobj.Product_Name__c))
            		{
            			List<Commission__c> lstComm = mapProductToComm.get(objFD.actionPlanFDobj.Product_Name__c);
            			error.debugLog('-lstComm--in service-'+lstComm);
            			if(!lstComm.isEmpty())
					    {
					     	for(Commission__c comm : lstComm)
					     	{
					     		
					      		if(comm.Min_Months__c > objFD.actionPlanFDobj.Period_in_Months__c && objFD.actionPlanFDobj.Period_in_Months__c < comm.Max_Months__c)
					      		{
					       			ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid "Period in Months" for selected Scheme Name "'
					            		+objFD.actionPlanFDobj.Product_Name__c+'" in Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
							             return null;
				      			}
					     	}
					    }
            		}
            	}
            	else
            	{
            		if(mapIdToPM.containsKey(objFD.actionPlanFDobj.Company_Name__c))
	            	{
	            		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Fixed Deposit Product "'+objFD.actionPlanFDobj.Product_Name__c
	            							+'" is not available in Product Master for selected Company Name "'+mapIdToPM.get(objFD.actionPlanFDobj.Company_Name__c).Name
		            						+'" for Fixed Deposit record of "'+objFD.actionPlanFDobj.Insured__c+'".'));
			             return null;
	            	}
            	}
            }*/
            lstUpsertActionPlan.add(objApprovePlanFDRecord);
        }	 	
    	//====================================================================================================================================
 		//===Bond Section====17/12/13 Aditi Satpute===========================================================================================
      	for(ApprovedPlanBean.Bond objBond: beanObj.lstBond)
       	{    
       		Approve_Action_Plan__c objApprovePlanBondRecord = new Approve_Action_Plan__c();
         	if(mapIdToAP.containsKey(objBond.actionPlanBondObj.Id))
         	{
         		objApprovePlanBondRecord = mapIdToAP.get(objBond.actionPlanBondObj.Id);
         		RecordPresent.add(objBond.actionPlanBondObj.Id);
         	}
         	else
         	{	
         		objApprovePlanBondRecord.Account__c = beanObj.entityId;
         	}
 		 	objApprovePlanBondRecord.isAddOnExecutionTracker__c =  (objBond.AddOnExecutionTracker == 'Yes') ? true : false;
            objApprovePlanBondRecord.Product_Name__c = objBond.actionPlanBondObj.Product_Name__c;
            objApprovePlanBondRecord.Insured__c = objBond.actionPlanBondObj.Insured__c;
            objApprovePlanBondRecord.Goal_Type__c = objBond.actionPlanBondObj.Goal_Type__c;
            objApprovePlanBondRecord.Amount__c = objBond.actionPlanBondObj.Amount__c;
            objApprovePlanBondRecord.Company_Name__c = objBond.actionPlanBondObj.Company_Name__c;
            objApprovePlanBondRecord.Bond_Type__c = objBond.actionPlanBondObj.Bond_Type__c;
            objApprovePlanBondRecord.AP_Status__c = Label.Opened;
            objApprovePlanBondRecord.Item_Type__c = 'Bond';
            if(objBond.actionPlanBondObj.Company_Name__c == null && (objBond.actionPlanBondObj.Product_Name__c == null || objBond.actionPlanBondObj.Product_Name__c == '')
            	&& (objBond.actionPlanBondObj.Amount__c == null || objBond.actionPlanBondObj.Amount__c == 0))
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill all Required fields for Bond record of "'+objBond.actionPlanBondObj.Insured__c+'".'));
        		return null;
            }
            
            if(objBond.actionPlanBondObj.Company_Name__c == null)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill Company Name for Bond record of "'+objBond.actionPlanBondObj.Insured__c+'".'));
        		return null;
            }
	        if(objBond.actionPlanBondObj.Amount__c == null || objBond.actionPlanBondObj.Amount__c == 0)
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Amount" for Bond record of "'
            								+objBond.actionPlanBondObj.Insured__c+'".'));
        		return null;
            }
            if(objBond.actionPlanBondObj.Product_Name__c == null || objBond.actionPlanBondObj.Product_Name__c == '')
            {
            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please fill "Category" for Bond record of "'
            								+objBond.actionPlanBondObj.Insured__c+'".'));
        		return null;
            }
            if(mapCompanyNameToProducts.containsKey('Bond'))
            {
            	innerMapCompanyNameToProducts = mapCompanyNameToProducts.get('Bond');
            	Set<String> setBondProducts = new Set<String>();
            	//error.debugLog('--objBond.companyName---'+objBond.companyName);
	            if(innerMapCompanyNameToProducts.containsKey(objBond.actionPlanBondObj.Company_Name__c))
	            {
	            	setBondProducts = innerMapCompanyNameToProducts.get(objBond.actionPlanBondObj.Company_Name__c);
	            	if(!setBondProducts.contains(objBond.actionPlanBondObj.Product_Name__c))
		            { 
		            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid "Category" for selected Company Name "'
	            		+mapIdToPM.get(objBond.actionPlanBondObj.Company_Name__c).Name+'" for Bond record of "'+objBond.actionPlanBondObj.Insured__c+'".'));
			             return null;
		            }
	            }
	            else
	            {
	            	if(mapIdToPM.containsKey(objBond.actionPlanBondObj.Company_Name__c))
	            	{
	            		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Bond Product "'+objBond.actionPlanBondObj.Product_Name__c
	            							+'" is not available in Product Master for selected Company Name "'+mapIdToPM.get(objBond.actionPlanBondObj.Company_Name__c).Name
		            						+'" for Bond record of "'+objBond.actionPlanBondObj.Insured__c+'".'));
			             return null;
	            	}
	            }
            }
            
            
            /*if(mapProductType_PM_Comm.containsKey('Bond'))
            {
            	mapPM_ProductToComm = mapProductType_PM_Comm.get('Bond');
            	if(mapPM_ProductToComm.containsKey(objBond.actionPlanBondObj.Company_Name__c))
            	{
            		mapProductToComm = mapPM_ProductToComm.get(objBond.actionPlanBondObj.Company_Name__c);
            		 error.debugLog('-mapProductToComm.keySey--in service-'+mapProductToComm.keySet());
            		if(!mapProductToComm.KeySet().contains(objBond.actionPlanBondObj.Product_Name__c))
		            { 
		            	ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Please enter valid "Category" for selected Company Name "'
	            		+mapIdToPM.get(objBond.actionPlanBondObj.Company_Name__c).Name+'" for Bond record of "'+objBond.actionPlanBondObj.Insured__c+'".'));
			             return null;
		            }
            	}
            	else
            	{
            		if(mapIdToPM.containsKey(objBond.actionPlanBondObj.Company_Name__c))
	            	{
	            		ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.WARNING,'Bond Product "'+objBond.actionPlanBondObj.Product_Name__c
	            							+'" is not available in Product Master for selected Company Name "'+mapIdToPM.get(objBond.actionPlanBondObj.Company_Name__c).Name
		            						+'" for Bond record of "'+objBond.actionPlanBondObj.Insured__c+'".'));
			             return null;
	            	}
            	}
            }*/
            
            lstUpsertActionPlan.add(objApprovePlanBondRecord);
        }	 	
    //========================================================================================================  	
    
      	
      	system.debug('*****lstUpsertActionPlan*****'+lstUpsertActionPlan.size());
      	system.debug('*****RecordPresent*****'+RecordPresent.size());
      	system.debug('*****RecordPresent*****'+RecordPresent);
      	
      	system.debug('*****mapIdtoAP*****'+mapIdtoAP.keySet());
      	List<Approve_Action_Plan__c> lstDeleteAp = new List<Approve_Action_Plan__c>();
      	for(Approve_Action_Plan__c objDeleteAP : mapIdtoAP.values())
      	{
      		if(!RecordPresent.contains(objDeleteAP.Id))
      		{
      			if(!objDeleteAP.isUnallocatedRemark__c)
      				lstDeleteAp.add(objDeleteAP);
      		}
      	}
      	system.debug('*****lstDeleteAp*****'+lstDeleteAp.size());
      	if(!lstDeleteAp.isEmpty())
      		delete lstDeleteAp;
      	
      	//if(!lstInsertActionPlan.isEmpty())
      	//	insert lstInsertActionPlan;
      	
      	Map<String, Id> mapProductNameToProductId = new Map<String, Id>();
	//	for(Product_Master__c objPM : [Select Id, Product_Name__c from Product_Master__c where ProductType__c IN ('Mutual Fund', 'Life Insurance', 'General Insurance','Loan'
	//		,'Fixed Deposit','Bond')])
		for(Product_Master__c objPM : lstProductMaster)	
		{
			mapProductNameToProductId.put(objPM.Product_Name__c, objPM.Id);
		}
		
		for(Approve_Action_Plan__c objAAP : lstUpsertActionPlan)
		{
			if(objAAP.Investment_Asset__c != null)
				objAAP.Product__c = mapProductNameToProductId.get(objAAP.Scheme_Name__c);
			if(objAAP.Item_Type__c == 'SIP' || objAAP.Item_Type__c == 'Lumpsusm' || objAAP.Item_Type__c == 'General Insurance')
				objAAP.Product__c = mapProductNameToProductId.get(objAAP.Product_Name__c);
			if(objAAP.Item_Type__c == 'Life Insurance')
				objAAP.Product__c = mapProductNameToProductId.get(objAAP.Policy_Name__c);
			if(objAAP.Item_Type__c == 'Loan' || objAAP.Item_Type__c == 'Fixed Deposit' || objAAP.Item_Type__c == 'Bond')
				objAAP.Product__c = mapProductNameToProductId.get(objAAP.Product_Name__c);
		}
		
		if(!lstGoalUpdate.isEmpty())
			update lstGoalUpdate;
      	if(!lstUpsertActionPlan.isEmpty())
      		upsert lstUpsertActionPlan;
      	
  		/*Double installments=0;
      	String option ='';
      	String remarks = '';
      	String productName='' ;
      	String transactionType='';
      	String category='';
      	Double amount=0;
      	Boolean execTracker = false;
      	String executionTracker = '';
      	ApprovedPlanBean.GoalDetails objActionPlanGoalDetails11 = new ApprovedPlanBean.GoalDetails();
      	for(Approve_Action_Plan__c objPlan : lstUpsertActionPlan)
      	{
      		
      		system.debug('---------objPlan----------'+objPlan);
      		system.debug('---------objPlan.Id----------'+objPlan.Id);
          	installments = objPlan.Installments__c;
         	option = objPlan.Option__c;
     		remarks = objPlan.Remarks__c;
         	productName = objPlan.Product_Name__c;
         	transactionType = objPlan.Transaction_Type__c;
         	//sipETCreated = objPlan.isETCreated__c;
         	category = objPlan.Category__c;
         	amount = objPlan.Amount__c;
         	execTracker = objPlan.isSIPexecutionTracker__c;
         	executionTracker = execTracker ? 'Yes':'No';
  	 		objActionPlanGoalDetails11.populateSIPFunds(productName,transactionType,amount,installments,category,
                  							option,remarks,execTracker,executionTracker,false,objPlan.Id);
  			
      	}*/
     	
     	/*====================================================================================================================
          Prajakta - 21-08-2013 - display Action wise on page load in Action Plan PDF for Gols and Silver
==================================================================================================================== */          
        Map<String,List<ApprovedPlanBean.CurrentGoldSilver>> mapActionToGoldSilverLumpsum = new Map<String,List<ApprovedPlanBean.CurrentGoldSilver>>();
        Map<String,List<ApprovedPlanBean.CurrentGoldSilver>> mapActionToGoldSilverSIP = new Map<String,List<ApprovedPlanBean.CurrentGoldSilver>>();
        system.debug('--------beanObj.mapIdToCurrentGold.keySet()---------'+beanObj.mapIdToCurrentGold.keySet());
        for( Id idGS  : beanObj.mapIdToCurrentGold.keySet())
        {
        	system.debug('--------idGS---------'+idGS);
        	List<ApprovedPlanBean.CurrentGoldSilver> lstGS = beanObj.mapIdToCurrentGold.get(idGS);
          	for(ApprovedPlanBean.CurrentGoldSilver objGS : lstGS)
          	{  
          		system.debug('--------objGS---------'+objGS);
            	List<ApprovedPlanBean.CurrentGoldSilver> lstCurrentGSalreadyExists = new List<ApprovedPlanBean.CurrentGoldSilver>();
             	if(mapActionToGoldSilverLumpsum.containsKey(objGS.lumpsumAction))
             	{
               		lstCurrentGSalreadyExists = mapActionToGoldSilverLumpsum.get(objGS.lumpsumAction);
               		lstCurrentGSalreadyExists.add(objGS);
             	}
             	else
             		lstCurrentGSalreadyExists.add(objGS);
             	mapActionToGoldSilverLumpsum.put(objGS.lumpsumAction,lstCurrentGSalreadyExists);
          	}
        }
        system.debug('--------mapActionToGoldSilverLumpsum---------'+mapActionToGoldSilverLumpsum);
        beanObj.mapActionToCurrentGSlist = mapActionToGoldSilverLumpsum ;        
      
      	for(ApprovedPlanBean.CurrentGoldSilver objSIP : beanObj.lstSIPCurrentGold)
      	{
        	List<ApprovedPlanBean.CurrentGoldSilver> lstCurrentGSSIPalreadyExists = new List<ApprovedPlanBean.CurrentGoldSilver>();
           	if(mapActionToGoldSilverSIP.containsKey(objSIP.SIPaction))
           	{
             	lstCurrentGSSIPalreadyExists = mapActionToGoldSilverSIP.get(objSIP.SIPaction);
             	lstCurrentGSSIPalreadyExists.add(objSIP);
           	}
           	else
             	lstCurrentGSSIPalreadyExists.add(objSIP);
           	mapActionToGoldSilverSIP.put(objSIP.SIPaction,lstCurrentGSSIPalreadyExists);
      	}
      	beanObj.mapActionToCurrentGSSIPlist = mapActionToGoldSilverSIP;
 /*==================================================================================================================== */         
     	
     	
      	return null;
   }
    
       
    /**
    * @Description: save data in approved plan object and insurence object 
    * param: ApprovedPlanBean 
    * return type: void
    */
    //Commented on 19/12/13 : Aditi Satpute
    
    /*public Pagereference upsertData(ApprovedPlanBean beanObj)
    {
        List<Approved_Action_Plan__c> insList = new List<Approved_Action_Plan__c>();
        for(ApprovedPlanBean.CurrentMFLumpSum tmpObj: beanObj.currentMFLumpSumList)
        {
            for(ApprovedPlanBean.Goals golObj: tmpObj.golCurrMFLumpSum)
            {    
                Approved_Action_Plan__c tmpInsObj = new Approved_Action_Plan__c();
                tmpInsObj.RecordTypeId = beanObj.recTypeMap.get(currentLump);
                tmpInsObj.Entity__c = tmpObj.entityId;
                tmpInsObj.Amount__c = tmpObj.actionAmount;
                tmpInsObj.Asset_Class__c = tmpObj.assetsClass;
                tmpInsObj.Investment_Asset__c = tmpObj.assetId;
                tmpInsObj.Lumpsum_Action__c = tmpObj.action;
                //tmpInsObj.Scheme_Name__c = tmpObj.schemeName;//FS0235
                tmpInsObj.Scheme_Name_Text__c = tmpObj.schemeName;//FS0235
                tmpInsObj.Goal__c = golObj.goalId;
                tmpInsObj.Allocated__c = golObj.allocated;
                if(tmpInsObj.Lumpsum_Action__c == 'Hold - Change of broker' 
                    || tmpInsObj.Lumpsum_Action__c == 'Hold - No Change of broker'){
                    if(tmpInsObj.Allocated__c!=null && tmpInsObj.Allocated__c != 0
                        && tmpInsObj.Amount__c != null && tmpInsObj.Amount__c != 0){
                        tmpInsObj.Allocated_Amount__c = (tmpInsObj.Amount__c * tmpInsObj.Allocated__c) / 100 ;
                    }else{
                        tmpInsObj.Allocated_Amount__c = 0;
                    }
                }else{
                    tmpInsObj.Allocated_Amount__c = 0;
                }   
                insList.add(tmpInsObj); 
            }
        }
         for(ApprovedPlanBean.CurrentMFSIP tmpObj: beanObj.currentMFSIPList)
        {
            for(ApprovedPlanBean.Goals golObj: tmpObj.golCurrMFSIP)
            {    
                Approved_Action_Plan__c tmpInsObj = new Approved_Action_Plan__c();
                tmpInsObj.RecordTypeId = beanObj.recTypeMap.get(currentSIP);
                tmpInsObj.Entity__c = tmpObj.entityId;
                tmpInsObj.Amount__c = tmpObj.SIPChange;
                tmpInsObj.Asset_Class__c = tmpObj.assetsClass;
                tmpInsObj.Investment_Asset__c = tmpObj.assetId;
                tmpInsObj.SIP_Action__c = tmpObj.SIPAction;
                //tmpInsObj.Scheme_Name__c = tmpObj.schemeName;//FS0235
                tmpInsObj.Scheme_Name_Text__c = tmpObj.schemeName;//FS0235
                tmpInsObj.Goal__c = golObj.goalId;
                tmpInsObj.Allocated__c = golObj.allocated;
                
                if(tmpInsObj.SIP_Action__c == 'Stop')
                {
                    tmpInsObj.Allocated_Amount__c = 0;
                }
                else if (tmpInsObj.SIP_Action__c == 'Continue')
                {
                  tmpInsObj.Amount__c = tmpObj.currentSIP; 
                }
                if(tmpInsObj.Allocated__c!=null && tmpInsObj.Allocated__c != 0&& tmpInsObj.Amount__c != null && tmpInsObj.Amount__c != 0)
                {
                    tmpInsObj.Allocated_Amount__c = (tmpInsObj.Amount__c * tmpInsObj.Allocated__c) / 100 ;
                }
                else
                {
                    tmpInsObj.Allocated_Amount__c = 0;
                }
              insList.add(tmpInsObj); 
            }
        }
        Set<String> chkDuplicate = new  Set<String>();
        boolean isError = false;
        for(ApprovedPlanBean.SuggestedMFLumpSum tmpObj: beanObj.suggestedMFLumpSumList){
            for(ApprovedPlanBean.Goals golObj: tmpObj.golsuggMFLump){
                if(! chkDuplicate.contains(tmpObj.entityId+tmpObj.schemeName+golObj.goalId)){
                    Approved_Action_Plan__c tmpInsObj = new Approved_Action_Plan__c();
                    tmpInsObj.RecordTypeId = beanObj.recTypeMap.get(suggestedLump);
                    tmpInsObj.Entity__c = tmpObj.entityId;
                    tmpInsObj.Amount__c = tmpObj.amount;
                    tmpInsObj.Asset_Class__c = tmpObj.assetsClass;
                    tmpInsObj.Investment_Asset__c = tmpObj.assetId;
                    tmpInsObj.Suggested_LumpSum_Action__c  = tmpObj.Action;
                    //tmpInsObj.Scheme_Name__c = tmpObj.schemeName;//FS0235
                    tmpInsObj.Scheme_Name_Text__c = tmpObj.schemeName;//FS0235
                     tmpInsObj.Notes__c=tmpObj.notes;
                    tmpInsObj.Goal__c = golObj.goalId;
                    tmpInsObj.Allocated__c = golObj.allocated;
                    if(tmpInsObj.Allocated__c!=null && tmpInsObj.Allocated__c != 0
                        && tmpInsObj.Amount__c != null && tmpInsObj.Amount__c != 0){
                        tmpInsObj.Allocated_Amount__c = ( tmpInsObj.Amount__c * tmpInsObj.Allocated__c) / 100;
                    }else{
                        tmpInsObj.Allocated_Amount__c = 0;
                    }
                    insList.add(tmpInsObj); 
                    chkDuplicate.add(tmpObj.entityId+tmpObj.schemeName+golObj.goalId);
                }else{
                    isError = true;
                }
            }
        }
        
        Set<String> chkDuplicate1 = new  Set<String>();
        boolean isError1 = false;
        for(ApprovedPlanBean.SuggestedMFSIP tmpObj: beanObj.suggestedMFSIPList)
        {
          for(ApprovedPlanBean.Goals golObj: tmpObj.golSuggMFSIP)
            {  
              if(!chkDuplicate1.contains(tmpObj.entityId+tmpObj.schemeName+golObj.goalId))
                {
                    Approved_Action_Plan__c tmpInsObj = new Approved_Action_Plan__c();
                    tmpInsObj.RecordTypeId = beanObj.recTypeMap.get(suggestedSIP);
                    tmpInsObj.Entity__c = tmpObj.entityId;
                    tmpInsObj.Amount__c = tmpObj.SIPAmount;
                    tmpInsObj.Asset_Class__c = tmpObj.assetsClass;
                    tmpInsObj.Investment_Asset__c = tmpObj.assetId;
                    //tmpInsObj.Scheme_Name__c = tmpObj.schemeName;//FS0235
                    tmpInsObj.Scheme_Name_Text__c = tmpObj.schemeName;//FS0235
                    tmpInsObj.Goal__c = golObj.goalId;
                    tmpInsObj.Allocated__c = golObj.allocated;
                    if(tmpInsObj.Allocated__c!=null && tmpInsObj.Allocated__c != 0 && tmpInsObj.Amount__c != null && tmpInsObj.Amount__c != 0)
                    {
                        tmpInsObj.Allocated_Amount__c = ( tmpInsObj.Amount__c * tmpInsObj.Allocated__c) / 100;
                    }
                    else
                    {
                        tmpInsObj.Allocated_Amount__c = 0;
                    }
                    insList.add(tmpInsObj); 
                    chkDuplicate1.add(tmpObj.entityId+tmpObj.schemeName+golObj.goalId);
                }
                else
                {
                  isError1 = true;
                }    
            }
        }
        if(isError || isError1)
        {
            if(isError)
            {
                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.ERROR,Label.ApprovedPlanLumpSumMessage));
            }
            if(isError1)
            {
                ApexPages.addMessage(new ApexPages.Message(ApexPages.Severity.ERROR,Label.ApprovedPlanSIPMessage));
            }
            return null;
        }
        
        if(beanObj.approvedPlanList.size()>0)
        {
            dbDMLObj.deleteRecords(beanObj.approvedPlanList);
        }
         if(insList.size() >0)
        {
            dbDMLObj.upsertObject(insList);
        }
        if(beanObj.giApprovedList.size()>0){
            dbDMLObj.upsertObject(beanObj.giApprovedList);
        }
        if(beanObj.liApprovedList.size()>0){
            dbDMLObj.upsertObject(beanObj.liApprovedList);
        }
        
        return null;
    }
    */
     /**
    * @Description: remove record from list and approved plan object for suggested lumpsum
    * param: ApprovedPlanBean 
    * return type: void
    */
    public void RemoveRecordLump(ApprovedPlanBean beanObj){
        List<Approved_Action_Plan__c> delList = new List<Approved_Action_Plan__c>();
        List<Integer> removeList = new List<Integer>();
        Integer cnt = 0;
        
        for(ApprovedPlanBean.SuggestedMFLumpSum tmpObj: beanObj.suggestedMFLumpSumList){
            if(tmpObj.isRemove){
                removeList.add(cnt);
            }
            cnt++;
        }
        for(integer i=removeList.size();i>0;i--){
            beanObj.suggestedMFLumpSumList.remove(removeList.get(i-1));
        }
       
    }
    
    /**
    * @Description: remove record from list and approved plan object for suggested SIPFunds of New Action Plan
    * param: ApprovedPlanBean 
    * return type: void
    */
  public void RemoveRecordSIPFunds(ApprovedPlanBean beanObj)
  {
        List<Approve_Action_Plan__c> delList = new List<Approve_Action_Plan__c>();
        for(ApprovedPlanBean.GoalDetails objGoals: beanObj.lstGoalDetails)
        {
          List<Integer> removeList = new List<Integer>();
          Integer cnt = 0;
          for(ApprovedPlanBean.SIPFunds objSIPs: objGoals.lstSIPFunds)
            {   
            if(objSIPs.isRemove)
            {
                  removeList.add(cnt);
            }
                cnt++;
            }
            for(integer i=removeList.size();i>0;i--)
            {
              objGoals.lstSIPFunds.remove(removeList.get(i-1));
           }
        }
        //Lumpsum
        for(ApprovedPlanBean.GoalDetails objGoals: beanObj.lstGoalDetails)
        {
          List<Integer> removeList = new List<Integer>();
          Integer cnt = 0;
          for(ApprovedPlanBean.LumpsumFunds objLumpsums: objGoals.lstLumpsumFunds)
            {   
            if(objLumpsums.isRemove)
            {
                  removeList.add(cnt);
            }
                cnt++;
            }
            for(integer i=removeList.size();i>0;i--)
            {
              objGoals.lstLumpsumFunds.remove(removeList.get(i-1));
           }
           
        }
        
        //Code for emergency fund -- Lumpsum Funds Remove================================================
        Integer LumpsumCnt = 0;
        List<Integer> LumpsumRemoveList = new List<Integer>();
        for(ApprovedPlanBean.LumpsumFunds objLumpsums: beanObj.objEmergencyFundGoalDetails.lstLumpsumFunds)
            {   
            if(objLumpsums.isRemove)
            {
                  LumpsumRemoveList.add(LumpsumCnt);
            }
                LumpsumCnt++;
            }
            for(integer i=LumpsumRemoveList.size();i>0;i--)
            {
              beanObj.objEmergencyFundGoalDetails.lstLumpsumFunds.remove(LumpsumRemoveList.get(i-1));
           }
        //==========================================================================================================
        
         //Code for emergency fund -- SIP Funds Remove================================================
        Integer SIPcnt = 0;
        List<Integer> SIPRemoveList = new List<Integer>();
        for(ApprovedPlanBean.SIPFunds objSIPs: beanObj.objEmergencyFundGoalDetails.lstSIPFunds)
        {   
        if(objSIPs.isRemove)
        {
              SIPRemoveList.add(SIPcnt);
        }
           SIPcnt++;
        }
        for(integer i=SIPRemoveList.size();i>0;i--)
        {
          beanObj.objEmergencyFundGoalDetails.lstSIPFunds.remove(SIPRemoveList.get(i-1));
       }
     }
    
    /**
    * @Description: get record types for the approved plan object
    * param: ApprovedPlanBean 
    * return type: void
    */
    public void getRecType(ApprovedPlanBean beanObj)
    {
        List<RecordType> recTypeList = dbSOQLObj.getObjectRecordTypes('Approved_Action_Plan__c'); 
        for(RecordType recObj: recTypeList ){
            beanObj.recTypeMap.put(recObj.Name, recObj.Id);
        }
       
    }
    
    /**
    * @Description: get all approved plans for the entity
    * param: ApprovedPlanBean 
    * return type: void
    */
    //Commented on 19/12/13 : Aditi Satpute
    /*public List<Approved_Action_Plan__c> getdbApprovedPlans(List<Account> accList){
         List<Approved_Action_Plan__c> approvedPlanList = dbSOQLObj.getdbApprovedPlans(accList);
         return approvedPlanList;
    }*/
    
    /**
    * @Description: get mutual fund record for the entity and familiy
    * param: ApprovedPlanBean 
    * return type: void
    */
    public List<Investment_Asset__c> getMFInvestmentAsset(List<Account> accList)
    {
        List<Investment_Asset__c> investment= dbSOQLObj.getMFInvestmentAsset(accList);    
        return investment; 
    } 
    
    
    /**
    * @Description: Prpeare Lumpsum total and SIP Total
    * param: ApprovedPlanBean 
    * return type: void
    */
    public void PrpeareSuggested(ApprovedPlanBean beanObj)
    {
        List<AggregateResult> goalInassetList = dbSOQLObj.getInvestAssociationSum(beanObj.accList);
        List<AggregateResult> goalAssetList = dbSOQLObj.getInsuranceAssociationSum(beanObj.accList);
        List<AggregateResult> goalInsurList = dbSOQLObj.getAssetAssociationSum(beanObj.accList);
        
        Set<Id> profileSet = new set<id>();
        List<String> strGoalNames = new List<String>();
        
        Map<Id,Id> golProfileMap = new Map<Id,Id>();
        Map<Id,double> golAmountMap = new Map<Id,double>();
        for(AggregateResult agObj: goalInassetList){
             if((Double)agObj.get('expr0')!=null){  
                 golAmountMap.put((Id)agObj.get('Goal__c'),(Double)agObj.get('expr0'));
                 
             }
        }
        for(AggregateResult agObj: goalAssetList){
             if((Double)agObj.get('expr0')!=null){      
                 if(golAmountMap.get((Id)agObj.get('Goal__c'))!=null){
                     golAmountMap.put((Id)agObj.get('Goal__c'),golAmountMap.get((Id)agObj.get('Goal__c'))+(Double)agObj.get('expr0'));  
                 }else{
                     golAmountMap.put((Id)agObj.get('Goal__c'),(Double)agObj.get('expr0'));  
                 }
             }
        }
        for(AggregateResult agObj: goalInsurList){
             if((Double)agObj.get('expr0')!=null){  
                 if(golAmountMap.get((Id)agObj.get('Goal__c'))!=null){
                     golAmountMap.put((Id)agObj.get('Goal__c'),golAmountMap.get((Id)agObj.get('Goal__c'))+(Double)agObj.get('expr0'));  
                 }else{
                     golAmountMap.put((Id)agObj.get('Goal__c'),(Double)agObj.get('expr0'));  
                 }
             }
        }
        for(Goal__c golObj: beanObj.goalList){
            profileSet.add(golObj.SelectedGoalProfile__c);
            golProfileMap.put(golObj.Id,golObj.SelectedGoalProfile__c); 
        }
        system.debug('**profileSet****'+profileSet);
        List<goal_Profile__c> lstProfile = dbSOQLObj.getProfileList(profileSet);
                                                 
        
        //beanObj.asetList 'expr0'
        Map<Id,Double> golProfileDebtMap = new Map<Id,Double>();
        Map<Id,Double> golProfileGoldMap = new Map<Id,Double>();
        Map<Id,Double> golProfileEquityMap = new Map<Id,Double>();
        
        for(goal_Profile__c prObj: lstProfile){
            golProfileDebtMap.put(prObj.Id, prObj.debt_Allocation__c);
            golProfileGoldMap.put(prObj.Id, prObj.Gold_allocation__c);
            golProfileEquityMap.put(prObj.Id, prObj.Equity_Allocation__c);
            
        }
        /** Eternus Solutions       **/
    /** Author  : Manasi Ranade **/
    /** Issue Id: 00001470       **/
    /** Date    : 1/2/2012    **/
    /** Purpose : Code to find out the Equity,Debt,Gold percentages
    /****************************************************/
        Datetime cDT = System.now();
        Integer currentYear = Integer.valueOf(cDT.format('yyyy'));
       
        List<Id> golIds = new List<Id>();
        for(Goal__c golObj: beanObj.goalList){
            golIds.add(golObj.Id);
        }
        /** Eternus Solutions       **/
    /** Author  : Manasi Ranade **/
    /** Issue Id: 00001470       **/
    /** Date    : 1/2/2012    **/
    /** Purpose : Code to find out the Equity,Debt,Gold percentages
    /****************************************************/
        Map<Id, double> debtValMap = new  Map<Id, double>();
        Map<Id, double> equityValMap = new  Map<Id, double>();
        Map<Id, double> goldValMap = new  Map<Id, double>();
        Map<Id, double> totValMap = new  Map<Id, double>();
        double dblTotalPerc = 0,dblDebtPerc = 0,dblEquityPerc = 0,dblGoldPerc = 0;
        //List<GoalSIPAmount__c> goalSips = dbSOQLObj.getGoalSIP(currentYear, golIds);
        List<GoalSIPAmount__c> goalSips = [select  Goal__c,Goal__r.SIP_Start_Year__c, Goal_Year__c, SIP_Debt__c, SIP_Equity__c, SIP_Gold__c, SIP_Total__c,
                          GoldCurrentYear__c,EquityCurrentYear__c,DebtCurrentYear__c
                                from GoalSIPAmount__c 
                                where SIP_Outflow__c = true 
                                AND
                                Goal__c In: golIds];
        
        Double dblTotalSIP = 0; 
        double tempDebt = 0,tempEquity = 0,tempGold = 0;
        for(GoalSIPAmount__c sipObj: goalSips)
        {
        	system.debug('******sipObj.Goal__r.SIP_Start_Year__c******'+sipObj.Goal__r.SIP_Start_Year__c);
	          	system.debug('******sipObj.Goal_Year__c******'+sipObj.Goal_Year__c);
	        if(sipObj.Goal__r.SIP_Start_Year__c != null)  	
	        {
	        	if(Decimal.valueOf(sipObj.Goal__r.SIP_Start_Year__c) == sipObj.Goal_Year__c)
	        	{
		          	tempEquity = (sipObj.EquityCurrentYear__c == null ? 0 : sipObj.EquityCurrentYear__c);
		          	tempDebt = (sipObj.DebtCurrentYear__c == null ? 0 : sipObj.DebtCurrentYear__c);
		          	tempGold = (sipObj.GoldCurrentYear__c == null ? 0 : sipObj.GoldCurrentYear__c);
		          
		          	system.debug('******tempEquity******'+tempEquity);
		          	system.debug('******tempDebt******'+tempDebt);
		          	system.debug('******tempGold******'+tempGold);
		          	dblTotalSIP = tempEquity + tempDebt + tempGold;
		          	if(dblTotalSIP > 0)
	          		{
	        			dblDebtPerc = sipObj.DebtCurrentYear__c / dblTotalSIP * 100;
	        			dblEquityPerc = sipObj.EquityCurrentYear__c / dblTotalSIP * 100;
	        			dblGoldPerc = sipObj.GoldCurrentYear__c / dblTotalSIP * 100;
	          		}
	          		else
	      			{
	        			dblDebtPerc = 0;
	        			dblEquityPerc = 0;
	        			dblGoldPerc = 0;
	      			}
	            	debtValMap.put(sipObj.Goal__c, dblDebtPerc);
	            	equityValMap.put(sipObj.Goal__c, dblEquityPerc); 
	            	goldValMap.put(sipObj.Goal__c, dblGoldPerc);
	           	 	system.debug('******dblEquityPerc******'+tempEquity);
	          		system.debug('******dblDebtPerc******'+tempDebt);
	          		system.debug('******dblGoldPerc******'+tempGold);
	        	}
	        }
            
        }
        
        List<double> debtVals = prepareProfileWiseData(beanObj.goalList,golProfileMap,golProfileDebtMap, golAmountMap,debtValMap);
        List<double> equityVals = prepareProfileWiseData(beanObj.goalList,golProfileMap,golProfileEquityMap, golAmountMap,equityValMap);
        List<double> goldVals = prepareProfileWiseData(beanObj.goalList,golProfileMap,golProfileGoldMap, golAmountMap,goldValMap);
        
        ApprovedPlanBean.DoneClass asetDebt = new ApprovedPlanBean.DoneClass('Debt', debtVals);
        ApprovedPlanBean.DoneClass asetEquity = new ApprovedPlanBean.DoneClass('Equity', equityVals);
        ApprovedPlanBean.DoneClass asetGold = new ApprovedPlanBean.DoneClass('Gold', goldVals);
        beanObj.suggestedLumpSum.add(asetDebt);
        beanObj.suggestedLumpSum.add(asetEquity);
        beanObj.suggestedLumpSum.add(asetGold);   
        prepareSIPData(beanObj,goalSips);
    }
    
     /** Eternus Solutions       **/
   /** Author  : Manasi Ranade **/
   /** Issue Id: 00001470       **/
   /** Date    : 1/2/2012    **/
   /** Purpose : Code to find out the Equity,Debt,Gold percentages
   /****************************************************/
     private List<double> prepareProfileWiseData(List<Goal__c> goalListP, Map<Id, Id>golProfileMapP, Map<Id, double>golProfileClassMapP
                             , Map<Id, double>golAmountMapP, Map<Id, double> percentageAllocationMap)
     {
                               
       system.debug('******goalListP********'+goalListP);
       system.debug('******golProfileMapP********'+golProfileMapP);
       system.debug('******golProfileClassMapP********'+golProfileClassMapP);
       system.debug('******golAmountMapP********'+golAmountMapP);
       system.debug('******percentageAllocationMap********'+percentageAllocationMap);
                                                                                                                               
        //Original Code
        /*List<double> classVals = new List<double>();
        for(Goal__c golObj: goalListP){
            Id goalId = golObj.Id;
            double sumMF = golAmountMapP.get(goalId);
            
            double Perc = 0;
            double amount = 0;
            
            if(golProfileMapP.get(goalId)!=null && golProfileClassMapP.get(golProfileMapP.get(goalId))!=null){
                Perc = golProfileClassMapP.get(golProfileMapP.get(goalId));
                if(sumMF !=null && sumMF!=0){
                    amount = (sumMF * Perc)/100;
                }
            }
            classVals.add(amount);
            
         }
         return classVals;*/
         List<double> classVals = new List<double>();
         for(Goal__c golObj: goalListP)
         {
            Id goalId = golObj.Id;
            double sumMF = golAmountMapP.get(goalId);
            
            double Perc = 0;
            double amount = 0;
            
            if(percentageAllocationMap != null & percentageAllocationMap.get(goalId) != null)
            {
                Perc = percentageAllocationMap.get(goalId);
                if(sumMF !=null && sumMF!=0)
                {
                    amount = (sumMF * Perc)/100;
                }
            }
            classVals.add(amount);
            
         }
         return classVals;
         
    }
    
    public void prepareSIPData(ApprovedPlanBean beanObj,List<GoalSIPAmount__c> goalSips)
    {
        Datetime cDT = System.now();
        Integer currentYear = Integer.valueOf(cDT.format('yyyy'));
       
        List<Id> golIds = new List<Id>();
        for(Goal__c golObj: beanObj.goalList)
        {
            golIds.add(golObj.Id);
        }
        Map<Id, double> debtValMap = new  Map<Id, double>();
        Map<Id, double> equityValMap = new  Map<Id, double>();
        Map<Id, double> goldValMap = new  Map<Id, double>();
        
        //List<GoalSIPAmount__c> goalSips = dbSOQLObj.getGoalSIP(currentYear, golIds);
        /*List<GoalSIPAmount__c> goalSips = [select  Goal__c,Goal__r.SIP_Start_Year__c, Goal_Year__c, SIP_Debt__c, SIP_Equity__c, SIP_Gold__c, SIP_Total__c,
                          GoldCurrentYear__c,EquityCurrentYear__c,DebtCurrentYear__c
                                from GoalSIPAmount__c 
                                where SIP_Outflow__c = true 
                                AND
                                Goal__c In: golIds];*/
        
        for(GoalSIPAmount__c sipObj: goalSips)
        {
        	system.debug('******sipObj.Goal__r.SIP_Start_Year__c******'+sipObj.Goal__r.SIP_Start_Year__c);
          	system.debug('******sipObj.Goal_Year__c******'+sipObj.Goal_Year__c);
          	if(sipObj.Goal__r.SIP_Start_Year__c != null)
          	{
        		if(Decimal.valueOf(sipObj.Goal__r.SIP_Start_Year__c) == sipObj.Goal_Year__c)
        		{
	            	debtValMap.put(sipObj.Goal__c, sipObj.SIP_Debt__c);
	            	equityValMap.put(sipObj.Goal__c, sipObj.SIP_Equity__c); 
	            	goldValMap.put(sipObj.Goal__c, sipObj.SIP_Gold__c);
        		}
          	}
        }
        List<double> debtVal = new List<double>();
        List<double> equityVal = new List<double>();
        List<double> goldVal = new List<double>();
        
        for(Goal__c golObj: beanObj.goalList)
        {
            if(debtValMap.get(golObj.Id)!=null){
                debtVal.add(debtValMap.get(golObj.Id));
            }else{
                debtVal.add(0);
            }
            if(equityValMap.get(golObj.Id)!=null){
                equityVal.add(equityValMap.get(golObj.Id));
            }else{
                equityVal.add(0);
            }
            if(goldValMap.get(golObj.Id)!=null)
            {
                goldVal.add(goldValMap.get(golObj.Id));
            }else{
                goldVal.add(0);
            }
        } 
        
        ApprovedPlanBean.DoneClass debtObj = new  ApprovedPlanBean.DoneClass('Debt', debtVal);
        beanObj.SuggestedSIP.add(debtObj);
        ApprovedPlanBean.DoneClass equityObj = new  ApprovedPlanBean.DoneClass('Equity', equityVal);
        beanObj.SuggestedSIP.add(equityObj);
        ApprovedPlanBean.DoneClass goldObj = new  ApprovedPlanBean.DoneClass('Gold', goldVal);
        beanObj.SuggestedSIP.add(goldObj);
    }
     
}